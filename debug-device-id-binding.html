<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡IDç»‘å®šè§¦å‘è°ƒè¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .debug-section { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .log-output { 
            background: #1e1e1e; 
            color: #d4d4d4; 
            padding: 15px; 
            border-radius: 5px; 
            max-height: 400px; 
            overflow-y: auto; 
            font-family: 'Consolas', monospace; 
            font-size: 14px; 
            white-space: pre-wrap; 
        }
        .test-controls { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            margin: 15px 0; 
        }
        input[type="text"] { 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 14px; 
            min-width: 150px; 
        }
        button { 
            background: #007acc; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
        }
        button:hover { background: #005a9e; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ”§ è®¾å¤‡IDç»‘å®šè§¦å‘è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h3>é—®é¢˜æè¿°</h3>
        <p>ç”¨æˆ·åé¦ˆï¼šä¿®æ”¹åŸºç¡€é…ç½®ä¸­çš„è®¾å¤‡IDæ—¶ï¼Œå·²é…ç½®äº†HTTPå±æ€§ç»‘å®šçš„æ•°æ®æºæ²¡æœ‰è§¦å‘æ–°è¯·æ±‚ã€‚</p>
        <p><strong>é¢„æœŸè¡Œä¸º</strong>ï¼šè®¾å¤‡IDæ”¹å˜ â†’ InteractionManageræ£€æµ‹ç»‘å®šå…³ç³» â†’ æ›´æ–°æ•°æ®æºé…ç½® â†’ è§¦å‘HTTPè¯·æ±‚</p>
    </div>

    <div class="debug-section">
        <h3>ğŸ” è°ƒè¯•æ­¥éª¤</h3>
        <div class="test-controls">
            <label>ç»„ä»¶IDï¼š</label>
            <input type="text" id="componentId" value="triple-data-display_1757302119453" />
            <label>æ–°è®¾å¤‡IDï¼š</label>
            <input type="text" id="newDeviceId" value="44" />
            <button onclick="simulateDeviceIdChange()">æ¨¡æ‹Ÿè®¾å¤‡IDå˜æ›´</button>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <div class="debug-section">
        <h3>ğŸ“‹ å…³é”®æ£€æŸ¥ç‚¹</h3>
        <div id="checkpoints">
            <div>âœ… GridstackRenderer æ¥æ”¶é…ç½®å˜æ›´äº‹ä»¶</div>
            <div>ğŸ”„ InteractionManager.notifyPropertyUpdate è¢«è°ƒç”¨</div>
            <div>ğŸ”„ triggerDataSourceConfigUpdateForPropertyChange æ‰§è¡Œ</div>
            <div>ğŸ”„ isBaseConfigurationProperty è¯†åˆ« base.deviceId</div>
            <div>ğŸ”„ buildPropertyBindingPath æ„å»ºæ­£ç¡®è·¯å¾„</div>
            <div>ğŸ”„ configContainsPropertyBinding æ‰¾åˆ°ç»‘å®šå…³ç³»</div>
            <div>ğŸ”„ updateCurrentComponentDataSourceForBaseConfig æ›´æ–°é…ç½®</div>
            <div>ğŸ”„ HTTPè¯·æ±‚è§¦å‘</div>
        </div>
    </div>

    <div class="debug-section">
        <h3>ğŸ” å®æ—¶è°ƒè¯•æ—¥å¿—</h3>
        <div id="logOutput" class="log-output">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
    </div>

    <div class="debug-section">
        <h3>ğŸš¨ å·²çŸ¥é—®é¢˜åˆ†æ</h3>
        <p><strong class="error">æ ¸å¿ƒé—®é¢˜</strong>ï¼šä»ç”¨æˆ·å¯¼å‡ºçš„é…ç½®æ–‡ä»¶çœ‹ï¼ŒHTTPå‚æ•°é…ç½®åŒ…å«ï¼š</p>
        <pre>
"selectedTemplate": "component-property-binding"
"value": ""                    â† ç»‘å®šå€¼ä¸ºç©ºï¼
"variableName": ""            â† å˜é‡åä¸ºç©ºï¼
        </pre>
        <p><strong class="warning">ç–‘ä¼¼åŸå› </strong>ï¼šå±æ€§ç»‘å®šä¿¡æ¯æ²¡æœ‰æ­£ç¡®ä¿å­˜åˆ°HTTPå‚æ•°é…ç½®ä¸­ï¼Œæˆ–åœ¨å¯¼å‡ºæ—¶ä¸¢å¤±ã€‚</p>
    </div>

    <script>
        let logCount = 0;
        
        function appendLog(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'ğŸ“';
            logOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            logCount++;
        }
        
        function clearLogs() {
            document.getElementById('logOutput').textContent = 'ç­‰å¾…æ—¥å¿—è¾“å‡º...\n';
            logCount = 0;
        }
        
        function simulateDeviceIdChange() {
            const componentId = document.getElementById('componentId').value;
            const newDeviceId = document.getElementById('newDeviceId').value;
            
            appendLog(`å¼€å§‹æ¨¡æ‹Ÿè®¾å¤‡IDå˜æ›´: ${componentId} -> deviceId: ${newDeviceId}`);
            
            // æ¨¡æ‹ŸGridstackRendererçš„é…ç½®å˜æ›´äº‹ä»¶
            const configChangeEvent = {
                componentId: componentId,
                componentType: 'widget',
                section: 'base',
                oldConfig: { deviceId: '4' },
                newConfig: { deviceId: newDeviceId, metricsList: [] }
            };
            
            appendLog(`GridstackRenderer æ”¶åˆ°é…ç½®å˜æ›´: ${JSON.stringify(configChangeEvent)}`);
            
            // æ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦æœ‰InteractionManagerçš„å®ä¾‹
            if (typeof interactionManager !== 'undefined') {
                appendLog('å‘ç° InteractionManager å®ä¾‹ï¼Œè°ƒç”¨ notifyPropertyUpdate...', 'success');
                try {
                    interactionManager.notifyPropertyUpdate(componentId, 'base.deviceId', newDeviceId, '4');
                    appendLog('InteractionManager.notifyPropertyUpdate è°ƒç”¨æˆåŠŸ', 'success');
                } catch (error) {
                    appendLog(`InteractionManager.notifyPropertyUpdate è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                appendLog('æœªæ‰¾åˆ° InteractionManager å®ä¾‹ - è¯·ç¡®ä¿åœ¨Visual Editoré¡µé¢ä¸­æ‰“å¼€æ­¤è°ƒè¯•å·¥å…·', 'warning');
            }
            
            // æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
            appendLog('è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ä»¥è·å–è¯¦ç»†çš„InteractionManagerè°ƒè¯•æ—¥å¿—', 'warning');
        }
        
        // ç›‘å¬æ§åˆ¶å°æ—¥å¿—ï¼ˆå¦‚æœå¯èƒ½ï¼‰
        const originalLog = console.log;
        console.log = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('InteractionManager')) {
                appendLog(`Console: ${args.join(' ')}`);
            }
            return originalLog.apply(console, arguments);
        };
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹æ£€æŸ¥
        window.addEventListener('load', function() {
            appendLog('è°ƒè¯•å·¥å…·å·²åŠ è½½');
            
            if (window.location.href.includes('localhost:5002')) {
                appendLog('æ£€æµ‹åˆ°å¼€å‘æœåŠ¡å™¨ç¯å¢ƒ', 'success');
            } else {
                appendLog('è¯·åœ¨å¼€å‘æœåŠ¡å™¨(localhost:5002)ä¸­æ‰“å¼€æ­¤å·¥å…·', 'warning');
            }
            
            // æ£€æŸ¥å…³é”®å¯¹è±¡æ˜¯å¦å­˜åœ¨
            setTimeout(() => {
                if (typeof interactionManager !== 'undefined') {
                    appendLog('âœ… InteractionManager å¯ç”¨', 'success');
                } else {
                    appendLog('âŒ InteractionManager ä¸å¯ç”¨', 'error');
                }
                
                if (typeof configEventBus !== 'undefined') {
                    appendLog('âœ… ConfigEventBus å¯ç”¨', 'success');
                } else {
                    appendLog('âŒ ConfigEventBus ä¸å¯ç”¨', 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>