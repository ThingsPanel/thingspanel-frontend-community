<!-- äº¤äº’ç³»ç»Ÿæµ‹è¯•é¡µé¢ -->
<template>
  <div class="interaction-test-page">
    <n-space vertical size="large">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <n-card>
        <template #header>
          <h2>äº¤äº’ç³»ç»ŸåŠŸèƒ½æµ‹è¯•</h2>
        </template>
        <n-text>æµ‹è¯•æç®€ç‰ˆ2ä¸ªæ ¸å¿ƒåŠ¨ä½œäº¤äº’ç³»ç»Ÿï¼šURLè·³è½¬ã€ç»„ä»¶å±æ€§ä¿®æ”¹</n-text>
      </n-card>

      <!-- åœºæ™¯1: ç‚¹å‡»å¡ç‰‡è·³è½¬URL -->
      <n-card>
        <template #header>
          <n-space justify="space-between">
            <span>åœºæ™¯1: ç‚¹å‡»å¡ç‰‡è·³è½¬URL</span>
            <n-button size="small" @click="configureScenario1">é…ç½®äº¤äº’</n-button>
          </n-space>
        </template>

        <div class="test-scenario">
          <div ref="scenario1Card" class="test-card clickable-card" @click="triggerScenario1Click">
            <div class="card-content">
              <n-icon size="24" color="#18a058">
                <LinkOutline />
              </n-icon>
              <div>ç‚¹å‡»æˆ‘è·³è½¬åˆ°ç™¾åº¦</div>
            </div>
          </div>

          <div class="scenario-info">
            <p><strong>é…ç½®è¯´æ˜ï¼š</strong></p>
            <ul>
              <li>äº‹ä»¶ç±»å‹ï¼šç‚¹å‡» (click)</li>
              <li>åŠ¨ä½œç±»å‹ï¼šè·³è½¬åˆ°URL (navigateToUrl)</li>
              <li>ç›®æ ‡åœ°å€ï¼šhttps://www.baidu.com</li>
              <li>æ‰“å¼€æ–¹å¼ï¼šæ–°æ ‡ç­¾é¡µ (_blank)</li>
            </ul>
          </div>
        </div>
      </n-card>

      <!-- åœºæ™¯2: æŒ‰é’®ç‚¹å‡»æ”¹å˜å¦ä¸€ä¸ªå¡ç‰‡æ•°æ® -->
      <n-card>
        <template #header>
          <n-space justify="space-between">
            <span>åœºæ™¯2: è·¨ç»„ä»¶æ•°æ®ä¿®æ”¹</span>
            <n-button size="small" @click="configureScenario2">é…ç½®äº¤äº’</n-button>
          </n-space>
        </template>

        <div class="test-scenario">
          <n-space size="large">
            <!-- è§¦å‘ç»„ä»¶ -->
            <div ref="scenario2Trigger" class="test-card trigger-card">
              <div class="card-content">
                <n-button type="primary" @click="triggerScenario2Click">ç‚¹å‡»ä¿®æ”¹å³ä¾§å¡ç‰‡</n-button>
              </div>
            </div>

            <!-- ç›®æ ‡ç»„ä»¶ -->
            <div ref="scenario2Target" class="test-card target-card" :style="{ backgroundColor: scenario2TargetBg }">
              <div class="card-content">
                <div>ç›®æ ‡å¡ç‰‡</div>
                <div>æ•°æ®å€¼: {{ scenario2TargetData }}</div>
              </div>
            </div>
          </n-space>

          <div class="scenario-info">
            <p><strong>é…ç½®è¯´æ˜ï¼š</strong></p>
            <ul>
              <li>è§¦å‘ç»„ä»¶ï¼šå·¦ä¾§æŒ‰é’®</li>
              <li>äº‹ä»¶ç±»å‹ï¼šç‚¹å‡» (click)</li>
              <li>åŠ¨ä½œç±»å‹ï¼šä¿®æ”¹ç»„ä»¶æ•°æ® (updateComponentData)</li>
              <li>ç›®æ ‡ç»„ä»¶ï¼šå³ä¾§å¡ç‰‡</li>
              <li>ä¿®æ”¹å†…å®¹ï¼šèƒŒæ™¯é¢œè‰² + æ•°æ®å€¼</li>
            </ul>
          </div>
        </div>
      </n-card>

      <!-- åœºæ™¯3: æ¡ä»¶è§¦å‘é—ªçƒæ•ˆæœ -->
      <n-card>
        <template #header>
          <n-space justify="space-between">
            <span>åœºæ™¯3: æ¡ä»¶è§¦å‘é—ªçƒæ•ˆæœ</span>
            <n-button size="small" @click="configureScenario3">é…ç½®äº¤äº’</n-button>
          </n-space>
        </template>

        <div class="test-scenario">
          <n-space size="large" align="center">
            <!-- æ•°å€¼æ§åˆ¶ -->
            <div class="test-card">
              <div class="card-content">
                <div>å½“å‰æ•°å€¼</div>
                <n-input-number
                  v-model:value="scenario3Value"
                  :min="0"
                  :max="150"
                  @update:value="onScenario3ValueChange"
                />
                <n-space size="small" style="margin-top: 8px">
                  <n-button size="small" @click="setScenario3Value(99)">è®¾ä¸º99</n-button>
                  <n-button size="small" @click="setScenario3Value(20)">è®¾ä¸º20</n-button>
                  <n-button size="small" @click="setScenario3Value(50)">è®¾ä¸º50</n-button>
                </n-space>
              </div>
            </div>

            <!-- æŠ¥è­¦å¡ç‰‡ -->
            <div ref="scenario3Alert" class="test-card alert-card" :style="{ backgroundColor: scenario3AlertBg }">
              <div class="card-content">
                <n-icon size="24" color="#d03050">
                  <WarningOutline />
                </n-icon>
                <div>æŠ¥è­¦æŒ‡ç¤ºå™¨</div>
                <div class="alert-status">{{ scenario3AlertStatus }}</div>
              </div>
            </div>
          </n-space>

          <div class="scenario-info">
            <p><strong>é…ç½®è¯´æ˜ï¼š</strong></p>
            <ul>
              <li>ç›‘å¬ç»„ä»¶ï¼šæ•°å€¼è¾“å…¥æ¡†</li>
              <li>äº‹ä»¶ç±»å‹ï¼šæ•°æ®å˜åŒ– (dataChange)</li>
              <li>æ¡ä»¶1ï¼šæ•°å€¼ >= 99 â†’ èƒŒæ™¯è‰²å˜çº¢</li>
              <li>æ¡ä»¶2ï¼šæ•°å€¼ <= 20 â†’ èƒŒæ™¯è‰²å˜è“</li>
              <li>åŠ¨ä½œç±»å‹ï¼šå±æ€§ä¿®æ”¹</li>
            </ul>
          </div>
        </div>
      </n-card>

      <!-- åœºæ™¯4: ç»„ä»¶è‡ªæˆ‘é…ç½® -->
      <n-card>
        <template #header>
          <n-space justify="space-between">
            <span>åœºæ™¯4: ç»„ä»¶è‡ªæˆ‘é…ç½®</span>
            <n-button size="small" @click="configureScenario4">é…ç½®äº¤äº’</n-button>
          </n-space>
        </template>

        <div class="test-scenario">
          <div
            ref="scenario4Card"
            class="test-card self-config-card"
            :style="{
              backgroundColor: scenario4Bg,
              transform: scenario4Transform,
              opacity: scenario4Opacity
            }"
            @mouseenter="triggerScenario4Hover"
            @mouseleave="triggerScenario4Leave"
            @click="triggerScenario4Click"
          >
            <div class="card-content">
              <n-icon size="24">
                <SettingsOutline />
              </n-icon>
              <div>æ‚¬åœå’Œç‚¹å‡»æˆ‘</div>
              <div class="interaction-hint">{{ scenario4Hint }}</div>
            </div>
          </div>

          <div class="scenario-info">
            <p><strong>é…ç½®è¯´æ˜ï¼š</strong></p>
            <ul>
              <li>ç›®æ ‡ç»„ä»¶ï¼šè‡ªèº«</li>
              <li>æ‚¬åœè¿›å…¥ï¼šèƒŒæ™¯è‰²å˜ç»¿</li>
              <li>æ‚¬åœç¦»å¼€ï¼šæ¢å¤åŸçŠ¶</li>
              <li>ç‚¹å‡»ï¼šé€æ˜åº¦å˜åŒ–</li>
            </ul>
          </div>
        </div>
      </n-card>

      <!-- äº¤äº’é…ç½®é¢æ¿ -->
      <n-modal v-model:show="showConfigPanel" :title="currentConfigTitle" style="width: 800px">
        <n-card :bordered="false">
          <InteractionSettingsForm
            :component-id="currentComponentId"
            :model-value="currentInteractionConfigs"
            @update:model-value="onInteractionConfigChange"
            @validate="onInteractionValidate"
          />
        </n-card>
      </n-modal>

      <!-- æµ‹è¯•ç»“æœå±•ç¤º -->
      <n-card>
        <template #header>
          <span>æµ‹è¯•ç»“æœ</span>
        </template>
        <n-space vertical>
          <div v-for="(result, index) in testResults" :key="index" class="test-result">
            <n-tag :type="result.success ? 'success' : 'error'">
              {{ result.scenario }}
            </n-tag>
            <span>{{ result.message }}</span>
          </div>
        </n-space>
      </n-card>
    </n-space>
  </div>
</template>

<script setup lang="ts">
/**
 * äº¤äº’ç³»ç»Ÿæµ‹è¯•é¡µé¢
 * ç”¨äºéªŒè¯å››ä¸ªæ ¸å¿ƒäº¤äº’åœºæ™¯çš„å®ç°
 */

import { ref, onMounted } from 'vue'
import { NCard, NSpace, NButton, NIcon, NText, NInputNumber, NModal, NTag, useMessage } from 'naive-ui'
import { LinkOutline, WarningOutline, SettingsOutline } from '@vicons/ionicons5'

// å¯¼å…¥äº¤äº’ç³»ç»Ÿ
import type { InteractionConfig } from '@/card2.1/core/interaction-types'
import { interactionManager } from '@/card2.1/core/interaction-manager'
import InteractionSettingsForm from '@/core/interaction-system/components/InteractionSettingsForm.vue'

const message = useMessage()

// é…ç½®é¢æ¿çŠ¶æ€
const showConfigPanel = ref(false)
const currentConfigTitle = ref('')
const currentComponentId = ref('')
const currentInteractionConfigs = ref<InteractionConfig[]>([])

// åœºæ™¯1çŠ¶æ€
const scenario1Card = ref<HTMLElement>()

// åœºæ™¯2çŠ¶æ€
const scenario2Trigger = ref<HTMLElement>()
const scenario2Target = ref<HTMLElement>()
const scenario2TargetBg = ref('#f0f0f0')
const scenario2TargetData = ref(0)

// åœºæ™¯3çŠ¶æ€
const scenario3Value = ref(50)
const scenario3Alert = ref<HTMLElement>()
const scenario3AlertBg = ref('#f0f0f0')
const scenario3AlertStatus = ref('æ­£å¸¸')

// åœºæ™¯4çŠ¶æ€
const scenario4Card = ref<HTMLElement>()
const scenario4Bg = ref('#f0f0f0')
const scenario4Transform = ref('scale(1)')
const scenario4Opacity = ref(1)
const scenario4Hint = ref('ç­‰å¾…äº¤äº’...')

// æµ‹è¯•ç»“æœ
const testResults = ref<
  Array<{
    scenario: string
    success: boolean
    message: string
  }>
>([])

// åœºæ™¯1: é…ç½®URLè·³è½¬
const configureScenario1 = () => {
  currentComponentId.value = 'scenario1-card'
  currentConfigTitle.value = 'åœºæ™¯1: ç‚¹å‡»è·³è½¬URLé…ç½®'
  currentInteractionConfigs.value = [
    {
      event: 'click',
      responses: [
        {
          action: 'navigateToUrl',
          value: 'https://www.baidu.com',
          target: '_blank'
        }
      ],
      enabled: true,
      priority: 1,
      name: 'ç‚¹å‡»è·³è½¬ç™¾åº¦'
    }
  ]
  showConfigPanel.value = true
}

const triggerScenario1Click = () => {
  const results = interactionManager.triggerEvent('scenario1-card', 'click')
  addTestResult(
    'åœºæ™¯1 - URLè·³è½¬',
    results.length > 0 && results[0].success,
    results[0]?.success ? 'æˆåŠŸæ‰“å¼€æ–°æ ‡ç­¾é¡µ' : results[0]?.error || 'æ‰§è¡Œå¤±è´¥'
  )
}

// åœºæ™¯2: é…ç½®è·¨ç»„ä»¶æ•°æ®ä¿®æ”¹
const configureScenario2 = () => {
  currentComponentId.value = 'scenario2-trigger'
  currentConfigTitle.value = 'åœºæ™¯2: è·¨ç»„ä»¶æ•°æ®ä¿®æ”¹é…ç½®'
  currentInteractionConfigs.value = [
    {
      event: 'click',
      responses: [
        {
          action: 'updateComponentData',
          targetComponentId: 'scenario2-target',
          targetProperty: 'backgroundColor',
          updateValue: '#18a058'
        }
      ],
      enabled: true,
      priority: 1,
      name: 'ä¿®æ”¹ç›®æ ‡å¡ç‰‡æ•°æ®'
    }
  ]
  showConfigPanel.value = true
}

const triggerScenario2Click = () => {
  scenario2TargetData.value++
  scenario2TargetBg.value = `hsl(${Math.random() * 360}, 70%, 85%)`

  const results = interactionManager.triggerEvent('scenario2-trigger', 'click')
  addTestResult('åœºæ™¯2 - è·¨ç»„ä»¶æ•°æ®ä¿®æ”¹', results.length > 0, `æˆåŠŸä¿®æ”¹ç›®æ ‡ç»„ä»¶ï¼Œæ•°æ®å€¼: ${scenario2TargetData.value}`)
}

// åœºæ™¯3: é…ç½®æ¡ä»¶è§¦å‘
const configureScenario3 = () => {
  currentComponentId.value = 'scenario3-monitor'
  currentConfigTitle.value = 'åœºæ™¯3: æ¡ä»¶è§¦å‘é…ç½®'
  currentInteractionConfigs.value = [
    {
      event: 'dataChange',
      responses: [
        {
          action: 'updateComponentData',
          targetComponentId: 'scenario3-alert',
          targetProperty: 'backgroundColor',
          updateValue: '#d03050'
        }
      ],
      enabled: true,
      priority: 1,
      name: 'é«˜å€¼æŠ¥è­¦',
      condition: {
        operator: 'greaterThanOrEqual',
        value: 99
      }
    },
    {
      event: 'dataChange',
      responses: [
        {
          action: 'updateComponentData',
          targetComponentId: 'scenario3-alert',
          targetProperty: 'backgroundColor',
          updateValue: '#2080f0'
        }
      ],
      enabled: true,
      priority: 1,
      name: 'ä½å€¼æŠ¥è­¦',
      condition: {
        operator: 'lessThanOrEqual',
        value: 20
      }
    }
  ]
  showConfigPanel.value = true
}

const setScenario3Value = (value: number) => {
  scenario3Value.value = value
  onScenario3ValueChange(value)
}

const onScenario3ValueChange = (value: number | null) => {
  if (value === null) return

  // æ£€æŸ¥æ¡ä»¶å¹¶è§¦å‘ç›¸åº”åŠ¨ä½œ
  if (value >= 99) {
    scenario3AlertStatus.value = 'é«˜å€¼æŠ¥è­¦!'
    scenario3AlertBg.value = '#d03050'
    // æ¨¡æ‹Ÿé—ªçƒæ•ˆæœ
    flashColor(scenario3Alert.value!, '#d03050', 3)
    // ğŸ”¥ ä½¿ç”¨ç®€åŒ–åçš„æ•°æ®å˜åŒ–äº‹ä»¶
    const results = interactionManager.triggerEvent('scenario3-monitor', 'dataChange', {
      property: 'value',
      oldValue: null,
      newValue: value
    })
    addTestResult('åœºæ™¯3 - é«˜å€¼æ¡ä»¶è§¦å‘', results.length > 0, `æ•°å€¼${value}>=99ï¼Œè§¦å‘èƒŒæ™¯è‰²å˜åŒ–`)
  } else if (value <= 20) {
    scenario3AlertStatus.value = 'ä½å€¼æŠ¥è­¦!'
    scenario3AlertBg.value = '#2080f0'
    // æ¨¡æ‹Ÿé—ªçƒæ•ˆæœ
    flashColor(scenario3Alert.value!, '#2080f0', 3)
    // ğŸ”¥ ä½¿ç”¨ç®€åŒ–åçš„æ•°æ®å˜åŒ–äº‹ä»¶
    const results = interactionManager.triggerEvent('scenario3-monitor', 'dataChange', {
      property: 'value',
      oldValue: null,
      newValue: value
    })
    addTestResult('åœºæ™¯3 - ä½å€¼æ¡ä»¶è§¦å‘', results.length > 0, `æ•°å€¼${value}<=20ï¼Œè§¦å‘èƒŒæ™¯è‰²å˜åŒ–`)
  } else {
    scenario3AlertStatus.value = 'æ­£å¸¸'
    scenario3AlertBg.value = '#f0f0f0'
  }
}

// åœºæ™¯4: é…ç½®è‡ªæˆ‘äº¤äº’
const configureScenario4 = () => {
  currentComponentId.value = 'scenario4-card'
  currentConfigTitle.value = 'åœºæ™¯4: ç»„ä»¶è‡ªæˆ‘é…ç½®'
  currentInteractionConfigs.value = [
    {
      event: 'hover',
      responses: [
        {
          action: 'updateComponentData',
          targetProperty: 'backgroundColor',
          updateValue: '#18a058'
        }
      ],
      enabled: true,
      priority: 1,
      name: 'æ‚¬åœæ•ˆæœ'
    },
    {
      event: 'click',
      responses: [
        {
          action: 'updateComponentData',
          targetProperty: 'opacity',
          updateValue: '0.7'
        }
      ],
      enabled: true,
      priority: 1,
      name: 'ç‚¹å‡»æ•ˆæœ'
    }
  ]
  showConfigPanel.value = true
}

const triggerScenario4Hover = () => {
  scenario4Bg.value = '#18a058'
  scenario4Transform.value = 'scale(1.1)'
  scenario4Hint.value = 'æ‚¬åœä¸­...'

  interactionManager.triggerEvent('scenario4-card', 'hover')
  addTestResult('åœºæ™¯4 - æ‚¬åœæ•ˆæœ', true, 'æˆåŠŸæ”¹å˜èƒŒæ™¯è‰²å’Œæ”¾å¤§')
}

const triggerScenario4Leave = () => {
  scenario4Bg.value = '#f0f0f0'
  scenario4Transform.value = 'scale(1)'
  scenario4Hint.value = 'ç­‰å¾…äº¤äº’...'
}

const triggerScenario4Click = () => {
  scenario4Opacity.value = 0.7
  scenario4Transform.value = 'scale(1.1) rotate(360deg)'
  scenario4Hint.value = 'ç‚¹å‡»åŠ¨ç”»ä¸­...'

  setTimeout(() => {
    scenario4Opacity.value = 1
    scenario4Transform.value = 'scale(1)'
    scenario4Hint.value = 'åŠ¨ç”»å®Œæˆ'
  }, 500)

  interactionManager.triggerEvent('scenario4-card', 'click')
  addTestResult('åœºæ™¯4 - ç‚¹å‡»æ•ˆæœ', true, 'æˆåŠŸæ‰§è¡Œé€æ˜åº¦å’Œæ—‹è½¬åŠ¨ç”»')
}

// è¾…åŠ©å‡½æ•°ï¼šé—ªçƒæ•ˆæœ
const flashColor = (element: HTMLElement, color: string, times: number) => {
  const originalBg = element.style.backgroundColor
  let count = 0

  const interval = setInterval(() => {
    element.style.backgroundColor = count % 2 === 0 ? color : originalBg
    count++

    if (count >= times * 2) {
      clearInterval(interval)
      element.style.backgroundColor = originalBg
    }
  }, 200)
}

// æ·»åŠ æµ‹è¯•ç»“æœ
const addTestResult = (scenario: string, success: boolean, message: string) => {
  testResults.value.unshift({
    scenario,
    success,
    message
  })

  // ä¿æŒæœ€å¤š10æ¡è®°å½•
  if (testResults.value.length > 10) {
    testResults.value = testResults.value.slice(0, 10)
  }
}

// äº¤äº’é…ç½®å˜åŒ–å¤„ç†
const onInteractionConfigChange = (configs: InteractionConfig[]) => {
  currentInteractionConfigs.value = configs
  // æ³¨å†Œåˆ°äº¤äº’ç®¡ç†å™¨
  if (currentComponentId.value) {
    interactionManager.updateComponentConfigs(currentComponentId.value, configs)
  }
}

const onInteractionValidate = (result: { valid: boolean; errors: string[] }) => {
  if (!result.valid) {
    message.error(`é…ç½®éªŒè¯å¤±è´¥: ${result.errors.join(', ')}`)
  } else {
    message.success('é…ç½®éªŒè¯é€šè¿‡')
  }
}

// åˆå§‹åŒ–
onMounted(() => {
  // é¢„å…ˆæ³¨å†Œæ‰€æœ‰æµ‹è¯•ç»„ä»¶
  interactionManager.registerComponent('scenario1-card', [])
  interactionManager.registerComponent('scenario2-trigger', [])
  interactionManager.registerComponent('scenario2-target', [])
  interactionManager.registerComponent('scenario3-monitor', [])
  interactionManager.registerComponent('scenario3-alert', [])
  interactionManager.registerComponent('scenario4-card', [])

  // æ·»åŠ åˆå§‹æµ‹è¯•ç»“æœ
  addTestResult('ç³»ç»Ÿåˆå§‹åŒ–', true, 'æ‰€æœ‰æµ‹è¯•ç»„ä»¶å·²æ³¨å†Œåˆ°äº¤äº’ç®¡ç†å™¨')
})
</script>

<style scoped>
.interaction-test-page {
  padding: 16px;
  max-width: 1200px;
  margin: 0 auto;
}

.test-scenario {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.test-card {
  border: 2px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
  background: var(--card-color);
  transition: all 0.3s ease;
  cursor: pointer;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.test-card:hover {
  border-color: var(--primary-color);
  box-shadow: 0 4px 12px rgba(24, 160, 88, 0.2);
}

.clickable-card {
  border-color: #18a058;
  background: linear-gradient(135deg, #f0f9f4, #e6f7ff);
}

.trigger-card {
  border-color: #2080f0;
  background: linear-gradient(135deg, #f0f5ff, #e6f7ff);
}

.target-card {
  border-color: #fa8c16;
  background: linear-gradient(135deg, #fff7e6, #fff2e8);
}

.alert-card {
  border-color: #d03050;
  background: linear-gradient(135deg, #fff0f6, #fff1f0);
}

.self-config-card {
  border-color: #722ed1;
  background: linear-gradient(135deg, #f9f0ff, #f5f5f5);
}

.card-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  text-align: center;
}

.scenario-info {
  background: var(--body-color);
  padding: 12px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
}

.scenario-info ul {
  margin: 8px 0 0 0;
  padding-left: 20px;
}

.scenario-info li {
  margin: 4px 0;
  color: var(--text-color-2);
}

.test-result {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: var(--body-color);
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.interaction-hint {
  font-size: 12px;
  color: var(--text-color-3);
  font-style: italic;
}

.alert-status {
  font-weight: bold;
  font-size: 14px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .test-scenario {
    gap: 12px;
  }

  .test-card {
    min-height: 60px;
    padding: 12px;
  }

  .scenario-info {
    padding: 8px;
  }
}
</style>
