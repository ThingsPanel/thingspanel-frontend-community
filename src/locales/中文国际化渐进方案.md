# ThingsPanel 中文国际化渐进方案

## 🎯 核心思想

**专注中文，英文key，分批处理** - 避免一次性处理过多内容导致的复杂性和错误，从一开始就生成规范的英文语义化key

## 📋 方案特点

- ✅ **只处理中文**: 暂时忽略英文翻译，专注中文文案国际化
- ✅ **英文key命名**: 直接生成语义化英文key，避免中文key的问题
- ✅ **分批处理**: 每次处理少量文件，确保质量和稳定性
- ✅ **智能分类**: 根据文案类型智能分类到合适的命名空间
- ✅ **自动替换**: 脚本自动完成文案替换和导入添加
- ✅ **渐进式**: 可以随时停止，随时继续，不影响项目运行

## 🚀 三步工作流程

### 第一步：智能提取与英文key生成
- 扫描指定的Vue/TS文件
- 提取所有中文文案
- 根据文案内容和上下文智能生成英文语义化key
- 智能分类到合适的命名空间（common/page）
- 生成嵌套结构的JSON映射文件（key为英文，value为中文）

### 第二步：自动替换
- 将中文文案替换为 `$t('key')` 调用
- 处理Vue模板插值：`{{ "中文" }}` → `{{ $t('key') }}`
- 处理JavaScript字符串：`"中文"` → `$t('key')`
- 确保语法正确，引号完整

### 第三步：导入添加
- 检测文件是否需要 `$t` 导入
- 自动添加 `import { $t } from '@/locales'`
- 处理Vue文件的setup函数

## 📁 文件组织

```
src/
├── locales/
│   ├── 中文国际化渐进方案.md     # 本方案文档
│   └── langs/
│       └── zh-CN/
│           ├── common.json      # 通用文案 (嵌套结构)
│           ├── page.json        # 页面文案 (嵌套结构)
│           └── index.ts         # 入口文件
scripts/
├── extract-chinese.mjs         # 提取中文文案脚本
├── replace-chinese.mjs         # 替换文案脚本
├── fix-nested-syntax.mjs       # 修复语法错误脚本
├── fix-nested-t-calls.mjs      # 修复嵌套$t调用脚本
├── fix-all-syntax-errors.mjs   # 一键修复所有语法错误脚本
└── fix-chinese-keys.mjs        # 修复中文key脚本(历史修复用)
```

## 🔧 使用方式

### 完整的处理流程
```bash
# 第一步：提取中文文案并生成英文key
node scripts/extract-chinese.mjs src/views/_builtin/login/

# 第二步：替换中文文案为$t调用
node scripts/replace-chinese.mjs src/views/_builtin/login/

# 第三步：修复可能的语法错误(可选)
node scripts/fix-nested-syntax.mjs src/views/_builtin/login/

# 第四步：修复嵌套$t调用错误(可选)
node scripts/fix-nested-t-calls.mjs src/views/_builtin/login/

# 第五步：验证效果
npm run dev
```

### 批量处理模式
```bash
# 处理指定文件
node scripts/extract-chinese.mjs src/views/home/index.vue src/components/common/header.vue
node scripts/replace-chinese.mjs src/views/home/index.vue src/components/common/header.vue

# 处理整个目录
node scripts/extract-chinese.mjs src/views/user/
node scripts/replace-chinese.mjs src/views/user/
```

### 单文件处理模式
```bash
# 处理单个文件
node scripts/extract-chinese.mjs src/views/_builtin/login/index.vue
node scripts/replace-chinese.mjs src/views/_builtin/login/index.vue
```

## 📊 英文Key生成规则

### 通用文案 (common.json)
```json
{
  "button": {
    "save": "保存",
    "cancel": "取消", 
    "confirm": "确认",
    "reset": "重置",
    "back": "返回",
    "login": "登录"
  },
  "status": {
    "loading": "加载中",
    "success": "成功",
    "error": "错误",
    "online": "在线",
    "offline": "离线"
  },
  "operation": {
    "delete": "删除",
    "edit": "编辑",
    "view": "查看",
    "add": "添加"
  }
}
```

### 页面文案 (page.json)
```json
{
  "login": {
    "title": {
      "pwdLogin": "密码登录",
      "codeLogin": "验证码登录"
    },
    "slogan": "连接万物，智慧生活",
    "form": {
      "enterUsername": "请输入用户名",
      "enterPassword": "请输入密码"
    }
  },
  "general": {
    "deviceTotal": "设备总数",
    "colorTheme": "配色主题",
    "unit": "单位",
    "custom": "自定义"
  }
}
```

### 智能识别与分类规则
- **按钮类**: 确定、取消、保存、删除等 → `common.button.{englishKey}`
- **状态类**: 成功、失败、加载中等 → `common.status.{englishKey}`
- **操作类**: 查看、编辑、删除等 → `common.operation.{englishKey}`
- **表单类**: 请输入、请选择等 → `page.{module}.form.{englishKey}`
- **标题类**: 页面标题、模块名等 → `page.{module}.title.{englishKey}`
- **内容类**: 其他文案 → `page.{module}.{englishKey}`

### 英文Key命名规范
- **驼峰命名**: `deviceTotal`, `colorTheme`, `enterUsername`
- **语义清晰**: 体现文案的具体含义
- **分类合理**: 根据使用场景归类到合适的命名空间
- **避免冲突**: 确保同一命名空间下key的唯一性
- **易于维护**: 便于开发者理解和维护

## ✅ 优势

1. **风险可控**: 每次只处理少量文件，出错影响小
2. **质量保证**: 可以仔细检查每批处理结果
3. **灵活性强**: 可以根据实际情况调整策略
4. **易于维护**: 生成的key语义清晰，便于后续维护
5. **渐进式**: 不影响现有功能，可以逐步完善

## 🎯 执行计划

### ✅ 阶段一：登录模块 (已完成)
- ✅ 登录页面 (`src/views/_builtin/login/`)
- ✅ 登录子模块 (`src/views/_builtin/login/modules/`)
- ✅ 处理文件数：5个
- ✅ 替换文案数：5处

### 阶段二：核心组件 (第2-6批)
- 通用组件 (header, footer, menu等)
- 基础表单组件
- 常用按钮和操作

### 阶段三：主要页面 (第7-16批)
- 用户管理页面
- 设备管理页面
- 数据分析页面

### 阶段四：业务页面 (第17-30批)
- 系统设置页面
- 其他业务页面

### 阶段五：英文翻译 (最后阶段)
- 基于完整的中文key结构
- 批量生成英文翻译
- 完善国际化架构

## 📝 注意事项

- 每次处理前先备份 (`git status` 检查)
- 处理后及时测试功能 (`npm run dev`)
- 发现问题立即停止并修复
- 保持键名的一致性和语义性
- 按照两步流程执行：先提取，后替换

## 🚨 常见问题与解决方案

### Vue语法错误：缺少引号
**问题**: `Unquoted attribute value cannot contain U+0022 (")`
**原因**: 替换脚本生成了 `:placeholder=$t('key')` 而不是 `:placeholder="$t('key')"`
**解决**: 
```bash
node scripts/fix-vue-syntax.mjs src/views/_builtin/login/modules/
```

### 嵌套$t调用错误
**问题**: 替换脚本可能生成嵌套的$t调用
```javascript
// ❌ 错误的嵌套调用
title: $t('page.general.{{ $t('page.general.alarmContent') }}')
message: $t('common.{{ $t('common.status.error') }}')
```
**解决**: 使用专门的修复脚本
```bash
node scripts/fix-nested-t-calls.mjs src/
```
**脚本功能**: 
- 自动检测并修复各种嵌套$t调用模式
- 智能提取最合适的翻译key
- 递归处理多层嵌套问题
- 显示具体修复内容便于检查

### 快速修复所有语法错误
当出现Vue编译错误时，可以运行以下命令批量修复：
```bash
# 方式1：一键修复所有语法错误（推荐）
node scripts/fix-all-syntax-errors.mjs src/

# 方式2：分步修复
node scripts/fix-nested-syntax.mjs src/
node scripts/fix-nested-t-calls.mjs src/

# 验证修复效果
npm run dev
```

**一键修复脚本功能**：
- 修复未加引号的属性值：`:title=$t('key')` → `:title="$t('key')"`
- 修复嵌套Vue模板语法：`"{{ $t('key') }}"` → `$t('key')`
- 修复字符串中的$t调用：`"page.general.key"` → `$t('page.general.key')`
- 修复嵌套$t调用：`$t('prefix{{ $t('key') }}')` → `$t('key')`
- 修复三元表达式中的错误语法

### 中文Key问题（已解决）
**问题**: 之前版本可能生成中文key如 `"配色主题1"`
**解决**: 新版本直接生成英文key如 `"colorTheme1"`，避免后期修复
**工具**: `scripts/fix-chinese-keys.mjs` （仅用于历史修复）

### JavaScript中误用Vue模板语法
**问题**: 在JavaScript代码中使用了Vue模板语法
```javascript
// ❌ 错误写法 - 在JS中使用Vue模板语法
const deviceName = computed(() => props.card?.name || '{{ $t("page.general.device") }}')

// ❌ 错误写法 - 字符串包含了脚本调用
const buttonText = computed(() => config.value.buttonText || "page.general.custom")
```
**解决**: 正确使用$t函数调用
```javascript  
// ✅ 正确写法 - 直接调用$t函数
const deviceName = computed(() => props.card?.name || $t('page.general.device'))

// ✅ 正确写法 - 使用$t函数而不是字符串
const buttonText = computed(() => config.value.buttonText || $t('page.general.custom'))
```

## 🎯 避免中文Key的策略

### 智能英文Key生成
脚本采用多层策略确保生成合理的英文key：

1. **精确映射**: 通过预设映射表直接转换常见词汇
2. **模式匹配**: 识别"请输入"、"请选择"等模式
3. **语义分析**: 根据上下文生成合适的key
4. **Fallback机制**: 即使没有精确映射也能生成有意义的key

### Key生成示例
```javascript
// 精确映射
"配色主题1" -> "colorTheme1"
"曲线宽度" -> "curveWidth"
"请选择主题" -> "selectTheme"

// 模式匹配
"请输入用户名" -> "enterUsername"
"请选择设备" -> "selectDevice"

// 智能组合
"数据发送成功" -> "dataSendSuccess"
"在线设备数" -> "onlineDeviceCount"
```

### 预防措施
- ✅ **扩充映射表**: 持续完善commonMappings
- ✅ **模式识别**: 加强对常见文案模式的识别
- ✅ **语义分析**: 根据文件路径和上下文优化分类
- ✅ **人工检查**: 处理后人工检查生成的key质量

## 🔍 验证方法

### 检查替换效果
```bash
# 启动开发服务器
npm run dev

# 检查页面显示是否正常
# 检查控制台是否有错误
```

### 检查生成的JSON文件
```bash
# 查看生成的键名结构
cat src/locales/langs/zh-CN/common.json
cat src/locales/langs/zh-CN/page.json
```

### 检查替换后的文件
```bash
# 查看替换后的Vue文件
git diff src/views/_builtin/login/index.vue
```

## 🎉 成功案例

### Chart-Card模块处理结果
- ✅ **提取文案**: 150个 → 190个英文key
- ✅ **文件处理**: 42个文件完成国际化  
- ✅ **Key质量**: 直接生成英文key，无中文key问题
- ✅ **分类合理**: common/page命名空间分类清晰
- ✅ **项目运行**: 正常启动，功能完整

### 英文Key生成效果
```javascript
// 测试文案 → 生成的英文key
"配色主题1" → "page.general.colorTheme1"
"请选择主题" → "page.general.form.selectTheme"  
"数据发送成功" → "page.general.dataSendSuccess"
"在线设备数" → "common.status.onlineDeviceCount"
"曲线宽度设置" → "page.general.title.settings"
```

### 登录模块处理结果
- ✅ **提取文案**: 5个
- ✅ **生成键名**: 规范的嵌套结构  
- ✅ **替换效果**: `{{ $t('page.login.slogan') }}` 正确显示
- ✅ **项目运行**: 正常启动，无错误 