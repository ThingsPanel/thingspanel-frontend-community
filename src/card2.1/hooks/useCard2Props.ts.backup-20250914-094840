/**
 * Card 2.1 å±æ€§å¤„ç† Hook
 * æä¾›ç®€åŒ–çš„æ•°æ®ç»‘å®šå’Œå±æ€§ç®¡ç†
 * 
 * ğŸ”¥ ç»Ÿä¸€é…ç½®ç®¡ç†æ¶æ„ï¼šæ‰€æœ‰é…ç½®å…ˆå½’é›†åˆ°å¡ç‰‡çº§åˆ«ï¼Œç¼–è¾‘å™¨ä»…ä½œä¸ºæ˜¾ç¤ºå±‚
 */

import { computed, ref, watch, type Ref } from 'vue'
import { inject } from 'vue'
import { DataSourceMapper } from '@/card2.1/core/data-source-mapper'

/**
 * Card 2.1 ç»Ÿä¸€é…ç½®æ¥å£
 * åŒ…å«æ‰€æœ‰é…ç½®ç±»å‹ï¼šåŸºç¡€é…ç½®ã€ç»„ä»¶é…ç½®ã€æ•°æ®æºé…ç½®ã€äº¤äº’é…ç½®
 */
export interface UnifiedCard2Configuration {
  /** åŸºç¡€é…ç½® - å¸ƒå±€ã€å°ºå¯¸ã€ä½ç½®ç­‰ */
  base?: Record<string, unknown>
  /** ç»„ä»¶é…ç½® - ç»„ä»¶ç‰¹å®šçš„å±æ€§å’Œè®¾ç½® */
  component?: Record<string, unknown>
  /** æ•°æ®æºé…ç½® - æ•°æ®ç»‘å®šå’Œæ¥æºé…ç½® */
  dataSource?: Record<string, unknown>
  /** äº¤äº’é…ç½® - ç»„ä»¶é—´äº¤äº’å’Œè¡Œä¸ºé…ç½® */
  interaction?: Record<string, unknown>
  /** ç»„ä»¶ID - ç”¨äºé…ç½®ç®¡ç†å’ŒæŒä¹…åŒ– */
  componentId?: string
}

/**
 * å¢å¼ºçš„ Card 2.1 å±æ€§ Hook
 * ç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®ç±»å‹ï¼Œæ”¯æŒé…ç½®æ›´æ–°å’ŒæŒä¹…åŒ–
 */
export function useCard2Props<T = Record<string, unknown>>(props: {
  config: T
  data?: Record<string, unknown>
  componentId?: string
  // ğŸ”¥ æ–°å¢ï¼šæ¥æ”¶ç¼–è¾‘å™¨çš„ç»Ÿä¸€é…ç½®
  editorUnifiedConfig?: UnifiedCard2Configuration
}) {
  // ğŸ”¥ æ³¨å…¥ç¼–è¾‘å™¨ä¸Šä¸‹æ–‡ï¼Œç”¨äºé…ç½®åŒæ­¥
  const editorContext = inject('editorContext', null) as any
  
  // é…ç½®å“åº”å¼å¼•ç”¨
  const config = computed(() => props.config)
  
  // ğŸ”¥ æ˜¾ç¤ºæ•°æ®å“åº”å¼å¼•ç”¨ - é›†æˆæ•°æ®æºæ˜ å°„
  const displayData = computed(() => {
    // å¦‚æœæ²¡æœ‰ componentIdï¼Œæ— æ³•è·å–ç»„ä»¶ç±»å‹ï¼Œå›é€€åˆ°åŸå§‹æ•°æ®
    if (!props.componentId) {
      return props.data || {}
    }
    
    // å°è¯•è·å–ç»„ä»¶ç±»å‹
    let componentType = props.componentId
    if (editorContext?.getNodeById) {
      const node = editorContext.getNodeById(props.componentId)
      componentType = node?.type || props.componentId
    }
    
    // ä½¿ç”¨æ•°æ®æºæ˜ å°„å™¨å¤„ç†æ•°æ®
    const mappedData = DataSourceMapper.mapDataSources(componentType, props.data as any)
    
    // å°†æ˜ å°„åçš„æ•°æ®ä¸é…ç½®åˆå¹¶ï¼Œæ•°æ®æºæ•°æ®ä¼˜å…ˆçº§æ›´é«˜
    return {
      ...props.config, // é…ç½®ä½œä¸ºé»˜è®¤å€¼
      ...mappedData    // æ•°æ®æºæ•°æ®è¦†ç›–é…ç½®
    }
  })
  
  // ğŸ”¥ ç»Ÿä¸€é…ç½®çŠ¶æ€ - æ‰€æœ‰é…ç½®é›†ä¸­ç®¡ç†ï¼Œä¼˜å…ˆä½¿ç”¨ç¼–è¾‘å™¨çš„ç»Ÿä¸€é…ç½®
  const unifiedConfig = ref<UnifiedCard2Configuration>({
    base: props.editorUnifiedConfig?.base || {},
    component: props.editorUnifiedConfig?.component || { ...props.config },
    dataSource: props.editorUnifiedConfig?.dataSource || {},
    interaction: props.editorUnifiedConfig?.interaction || {},
    componentId: props.componentId
  })
  
  // ğŸ”¥ è°ƒè¯•ï¼šè¾“å‡ºç»Ÿä¸€é…ç½®åˆå§‹åŒ–ä¿¡æ¯
  console.log(`ğŸ”¥ [useCard2Props] ç»Ÿä¸€é…ç½®åˆå§‹åŒ– ${props.componentId}:`, {
    hasEditorConfig: !!props.editorUnifiedConfig,
    editorDataSource: props.editorUnifiedConfig?.dataSource,
    finalDataSource: unifiedConfig.value.dataSource
  })
  
  // ğŸ”¥ é…ç½®æ›´æ–°å‡½æ•° - æŒ‰å±‚çº§æ›´æ–°ï¼Œæˆä¸ºçœŸæ­£çš„é…ç½®ç®¡ç†ä¸­å¿ƒ
  const updateConfig = (layer: keyof UnifiedCard2Configuration, newConfig: any) => {
    console.log(`ğŸ”¥ [useCard2Props] æ›´æ–°é…ç½®å±‚ ${layer}:`, newConfig)
    
    // æ›´æ–°æŒ‡å®šé…ç½®å±‚
    unifiedConfig.value = {
      ...unifiedConfig.value,
      [layer]: { ...unifiedConfig.value[layer], ...newConfig }
    }
    
    // ğŸ”¥ åŒæ­¥åˆ°ç¼–è¾‘å™¨
    syncToEditor()
  }

  // ğŸ”¥ æ‰¹é‡é…ç½®æ›´æ–°å‡½æ•° - æ”¯æŒåŒæ—¶æ›´æ–°å¤šä¸ªé…ç½®å±‚
  const updateUnifiedConfig = (partialConfig: Partial<UnifiedCard2Configuration>) => {
    console.log(`ğŸ”¥ [useCard2Props] æ‰¹é‡æ›´æ–°é…ç½®:`, partialConfig)
    
    unifiedConfig.value = {
      ...unifiedConfig.value,
      ...partialConfig
    }
    
    // ğŸ”¥ åŒæ­¥åˆ°ç¼–è¾‘å™¨
    syncToEditor()
  }

  // ğŸ”¥ åŒæ­¥åˆ°ç¼–è¾‘å™¨å‡½æ•°
  const syncToEditor = () => {
    if (editorContext?.updateNode && props.componentId) {
      const currentNode = editorContext.getNodeById(props.componentId)
      if (currentNode) {
        // é¿å…å¾ªç¯æ›´æ–°çš„æ£€æŸ¥
        const currentUnifiedConfig = currentNode.metadata?.unifiedConfig
        if (JSON.stringify(currentUnifiedConfig) !== JSON.stringify(unifiedConfig.value)) {
          console.log(`ğŸ”¥ [useCard2Props] åŒæ­¥é…ç½®åˆ°ç¼–è¾‘å™¨ ${props.componentId}:`, unifiedConfig.value)
          
          editorContext.updateNode(props.componentId, {
            properties: unifiedConfig.value.component || {},
            metadata: {
              ...currentNode.metadata,
              unifiedConfig: unifiedConfig.value,
              updatedAt: Date.now()
            }
          })
        }
      }
    }
  }
  
  // ğŸ”¥ ç›‘å¬å¤–éƒ¨é…ç½®å˜åŒ–
  watch(() => props.config, (newConfig) => {
    if (newConfig && typeof newConfig === 'object') {
      updateUnifiedConfig({ component: { ...newConfig } })
    }
  }, { deep: true, immediate: true })
  
  // ğŸ”¥ è·å–å®Œæ•´é…ç½®ï¼ˆç”¨äºæŒä¹…åŒ–å’Œå¯¼å‡ºï¼‰
  const getFullConfiguration = () => {
    return { ...unifiedConfig.value }
  }
  
  // ğŸ”¥ é…ç½®å˜æ›´äº‹ä»¶å‘å°„å™¨ - ç”¨äºç»„ä»¶ä¸å¤–ç•Œé€šä¿¡
  let configChangeCallback: ((config: UnifiedCard2Configuration) => void) | null = null
  
  const setConfigChangeCallback = (callback: (config: UnifiedCard2Configuration) => void) => {
    configChangeCallback = callback
  }
  
  const emitConfigChange = () => {
    if (configChangeCallback) {
      configChangeCallback(unifiedConfig.value)
    }
  }

  // ğŸ”¥ å¢å¼ºçš„åŒæ­¥åˆ°ç¼–è¾‘å™¨å‡½æ•°ï¼ŒåŒ…å«äº‹ä»¶å‘å°„
  const syncToEditorWithEvent = () => {
    syncToEditor()
    emitConfigChange()
  }

  // ğŸ”¥ é‡å†™é…ç½®æ›´æ–°å‡½æ•°ï¼Œæ·»åŠ äº‹ä»¶å‘å°„
  const updateConfigWithEvent = (layer: keyof UnifiedCard2Configuration, newConfig: any) => {
    console.log(`ğŸ”¥ [useCard2Props] æ›´æ–°é…ç½®å±‚ ${layer}:`, newConfig)
    
    unifiedConfig.value = {
      ...unifiedConfig.value,
      [layer]: { ...unifiedConfig.value[layer], ...newConfig }
    }
    
    syncToEditorWithEvent()
  }
  
  return {
    config,
    displayData,
    // ğŸ”¥ ç»Ÿä¸€é…ç½®ç®¡ç†æ ¸å¿ƒåŠŸèƒ½
    unifiedConfig: computed(() => unifiedConfig.value),
    updateConfig: updateConfigWithEvent,
    updateUnifiedConfig,
    getFullConfiguration,
    // ğŸ”¥ äº‹ä»¶ç®¡ç†åŠŸèƒ½
    setConfigChangeCallback,
    emitConfigChange,
    syncToEditor
  }
}