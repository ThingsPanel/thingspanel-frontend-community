# ThingsPanel è„šæœ¬å¼•æ“ç³»ç»Ÿ

## æ¦‚è¿°

ThingsPanel è„šæœ¬å¼•æ“æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ JavaScript è„šæœ¬æ‰§è¡Œç³»ç»Ÿï¼Œä¸“ä¸ºç‰©è”ç½‘æ•°æ®å¤„ç†åœºæ™¯è®¾è®¡ã€‚å®ƒæä¾›äº†å®‰å…¨çš„æ²™ç®±ç¯å¢ƒã€ä¸°å¯Œçš„æ¨¡æ¿åº“ã€çµæ´»çš„ä¸Šä¸‹æ–‡ç®¡ç†å’Œå®Œå–„çš„æ‰§è¡Œç›‘æ§åŠŸèƒ½ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **ğŸ”’ å®‰å…¨æ²™ç®±**ï¼šéš”ç¦»æ‰§è¡Œç¯å¢ƒï¼Œé˜²æ­¢æ¶æ„ä»£ç æ”»å‡»
- **ğŸ“‹ æ¨¡æ¿ç³»ç»Ÿ**ï¼šé¢„åˆ¶è„šæœ¬æ¨¡æ¿ï¼Œæ”¯æŒå‚æ•°åŒ–é…ç½®
- **ğŸ›ï¸ ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šå¤šç§æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæ”¯æŒå˜é‡å’Œå‡½æ•°ç®¡ç†
- **ğŸ“Š æ€§èƒ½ç›‘æ§**ï¼šå®æ—¶æ‰§è¡Œç»Ÿè®¡ã€å†…å­˜ä½¿ç”¨ç›‘æ§
- **ğŸ”§ å·¥å…·é›†æˆ**ï¼šå†…ç½®æ•°æ®å¤„ç†ã€æ—¶é—´å¤„ç†ã€ç½‘ç»œè¯·æ±‚ç­‰å·¥å…·
- **ğŸš€ å¼‚æ­¥æ”¯æŒ**ï¼šæ”¯æŒå¼‚æ­¥è„šæœ¬æ‰§è¡Œå’Œæµå¼ç»“æœ

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ScriptEngine (ä¸»å¼•æ“)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ScriptExecutor â”‚ ScriptSandbox   â”‚ TemplateManager â”‚ ContextMgr   â”‚
â”‚  (è„šæœ¬æ‰§è¡Œå™¨)    â”‚ (å®‰å…¨æ²™ç®±)       â”‚ (æ¨¡æ¿ç®¡ç†)       â”‚ (ä¸Šä¸‹æ–‡ç®¡ç†)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ‰§è¡Œæ§åˆ¶      â”‚ â€¢ å®‰å…¨æ£€æŸ¥       â”‚ â€¢ æ¨¡æ¿CRUD      â”‚ â€¢ ä¸Šä¸‹æ–‡CRUD â”‚
â”‚ â€¢ ç»Ÿè®¡æ”¶é›†      â”‚ â€¢ æ²™ç®±éš”ç¦»       â”‚ â€¢ ä»£ç ç”Ÿæˆ      â”‚ â€¢ å˜é‡ç®¡ç†   â”‚
â”‚ â€¢ é”™è¯¯å¤„ç†      â”‚ â€¢ è¶…æ—¶æ§åˆ¶       â”‚ â€¢ å‚æ•°éªŒè¯      â”‚ â€¢ å‡½æ•°ç®¡ç†   â”‚
â”‚ â€¢ æ—¥å¿—æ”¶é›†      â”‚ â€¢ å†…ç½®å·¥å…·       â”‚ â€¢ åˆ†ç±»ç®¡ç†      â”‚ â€¢ å…‹éš†åˆå¹¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/core/script-engine/
â”œâ”€â”€ index.ts                    # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ types.ts                    # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ script-engine.ts            # ä¸»å¼•æ“å®ç°
â”œâ”€â”€ executor.ts                 # è„šæœ¬æ‰§è¡Œå™¨
â”œâ”€â”€ sandbox.ts                  # å®‰å…¨æ²™ç®±
â”œâ”€â”€ template-manager.ts         # æ¨¡æ¿ç®¡ç†å™¨
â”œâ”€â”€ context-manager.ts          # ä¸Šä¸‹æ–‡ç®¡ç†å™¨
â”œâ”€â”€ components/                 # Vue ç»„ä»¶
â”‚   â””â”€â”€ index.ts               # ç»„ä»¶å¯¼å‡º
â””â”€â”€ templates/                  # æ¨¡æ¿åº“
    â””â”€â”€ built-in-templates.ts  # å†…ç½®æ¨¡æ¿å®šä¹‰
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```typescript
import { defaultScriptEngine } from '@/core/script-engine'

// 1. ç®€å•è„šæœ¬æ‰§è¡Œ
const result = await defaultScriptEngine.execute('return Math.random() * 100')
console.log(result.data) // éšæœºæ•°ç»“æœ

// 2. å¸¦ä¸Šä¸‹æ–‡æ‰§è¡Œ
const contextResult = await defaultScriptEngine.execute(
  'return temperature * 1.8 + 32', // æ‘„æ°åº¦è½¬åæ°åº¦
  { temperature: 25 }
)
console.log(contextResult.data) // 77

// 3. ä½¿ç”¨æ¨¡æ¿æ‰§è¡Œ
const templateResult = await defaultScriptEngine.executeTemplate(
  'random-data-generator', 
  { count: 5, fields: [{ name: 'temp', type: 'number' }] }
)
```

### é«˜çº§åŠŸèƒ½

```typescript
// æ‰¹é‡æ‰§è¡Œ
const batchResults = await defaultScriptEngine.executeBatch([
  { code: 'return new Date().getTime()', context: {} },
  { code: 'return Math.PI * radius * radius', context: { radius: 5 } }
])

// æµå¼æ‰§è¡Œï¼ˆå®æ—¶åé¦ˆï¼‰
await defaultScriptEngine.executeStream(
  'return "Processing..." + Date.now()',
  {},
  (partialResult) => {
    console.log('è¿›åº¦æ›´æ–°:', partialResult)
  }
)

// å®‰å…¨æ£€æŸ¥
const securityCheck = defaultScriptEngine.checkScriptSecurity(
  'eval("malicious code")'
)
console.log(securityCheck) // { safe: false, issues: [...] }
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. ScriptExecutor (è„šæœ¬æ‰§è¡Œå™¨)

è´Ÿè´£å®é™…çš„è„šæœ¬æ‰§è¡Œã€ç»“æœå¤„ç†å’Œæ€§èƒ½ç»Ÿè®¡ã€‚

```typescript
interface IScriptExecutor {
  execute<T>(config: ScriptConfig, context?: ScriptExecutionContext): Promise<ScriptExecutionResult<T>>
  validateSyntax(code: string): { valid: boolean; error?: string }
  getExecutionStats(): ExecutionStats
}
```

**ä¸»è¦åŠŸèƒ½ï¼š**
- âœ… è„šæœ¬è¯­æ³•éªŒè¯
- âœ… å®‰å…¨æ‰§è¡Œæ§åˆ¶
- âœ… æ‰§è¡Œæ—¶é—´ç»Ÿè®¡
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—æ”¶é›†
- âœ… å¹¶å‘æ‰§è¡Œç®¡ç†

### 2. ScriptSandbox (å®‰å…¨æ²™ç®±)

æä¾›éš”ç¦»çš„æ‰§è¡Œç¯å¢ƒï¼Œé˜²æ­¢æ¶æ„ä»£ç æ”»å‡»ã€‚

```typescript
interface IScriptSandbox {
  createSandbox(config: SandboxConfig): any
  executeInSandbox(code: string, sandbox: any, timeout?: number): Promise<any>
  destroySandbox(sandbox: any): void
  checkCodeSecurity(code: string): { safe: boolean; issues: string[] }
}
```

**å®‰å…¨ç‰¹æ€§ï¼š**
- ğŸ”’ ç¦ç”¨å±é™©å‡½æ•° (`eval`, `Function`, `require` ç­‰)
- ğŸ”’ å…¨å±€å¯¹è±¡è®¿é—®æ§åˆ¶
- ğŸ”’ åŸå‹æ±¡æŸ“é˜²æŠ¤
- ğŸ”’ æ‰§è¡Œè¶…æ—¶æ§åˆ¶
- ğŸ”’ è‡ªå®šä¹‰å®‰å…¨ç­–ç•¥

**å…è®¸çš„å®‰å…¨å…¨å±€å¯¹è±¡ï¼š**
```typescript
allowedGlobals: [
  'Math', 'Date', 'JSON', 'Promise',
  'setTimeout', 'clearTimeout', 
  'setInterval', 'clearInterval',
  'console', 'parseInt', 'parseFloat',
  'isNaN', 'isFinite'
]
```

### 3. ScriptTemplateManager (æ¨¡æ¿ç®¡ç†å™¨)

ç®¡ç†å¯é‡ç”¨çš„è„šæœ¬æ¨¡æ¿ï¼Œæ”¯æŒå‚æ•°åŒ–å’Œåˆ†ç±»ç®¡ç†ã€‚

```typescript
interface IScriptTemplateManager {
  getAllTemplates(): ScriptTemplate[]
  getTemplatesByCategory(category: string): ScriptTemplate[]
  createTemplate(template: Omit<ScriptTemplate, 'id' | 'createdAt' | 'updatedAt'>): ScriptTemplate
  generateCode(templateId: string, parameters: Record<string, any>): string
}
```

**å†…ç½®æ¨¡æ¿åˆ†ç±»ï¼š**
- ğŸ“Š **æ•°æ®ç”Ÿæˆ** (`data-generation`)
  - æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®
  - éšæœºæ—¶åºæ•°æ®
  - æ•°å€¼èŒƒå›´ç”Ÿæˆ
- ğŸ”„ **æ•°æ®å¤„ç†** (`data-processing`)
  - æ•°å€¼è®¡ç®—å¤„ç†
  - æ•°ç»„è¿‡æ»¤æ’åº
  - æ™ºèƒ½å¯¹è±¡åˆå¹¶
- ğŸŒ **APIé›†æˆ** (`api-integration`)
  - HTTP APIè°ƒç”¨
  - å“åº”å¤„ç†
  - é”™è¯¯é‡è¯•
- â±ï¸ **æ—¶åºæ•°æ®** (`time-series`)
  - æ—¶é—´åºåˆ—ç”Ÿæˆ
  - æ—¶åºæ•°æ®åˆå¹¶
  - æ—¶é—´æ ¼å¼åŒ–
- ğŸ› ï¸ **å·¥å…·å‡½æ•°** (`utility`)
  - æ•°æ®éªŒè¯
  - æ€§èƒ½ç›‘æ§
  - æ ¼å¼è½¬æ¢

### 4. ScriptContextManager (ä¸Šä¸‹æ–‡ç®¡ç†å™¨)

ç®¡ç†è„šæœ¬æ‰§è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ŒåŒ…æ‹¬å˜é‡å’Œå‡½æ•°ã€‚

```typescript
interface IScriptContextManager {
  createContext(name: string, variables?: Record<string, any>): ScriptExecutionContext
  updateContext(id: string, updates: Partial<ScriptExecutionContext>): boolean
  cloneContext(id: string, newName: string): ScriptExecutionContext | null
  mergeContexts(sourceId: string, targetId: string): boolean
}
```

**é¢„è®¾ä¸Šä¸‹æ–‡ï¼š**
- ğŸ  **é»˜è®¤ä¸Šä¸‹æ–‡**ï¼šåº”ç”¨åŸºç¡€ä¿¡æ¯å’Œé€šç”¨å·¥å…·
- ğŸ“Š **æ•°æ®å¤„ç†ä¸Šä¸‹æ–‡**ï¼šæ•°æ®éªŒè¯å’Œè½¬æ¢å‡½æ•°
- ğŸ­ **IoTè®¾å¤‡ä¸Šä¸‹æ–‡**ï¼šè®¾å¤‡æ¶ˆæ¯è§£æå’Œæ•°æ®ç”Ÿæˆ

## ğŸ› ï¸ å†…ç½®å·¥å…·å‡½æ•°

### æ•°æ®ç”Ÿæˆå·¥å…· (`_utils.mockData`)

```javascript
// åœ¨è„šæœ¬ä¸­ä½¿ç”¨
const randomNum = _utils.mockData.randomNumber(1, 100)
const randomStr = _utils.mockData.randomString(10)
const randomBool = _utils.mockData.randomBoolean()
const randomDate = _utils.mockData.randomDate()
const randomArr = _utils.mockData.randomArray(['A', 'B', 'C'], 2)
```

### æ•°æ®å¤„ç†å·¥å…· (`_utils.dataUtils`)

```javascript
// æ·±æ‹·è´å¯¹è±¡
const cloned = _utils.dataUtils.deepClone(originalObj)

// å¯¹è±¡å±æ€§é€‰æ‹©/æ’é™¤
const picked = _utils.dataUtils.pick(obj, ['name', 'age'])
const omitted = _utils.dataUtils.omit(obj, ['password'])

// æ•°ç»„åˆ†ç»„å’Œæ’åº
const grouped = _utils.dataUtils.groupBy(array, 'category')
const sorted = _utils.dataUtils.sortBy(array, 'timestamp')
```

### æ—¶é—´å¤„ç†å·¥å…· (`_utils.timeUtils`)

```javascript
// æ—¶é—´æ ¼å¼åŒ–
const formatted = _utils.timeUtils.format(Date.now(), 'YYYY-MM-DD HH:mm:ss')

// æ—¥æœŸè®¡ç®—
const nextWeek = _utils.timeUtils.addDays(new Date(), 7)
const daysDiff = _utils.timeUtils.diffDays(date1, date2)
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

### æ‰§è¡Œç»Ÿè®¡

```typescript
const stats = defaultScriptEngine.getExecutionStats()
console.log({
  totalExecutions: stats.executor.totalExecutions,
  successRate: stats.executor.successfulExecutions / stats.executor.totalExecutions,
  averageTime: stats.executor.averageExecutionTime,
  templates: stats.templates.total,
  contexts: stats.contexts.total
})
```

### å†…å­˜ä½¿ç”¨ç›‘æ§

```javascript
// åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨æ€§èƒ½ç›‘æ§
const startTime = performance.now()
const memoryBefore = performance.memory?.usedJSHeapSize || 0

// ... æ•°æ®å¤„ç†é€»è¾‘ ...

const endTime = performance.now()
const memoryAfter = performance.memory?.usedJSHeapSize || 0

return {
  result: processedData,
  performance: {
    duration: endTime - startTime,
    memoryUsed: memoryAfter - memoryBefore
  }
}
```

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### 1. ä»£ç å®‰å…¨æ£€æŸ¥

```typescript
// æ‰§è¡Œå‰æ£€æŸ¥ä»£ç å®‰å…¨æ€§
const securityCheck = defaultScriptEngine.checkScriptSecurity(userCode)
if (!securityCheck.safe) {
  console.error('å®‰å…¨æ£€æŸ¥å¤±è´¥:', securityCheck.issues)
  return
}
```

### 2. æ‰§è¡Œè¶…æ—¶è®¾ç½®

```typescript
const config: ScriptConfig = {
  code: userScript,
  timeout: 10000,        // 10ç§’è¶…æ—¶
  maxMemory: 50 * 1024 * 1024,  // 50MBå†…å­˜é™åˆ¶
  strictMode: true,      // ä¸¥æ ¼æ¨¡å¼
  allowNetworkAccess: false     // ç¦æ­¢ç½‘ç»œè®¿é—®
}
```

### 3. æ²™ç®±é…ç½®

```typescript
const sandboxConfig: SandboxConfig = {
  enabled: true,
  allowedGlobals: ['Math', 'Date', 'JSON'],  // åªå…è®¸å®‰å…¨çš„å…¨å±€å¯¹è±¡
  blockedGlobals: ['eval', 'Function', 'window'],
  allowEval: false,
  allowFunction: false,
  allowPrototypePollution: false,
  customSecurityPolicy: (code: string) => {
    // è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥é€»è¾‘
    return !code.includes('dangerous_pattern')
  }
}
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. IoT æ•°æ®å¤„ç†

```typescript
// ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†æ¨¡æ¿
const sensorDataScript = `
const { temperature, humidity, timestamp } = data
return {
  processed: true,
  temperature: Math.round(temperature * 100) / 100,
  humidity: Math.round(humidity * 100) / 100,
  heatIndex: calculateHeatIndex(temperature, humidity),
  timestamp: timestamp,
  alert: temperature > 35 || humidity > 90
}

function calculateHeatIndex(t, h) {
  return -42.379 + 2.04901523*t + 10.14333127*h - 0.22475541*t*h
}
`
```

### 2. æ•°æ®å¯è§†åŒ–é¢„å¤„ç†

```typescript
// å›¾è¡¨æ•°æ®æ ¼å¼åŒ–
const chartDataScript = `
const chartData = data.map((item, index) => ({
  x: index,
  y: item.value,
  label: item.name,
  color: item.value > 50 ? '#ff4757' : '#2ed573'
}))

return {
  type: 'line',
  data: chartData,
  options: {
    responsive: true,
    scales: {
      y: { min: 0, max: 100 }
    }
  }
}
`
```

### 3. è§„åˆ™å¼•æ“

```typescript
// è®¾å¤‡å‘Šè­¦è§„åˆ™
const alertRuleScript = `
const rules = [
  { field: 'temperature', operator: '>', threshold: 30, level: 'warning' },
  { field: 'temperature', operator: '>', threshold: 40, level: 'critical' },
  { field: 'humidity', operator: '<', threshold: 20, level: 'warning' }
]

const alerts = []
rules.forEach(rule => {
  const value = data[rule.field]
  if (value !== undefined) {
    let triggered = false
    switch (rule.operator) {
      case '>': triggered = value > rule.threshold; break
      case '<': triggered = value < rule.threshold; break
      case '>=': triggered = value >= rule.threshold; break
      case '<=': triggered = value <= rule.threshold; break
      case '==': triggered = value == rule.threshold; break
    }
    
    if (triggered) {
      alerts.push({
        field: rule.field,
        value: value,
        threshold: rule.threshold,
        level: rule.level,
        message: \`\${rule.field} å€¼ \${value} \${rule.operator} \${rule.threshold}\`
      })
    }
  }
})

return { alerts, hasAlerts: alerts.length > 0 }
`
```

## ğŸ”§ é…ç½®é€‰é¡¹

### å¼•æ“é…ç½®

```typescript
const engineConfig: ScriptEngineConfig = {
  // é»˜è®¤è„šæœ¬é…ç½®
  defaultScriptConfig: {
    timeout: 5000,
    strictMode: true,
    asyncSupport: true,
    maxMemory: 50 * 1024 * 1024,
    allowNetworkAccess: false,
    allowFileSystemAccess: false
  },
  
  // æ²™ç®±é…ç½®
  sandboxConfig: {
    enabled: true,
    allowedGlobals: ['Math', 'Date', 'JSON', 'Promise'],
    blockedGlobals: ['eval', 'Function', 'window', 'document']
  },
  
  // ç¼“å­˜é…ç½®
  enableCache: true,
  cacheTTL: 5 * 60 * 1000,  // 5åˆ†é’Ÿ
  
  // å¹¶å‘æ§åˆ¶
  maxConcurrentExecutions: 10,
  
  // æ€§èƒ½ç›‘æ§
  enablePerformanceMonitoring: true
}

const customEngine = new ScriptEngine(engineConfig)
```

## ğŸ“ å¼€å‘æŒ‡å—

### åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿

```typescript
import { defaultScriptEngine } from '@/core/script-engine'

// åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿
const customTemplate = defaultScriptEngine.templateManager.createTemplate({
  name: 'è‡ªå®šä¹‰æ•°æ®å¤„ç†',
  description: 'æ ¹æ®ä¸šåŠ¡éœ€æ±‚å¤„ç†æ•°æ®',
  category: 'custom',
  code: `
    const threshold = {{threshold}}
    const field = {{field}}
    
    if (Array.isArray(data)) {
      return data.filter(item => item[field] > threshold)
    }
    
    return data[field] > threshold ? data : null
  `,
  parameters: [
    {
      name: 'threshold',
      type: 'number',
      description: 'è¿‡æ»¤é˜ˆå€¼',
      required: true,
      defaultValue: 0
    },
    {
      name: 'field',
      type: 'string', 
      description: 'æ¯”è¾ƒå­—æ®µ',
      required: true,
      defaultValue: 'value'
    }
  ],
  example: '// context = { threshold: 50, field: "temperature" }'
})
```

### æ‰©å±•ä¸Šä¸‹æ–‡åŠŸèƒ½

```typescript
// åˆ›å»ºä¸“ç”¨ä¸Šä¸‹æ–‡
const deviceContext = defaultScriptEngine.contextManager.createContext(
  'è®¾å¤‡ä¸“ç”¨ä¸Šä¸‹æ–‡',
  {
    deviceType: 'sensor',
    location: 'building_a',
    protocol: 'mqtt'
  }
)

// æ·»åŠ è‡ªå®šä¹‰å‡½æ•°
defaultScriptEngine.contextManager.addFunction(
  deviceContext.id,
  'parseDeviceMessage',
  (rawMessage: string) => {
    try {
      return JSON.parse(rawMessage)
    } catch {
      return { error: 'Invalid message format', raw: rawMessage }
    }
  }
)
```

### é”™è¯¯å¤„ç†å’Œè°ƒè¯•

```typescript
try {
  const result = await defaultScriptEngine.execute(userScript, context)
  
  if (!result.success) {
    console.error('è„šæœ¬æ‰§è¡Œå¤±è´¥:', result.error?.message)
    console.log('æ‰§è¡Œæ—¥å¿—:', result.logs)
    console.log('ä¸Šä¸‹æ–‡å¿«ç…§:', result.contextSnapshot)
  } else {
    console.log('æ‰§è¡ŒæˆåŠŸ:', result.data)
    console.log('æ‰§è¡Œæ—¶é—´:', result.executionTime + 'ms')
  }
} catch (error) {
  console.error('å¼•æ“å¼‚å¸¸:', error)
}
```

## ğŸ§ª æµ‹è¯•å’Œè°ƒè¯•

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```typescript
import { ScriptEngine } from '@/core/script-engine'

describe('ScriptEngine', () => {
  let engine: ScriptEngine

  beforeEach(() => {
    engine = new ScriptEngine()
  })

  test('åŸºæœ¬è„šæœ¬æ‰§è¡Œ', async () => {
    const result = await engine.execute('return 1 + 1')
    expect(result.success).toBe(true)
    expect(result.data).toBe(2)
  })

  test('æ¨¡æ¿æ‰§è¡Œ', async () => {
    const result = await engine.executeTemplate('random-data-generator', {
      count: 3,
      fields: [{ name: 'test', type: 'number' }]
    })
    expect(result.success).toBe(true)
    expect(Array.isArray(result.data)).toBe(true)
    expect(result.data.length).toBe(3)
  })

  test('å®‰å…¨æ£€æŸ¥', () => {
    const check = engine.checkScriptSecurity('eval("malicious")')
    expect(check.safe).toBe(false)
    expect(check.issues.length).toBeGreaterThan(0)
  })
})
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. é¢„çƒ­å¼•æ“

```typescript
// åº”ç”¨å¯åŠ¨æ—¶é¢„çƒ­å¼•æ“
await defaultScriptEngine.warmup()
```

### 2. ç¼“å­˜å¸¸ç”¨è„šæœ¬

```typescript
// ä½¿ç”¨æ¨¡æ¿è€Œä¸æ˜¯é‡å¤çš„å†…è”è„šæœ¬
const templateId = 'data-processor'
const result = await defaultScriptEngine.executeTemplate(templateId, params)
```

### 3. æ‰¹é‡å¤„ç†

```typescript
// æ‰¹é‡æ‰§è¡Œè€Œä¸æ˜¯å•ä¸ªå¾ªç¯
const scripts = dataItems.map(item => ({
  code: 'return processItem(data)',
  context: { data: item }
}))
const results = await defaultScriptEngine.executeBatch(scripts)
```

## ğŸ“ˆ ç›‘æ§å’Œè¿ç»´

### å¼•æ“çŠ¶æ€å¯¼å‡º

```typescript
// å¯¼å‡ºå¼•æ“çŠ¶æ€ç”¨äºå¤‡ä»½
const engineState = defaultScriptEngine.exportState()
localStorage.setItem('script-engine-backup', JSON.stringify(engineState))

// æ¢å¤å¼•æ“çŠ¶æ€
const savedState = JSON.parse(localStorage.getItem('script-engine-backup'))
defaultScriptEngine.importState(savedState)
```

### æ€§èƒ½æŒ‡æ ‡ç›‘æ§

```typescript
// å®šæœŸæ”¶é›†æ€§èƒ½æŒ‡æ ‡
setInterval(() => {
  const stats = defaultScriptEngine.getExecutionStats()
  
  // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
  sendMetrics({
    totalExecutions: stats.executor.totalExecutions,
    successRate: stats.executor.successfulExecutions / stats.executor.totalExecutions,
    avgExecutionTime: stats.executor.averageExecutionTime,
    currentConcurrency: stats.executor.currentConcurrentExecutions
  })
}, 60000) // æ¯åˆ†é’Ÿä¸€æ¬¡
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. **æ·»åŠ æ–°æ¨¡æ¿**ï¼šåœ¨ `templates/built-in-templates.ts` ä¸­æ·»åŠ 
2. **æ‰©å±•å·¥å…·å‡½æ•°**ï¼šåœ¨ `sandbox.ts` çš„ `createBuiltinUtils` æ–¹æ³•ä¸­æ·»åŠ 
3. **å¢å¼ºå®‰å…¨æ£€æŸ¥**ï¼šåœ¨ `sandbox.ts` çš„ `checkCodeSecurity` æ–¹æ³•ä¸­æ·»åŠ è§„åˆ™
4. **ä¼˜åŒ–æ€§èƒ½**ï¼šå…³æ³¨æ‰§è¡Œæ—¶é—´å’Œå†…å­˜ä½¿ç”¨

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº MIT è®¸å¯è¯å¼€æºã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

**ğŸŒŸ äº«å—ä½¿ç”¨ ThingsPanel è„šæœ¬å¼•æ“çš„å¼ºå¤§åŠŸèƒ½ï¼**