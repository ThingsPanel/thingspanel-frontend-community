<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Engine ä½¿ç”¨æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .main-content {
            display: flex;
            min-height: 600px;
        }
        
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #ddd;
        }
        
        .content {
            flex: 1;
            padding: 20px;
        }
        
        .demo-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .demo-header {
            background: #f5f5f5;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: bold;
            color: #333;
        }
        
        .demo-body {
            padding: 20px;
        }
        
        .demo-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .demo-button:active {
            transform: translateY(0);
        }
        
        .demo-button.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .demo-button.success {
            background: linear-gradient(45deg, #27ae60, #229954);
        }
        
        .demo-button.warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-time {
            color: #888;
            margin-right: 10px;
        }
        
        .log-level-info {
            color: #00ff00;
        }
        
        .log-level-warn {
            color: #ffff00;
        }
        
        .log-level-error {
            color: #ff4444;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .event-type-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
        }
        
        .event-type-item {
            background: #e9ecef;
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        .input-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .clear-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            float: right;
        }
        
        .performance-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .performance-good { background: #28a745; }
        .performance-ok { background: #ffc107; }
        .performance-bad { background: #dc3545; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .pulsing {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Event Engine ä½¿ç”¨æ¼”ç¤º</h1>
            <p>ThingsPanel ç‰©è”ç½‘å¯è§†åŒ–å¹³å° - äº‹ä»¶é©±åŠ¨æ¶æ„æ¼”ç¤º</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <h3>ğŸ“Š å®æ—¶ç»Ÿè®¡</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalEvents">0</div>
                        <div class="stat-label">æ€»äº‹ä»¶æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalHandlers">0</div>
                        <div class="stat-label">æ´»è·ƒç›‘å¬å™¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="eventTypes">0</div>
                        <div class="stat-label">äº‹ä»¶ç±»å‹</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="performance">-</div>
                        <div class="stat-label">æ€§èƒ½æŒ‡æ ‡</div>
                    </div>
                </div>
                
                <h3>ğŸ“ æ´»è·ƒäº‹ä»¶ç±»å‹</h3>
                <div class="event-type-list" id="eventTypesList"></div>
                
                <h3>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h3>
                <button class="demo-button success" onclick="startPerformanceTest()">æ€§èƒ½æµ‹è¯•</button>
                <button class="demo-button warning" onclick="generateRandomEvents()">éšæœºäº‹ä»¶</button>
                <button class="demo-button danger" onclick="stopAllTests()">åœæ­¢æµ‹è¯•</button>
                <button class="clear-button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            
            <div class="content">
                <div class="demo-section">
                    <div class="demo-header">ğŸ¯ åŸºç¡€äº‹ä»¶æ¼”ç¤º</div>
                    <div class="demo-body">
                        <p>æ¼”ç¤ºåŸºæœ¬çš„äº‹ä»¶å‘é€å’Œç›‘å¬åŠŸèƒ½</p>
                        <button class="demo-button" onclick="sendDeviceStatusEvent()">è®¾å¤‡çŠ¶æ€å˜æ›´</button>
                        <button class="demo-button" onclick="sendConfigChangeEvent()">é…ç½®å˜æ›´</button>
                        <button class="demo-button" onclick="sendUserActionEvent()">ç”¨æˆ·æ“ä½œ</button>
                        <button class="demo-button" onclick="sendDataUpdateEvent()">æ•°æ®æ›´æ–°</button>
                    </div>
                </div>
                
                <div class="demo-section">
                    <div class="demo-header">ğŸ”— ç³»ç»Ÿé›†æˆæ¼”ç¤º</div>
                    <div class="demo-body">
                        <p>æ¼”ç¤ºä¸å„ä¸ªå­ç³»ç»Ÿçš„é›†æˆèƒ½åŠ›</p>
                        <button class="demo-button" onclick="simulateCard21Integration()">Card2.1 é›†æˆ</button>
                        <button class="demo-button" onclick="simulateVisualEditorIntegration()">å¯è§†åŒ–ç¼–è¾‘å™¨</button>
                        <button class="demo-button" onclick="simulateCoreSystemIntegration()">æ ¸å¿ƒç³»ç»Ÿ</button>
                    </div>
                </div>
                
                <div class="demo-section">
                    <div class="demo-header">âš¡ é«˜çº§åŠŸèƒ½æ¼”ç¤º</div>
                    <div class="demo-body">
                        <p>æ¼”ç¤ºäº‹ä»¶é“¾ã€é”™è¯¯å¤„ç†ã€æ‰¹é‡æ“ä½œç­‰é«˜çº§åŠŸèƒ½</p>
                        <button class="demo-button" onclick="demonstrateEventChain()">äº‹ä»¶å¤„ç†é“¾</button>
                        <button class="demo-button" onclick="demonstrateErrorHandling()">é”™è¯¯å¤„ç†</button>
                        <button class="demo-button" onclick="demonstrateBatchOperations()">æ‰¹é‡æ“ä½œ</button>
                    </div>
                </div>
                
                <div class="demo-section">
                    <div class="demo-header">ğŸ› ï¸ è‡ªå®šä¹‰äº‹ä»¶æµ‹è¯•</div>
                    <div class="demo-body">
                        <div class="input-group">
                            <label for="customEventType">äº‹ä»¶ç±»å‹:</label>
                            <input type="text" id="customEventType" placeholder="ä¾‹: custom:test:event" value="custom:test:event">
                        </div>
                        <div class="input-group">
                            <label for="customEventPayload">äº‹ä»¶è½½è· (JSON):</label>
                            <textarea id="customEventPayload" placeholder='{"message": "æµ‹è¯•æ¶ˆæ¯", "data": 123}'>{
  "message": "è‡ªå®šä¹‰æµ‹è¯•äº‹ä»¶",
  "customData": {
    "value": 42,
    "timestamp": "{{timestamp}}"
  }
}</textarea>
                        </div>
                        <button class="demo-button" onclick="sendCustomEvent()">å‘é€è‡ªå®šä¹‰äº‹ä»¶</button>
                        <button class="demo-button warning" onclick="listenToCustomEvent()">ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶</button>
                    </div>
                </div>
                
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-time">[ç³»ç»Ÿ]</span>
                        <span class="log-level-info">Event Engine æ¼”ç¤ºç³»ç»Ÿå·²å¯åŠ¨</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿ Event Engine åŸºç¡€åŠŸèƒ½
        class DemoEventEngine {
            constructor() {
                this.handlers = new Map()
                this.stats = {
                    totalEvents: 0,
                    totalHandlers: 0,
                    eventTypes: new Set()
                }
                this.performanceData = []
                this.testIntervals = new Set()
            }
            
            on(eventType, handler) {
                if (!this.handlers.has(eventType)) {
                    this.handlers.set(eventType, new Set())
                }
                this.handlers.get(eventType).add(handler)
                this.stats.eventTypes.add(eventType)
                this.updateStats()
                
                // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
                return () => {
                    this.handlers.get(eventType).delete(handler)
                    if (this.handlers.get(eventType).size === 0) {
                        this.handlers.delete(eventType)
                        this.stats.eventTypes.delete(eventType)
                    }
                    this.updateStats()
                }
            }
            
            async emit(eventType, payload) {
                const startTime = performance.now()
                
                // æ·»åŠ æ—¶é—´æˆ³
                payload.timestamp = payload.timestamp || Date.now()
                payload.source = payload.source || 'demo-system'
                
                this.stats.totalEvents++
                this.stats.eventTypes.add(eventType)
                
                // è§¦å‘äº‹ä»¶å¤„ç†å™¨
                if (this.handlers.has(eventType)) {
                    const handlers = Array.from(this.handlers.get(eventType))
                    for (const handler of handlers) {
                        try {
                            await handler(payload, eventType)
                        } catch (error) {
                            logMessage(`äº‹ä»¶å¤„ç†å™¨é”™è¯¯: ${error.message}`, 'error')
                        }
                    }
                }
                
                // è®°å½•æ€§èƒ½æ•°æ®
                const duration = performance.now() - startTime
                this.performanceData.push(duration)
                if (this.performanceData.length > 100) {
                    this.performanceData.shift()
                }
                
                this.updateStats()
                
                // è®°å½•æ—¥å¿—
                logMessage(`äº‹ä»¶å‘é€: ${eventType}`, 'info', payload)
            }
            
            getStatistics() {
                const avgPerformance = this.performanceData.length > 0 
                    ? (this.performanceData.reduce((a, b) => a + b, 0) / this.performanceData.length).toFixed(2)
                    : 0
                    
                return {
                    totalEvents: this.stats.totalEvents,
                    totalHandlers: Array.from(this.handlers.values()).reduce((sum, handlers) => sum + handlers.size, 0),
                    eventTypes: Array.from(this.stats.eventTypes),
                    averagePerformance: parseFloat(avgPerformance)
                }
            }
            
            updateStats() {
                const stats = this.getStatistics()
                
                document.getElementById('totalEvents').textContent = stats.totalEvents
                document.getElementById('totalHandlers').textContent = stats.totalHandlers
                document.getElementById('eventTypes').textContent = stats.eventTypes.length
                
                // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
                const perfElement = document.getElementById('performance')
                if (stats.averagePerformance > 0) {
                    perfElement.textContent = stats.averagePerformance + 'ms'
                    
                    // æ€§èƒ½æŒ‡ç¤ºå™¨
                    perfElement.className = 'stat-value'
                    if (stats.averagePerformance < 1) {
                        perfElement.innerHTML += '<span class="performance-indicator performance-good"></span>'
                    } else if (stats.averagePerformance < 5) {
                        perfElement.innerHTML += '<span class="performance-indicator performance-ok"></span>'
                    } else {
                        perfElement.innerHTML += '<span class="performance-indicator performance-bad"></span>'
                    }
                }
                
                // æ›´æ–°äº‹ä»¶ç±»å‹åˆ—è¡¨
                const eventTypesList = document.getElementById('eventTypesList')
                eventTypesList.innerHTML = ''
                stats.eventTypes.forEach(eventType => {
                    const item = document.createElement('div')
                    item.className = 'event-type-item'
                    item.textContent = eventType
                    eventTypesList.appendChild(item)
                })
            }
            
            clearAllIntervals() {
                this.testIntervals.forEach(interval => clearInterval(interval))
                this.testIntervals.clear()
            }
        }
        
        // åˆ›å»ºæ¼”ç¤ºäº‹ä»¶å¼•æ“å®ä¾‹
        const eventEngine = new DemoEventEngine()
        
        // æ—¥å¿—ç³»ç»Ÿ
        function logMessage(message, level = 'info', data = null) {
            const logContainer = document.getElementById('logContainer')
            const logEntry = document.createElement('div')
            logEntry.className = 'log-entry'
            
            const now = new Date()
            const timeStr = now.toLocaleTimeString()
            
            let logHtml = `<span class="log-time">[${timeStr}]</span>`
            logHtml += `<span class="log-level-${level}">${message}</span>`
            
            if (data && typeof data === 'object') {
                logHtml += `<br><span style="color: #888; font-size: 11px; margin-left: 80px;">æ•°æ®: ${JSON.stringify(data, null, 2)}</span>`
            }
            
            logEntry.innerHTML = logHtml
            logContainer.appendChild(logEntry)
            logContainer.scrollTop = logContainer.scrollHeight
            
            // é™åˆ¶æ—¥å¿—æ¡æ•°
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild)
            }
        }
        
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = ''
            logMessage('æ—¥å¿—å·²æ¸…ç©º', 'info')
        }
        
        // åŸºç¡€äº‹ä»¶æ¼”ç¤ºå‡½æ•°
        async function sendDeviceStatusEvent() {
            const deviceId = 'demo_device_' + Math.floor(Math.random() * 1000)
            const statuses = ['online', 'offline', 'maintenance', 'error']
            const status = statuses[Math.floor(Math.random() * statuses.length)]
            
            await eventEngine.emit('device:status:change', {
                deviceId,
                status,
                previousStatus: status === 'online' ? 'offline' : 'online',
                reason: status === 'offline' ? 'ç½‘ç»œè¿æ¥ä¸­æ–­' : 'çŠ¶æ€æ­£å¸¸æ›´æ–°'
            })
        }
        
        async function sendConfigChangeEvent() {
            const configs = [
                { key: 'themeMode', newValue: 'dark', oldValue: 'light' },
                { key: 'language', newValue: 'zh-CN', oldValue: 'en-US' },
                { key: 'refreshInterval', newValue: 5000, oldValue: 3000 },
                { key: 'enableNotifications', newValue: true, oldValue: false }
            ]
            
            const config = configs[Math.floor(Math.random() * configs.length)]
            
            await eventEngine.emit('config:change', {
                ...config,
                source: 'user-settings'
            })
        }
        
        async function sendUserActionEvent() {
            const actions = [
                {
                    eventType: 'user:action:click',
                    payload: {
                        componentId: 'chart_widget_' + Math.floor(Math.random() * 100),
                        position: { x: Math.floor(Math.random() * 800), y: Math.floor(Math.random() * 600) },
                        button: 'left'
                    }
                },
                {
                    eventType: 'user:action:drag',
                    payload: {
                        componentId: 'panel_item_' + Math.floor(Math.random() * 100),
                        startPosition: { x: 100, y: 100 },
                        endPosition: { x: Math.floor(Math.random() * 400), y: Math.floor(Math.random() * 300) }
                    }
                },
                {
                    eventType: 'user:action:select',
                    payload: {
                        componentId: 'device_list_item_' + Math.floor(Math.random() * 50),
                        selectionType: 'single',
                        ctrlKey: Math.random() > 0.5
                    }
                }
            ]
            
            const action = actions[Math.floor(Math.random() * actions.length)]
            await eventEngine.emit(action.eventType, action.payload)
        }
        
        async function sendDataUpdateEvent() {
            const dataTypes = [
                {
                    eventType: 'data:received',
                    payload: {
                        deviceId: 'sensor_' + Math.floor(Math.random() * 100),
                        rawData: {
                            temperature: (Math.random() * 40 - 10).toFixed(1),
                            humidity: (Math.random() * 100).toFixed(1),
                            pressure: (Math.random() * 200 + 900).toFixed(2)
                        }
                    }
                },
                {
                    eventType: 'data:processed',
                    payload: {
                        deviceId: 'gateway_' + Math.floor(Math.random() * 10),
                        processedData: {
                            averageTemp: (Math.random() * 30 + 10).toFixed(1),
                            dataPoints: Math.floor(Math.random() * 100),
                            quality: Math.random() > 0.8 ? 'high' : 'medium'
                        },
                        processingTime: Math.floor(Math.random() * 500)
                    }
                }
            ]
            
            const dataUpdate = dataTypes[Math.floor(Math.random() * dataTypes.length)]
            await eventEngine.emit(dataUpdate.eventType, dataUpdate.payload)
        }
        
        // ç³»ç»Ÿé›†æˆæ¼”ç¤º
        async function simulateCard21Integration() {
            const events = [
                'card21:config:update',
                'card21:data:binding:change',
                'card21:component:render',
                'card21:validation:result'
            ]
            
            for (const eventType of events) {
                await eventEngine.emit(eventType, {
                    cardId: 'card_' + Math.floor(Math.random() * 100),
                    componentType: 'digital-indicator',
                    configData: { theme: 'modern', size: 'medium' },
                    status: 'success'
                })
                
                // å°å»¶è¿Ÿä»¥ä¾¿è§‚å¯Ÿ
                await new Promise(resolve => setTimeout(resolve, 200))
            }
        }
        
        async function simulateVisualEditorIntegration() {
            const events = [
                'visual-editor:component:select',
                'visual-editor:layout:change',
                'visual-editor:property:update',
                'visual-editor:canvas:resize'
            ]
            
            for (const eventType of events) {
                await eventEngine.emit(eventType, {
                    editorId: 'editor_main',
                    componentId: 'component_' + Math.floor(Math.random() * 50),
                    operation: 'user-interaction',
                    data: { x: Math.random() * 1000, y: Math.random() * 800 }
                })
                
                await new Promise(resolve => setTimeout(resolve, 300))
            }
        }
        
        async function simulateCoreSystemIntegration() {
            const events = [
                'core:system:init',
                'core:module:loaded',
                'core:service:ready',
                'core:health:check'
            ]
            
            for (const eventType of events) {
                await eventEngine.emit(eventType, {
                    module: 'data-architecture',
                    version: '2.1.0',
                    status: 'operational',
                    metrics: {
                        memoryUsage: Math.floor(Math.random() * 100) + 'MB',
                        cpuUsage: Math.floor(Math.random() * 50) + '%'
                    }
                })
                
                await new Promise(resolve => setTimeout(resolve, 250))
            }
        }
        
        // é«˜çº§åŠŸèƒ½æ¼”ç¤º
        async function demonstrateEventChain() {
            logMessage('å¼€å§‹æ¼”ç¤ºäº‹ä»¶å¤„ç†é“¾', 'info')
            
            // è®¾ç½®äº‹ä»¶é“¾ç›‘å¬å™¨
            eventEngine.on('chain:step1', async (payload) => {
                logMessage('äº‹ä»¶é“¾æ­¥éª¤1: æ•°æ®æ¥æ”¶', 'info', payload)
                await new Promise(resolve => setTimeout(resolve, 100))
                
                await eventEngine.emit('chain:step2', {
                    ...payload,
                    step1Result: 'æ•°æ®éªŒè¯å®Œæˆ',
                    processedAt: Date.now()
                })
            })
            
            eventEngine.on('chain:step2', async (payload) => {
                logMessage('äº‹ä»¶é“¾æ­¥éª¤2: æ•°æ®å¤„ç†', 'info', payload)
                await new Promise(resolve => setTimeout(resolve, 150))
                
                await eventEngine.emit('chain:step3', {
                    ...payload,
                    step2Result: 'æ•°æ®è½¬æ¢å®Œæˆ',
                    transformedData: { ...payload.rawData, processed: true }
                })
            })
            
            eventEngine.on('chain:step3', (payload) => {
                logMessage('äº‹ä»¶é“¾æ­¥éª¤3: æ•°æ®å­˜å‚¨å®Œæˆ', 'info', payload)
            })
            
            // å¯åŠ¨äº‹ä»¶é“¾
            await eventEngine.emit('chain:step1', {
                chainId: 'demo_chain_' + Date.now(),
                rawData: {
                    temperature: 25.6,
                    humidity: 62.3,
                    location: 'ä¼ æ„Ÿå™¨åŒºåŸŸA'
                }
            })
        }
        
        async function demonstrateErrorHandling() {
            logMessage('å¼€å§‹æ¼”ç¤ºé”™è¯¯å¤„ç†æœºåˆ¶', 'info')
            
            // é”™è¯¯å¤„ç†ç›‘å¬å™¨
            eventEngine.on('system:error', (payload) => {
                logMessage(`ç³»ç»Ÿé”™è¯¯æ•è·: ${payload.error.message}`, 'error', payload)
            })
            
            eventEngine.on('error:test:event', (payload) => {
                // æ•…æ„æŠ›å‡ºé”™è¯¯æ¥æµ‹è¯•é”™è¯¯å¤„ç†
                throw new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯: ' + payload.testData)
            })
            
            // å‘é€ä¼šå¯¼è‡´é”™è¯¯çš„äº‹ä»¶
            await eventEngine.emit('error:test:event', {
                testData: 'é”™è¯¯å¤„ç†æ¼”ç¤º',
                intentionalError: true
            })
            
            // å‘é€é”™è¯¯æ¢å¤äº‹ä»¶
            setTimeout(async () => {
                await eventEngine.emit('system:recovery', {
                    recoveryAction: 'é”™è¯¯å¤„ç†å®Œæˆ',
                    status: 'recovered'
                })
            }, 1000)
        }
        
        async function demonstrateBatchOperations() {
            logMessage('å¼€å§‹æ¼”ç¤ºæ‰¹é‡æ“ä½œ', 'info')
            
            const batchEvents = [
                'batch:device:status:update',
                'batch:data:sync',
                'batch:config:validate',
                'batch:notification:send'
            ]
            
            // æ‰¹é‡ç›‘å¬å™¨
            batchEvents.forEach(eventType => {
                eventEngine.on(eventType, (payload) => {
                    logMessage(`æ‰¹é‡æ“ä½œ: ${eventType}`, 'info', {
                        batchId: payload.batchId,
                        itemCount: payload.items ? payload.items.length : 0
                    })
                })
            })
            
            // å¹¶å‘å‘é€æ‰¹é‡äº‹ä»¶
            const batchPromises = batchEvents.map((eventType, index) => 
                eventEngine.emit(eventType, {
                    batchId: 'batch_' + Date.now() + '_' + index,
                    items: Array.from({length: Math.floor(Math.random() * 10) + 5}, (_, i) => ({
                        id: `item_${i}`,
                        data: `æ‰¹é‡æ•°æ®é¡¹ ${i + 1}`
                    })),
                    operation: 'æ‰¹é‡å¤„ç†æ¼”ç¤º'
                })
            )
            
            await Promise.all(batchPromises)
            logMessage('æ‰¹é‡æ“ä½œå®Œæˆ', 'info')
        }
        
        // è‡ªå®šä¹‰äº‹ä»¶åŠŸèƒ½
        let customEventUnsubscriber = null
        
        async function sendCustomEvent() {
            const eventType = document.getElementById('customEventType').value.trim()
            const payloadStr = document.getElementById('customEventPayload').value.trim()
            
            if (!eventType) {
                logMessage('è¯·è¾“å…¥äº‹ä»¶ç±»å‹', 'error')
                return
            }
            
            try {
                let payload = {}
                if (payloadStr) {
                    // æ›¿æ¢æ—¶é—´æˆ³å ä½ç¬¦
                    const processedPayload = payloadStr.replace('{{timestamp}}', Date.now().toString())
                    payload = JSON.parse(processedPayload)
                }
                
                await eventEngine.emit(eventType, payload)
                logMessage(`è‡ªå®šä¹‰äº‹ä»¶å·²å‘é€: ${eventType}`, 'info')
            } catch (error) {
                logMessage(`JSON è§£æé”™è¯¯: ${error.message}`, 'error')
            }
        }
        
        function listenToCustomEvent() {
            const eventType = document.getElementById('customEventType').value.trim()
            
            if (!eventType) {
                logMessage('è¯·è¾“å…¥äº‹ä»¶ç±»å‹', 'error')
                return
            }
            
            // æ¸…é™¤ä¹‹å‰çš„ç›‘å¬å™¨
            if (customEventUnsubscriber) {
                customEventUnsubscriber()
            }
            
            // æ·»åŠ æ–°çš„ç›‘å¬å™¨
            customEventUnsubscriber = eventEngine.on(eventType, (payload) => {
                logMessage(`è‡ªå®šä¹‰äº‹ä»¶æ¥æ”¶: ${eventType}`, 'info', payload)
            })
            
            logMessage(`å¼€å§‹ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶: ${eventType}`, 'info')
        }
        
        // æ€§èƒ½æµ‹è¯•åŠŸèƒ½
        function startPerformanceTest() {
            logMessage('å¼€å§‹æ€§èƒ½æµ‹è¯• - æ¯ç§’å‘é€10ä¸ªäº‹ä»¶', 'info')
            
            let eventCount = 0
            const testInterval = setInterval(async () => {
                eventCount++
                
                await eventEngine.emit('performance:test:event', {
                    eventNumber: eventCount,
                    testData: `æ€§èƒ½æµ‹è¯•æ•°æ® ${eventCount}`,
                    batchSize: 10,
                    timestamp: Date.now()
                })
                
                if (eventCount >= 100) {
                    clearInterval(testInterval)
                    eventEngine.testIntervals.delete(testInterval)
                    logMessage('æ€§èƒ½æµ‹è¯•å®Œæˆ - å…±å‘é€100ä¸ªäº‹ä»¶', 'info')
                }
            }, 100) // æ¯100mså‘é€ä¸€ä¸ªäº‹ä»¶
            
            eventEngine.testIntervals.add(testInterval)
        }
        
        function generateRandomEvents() {
            logMessage('å¼€å§‹ç”Ÿæˆéšæœºäº‹ä»¶', 'info')
            
            const randomEventTypes = [
                'random:sensor:reading',
                'random:user:activity',
                'random:system:metric',
                'random:device:heartbeat',
                'random:data:update'
            ]
            
            const randomInterval = setInterval(async () => {
                const eventType = randomEventTypes[Math.floor(Math.random() * randomEventTypes.length)]
                
                await eventEngine.emit(eventType, {
                    randomValue: Math.random(),
                    randomId: Math.floor(Math.random() * 1000),
                    randomData: {
                        metric: Math.floor(Math.random() * 100),
                        status: Math.random() > 0.5 ? 'active' : 'inactive'
                    }
                })
            }, 500) // æ¯500msä¸€ä¸ªéšæœºäº‹ä»¶
            
            eventEngine.testIntervals.add(randomInterval)
            
            // 30ç§’åè‡ªåŠ¨åœæ­¢
            setTimeout(() => {
                clearInterval(randomInterval)
                eventEngine.testIntervals.delete(randomInterval)
                logMessage('éšæœºäº‹ä»¶ç”Ÿæˆå·²åœæ­¢', 'info')
            }, 30000)
        }
        
        function stopAllTests() {
            eventEngine.clearAllIntervals()
            logMessage('æ‰€æœ‰æµ‹è¯•å·²åœæ­¢', 'info')
        }
        
        // åˆå§‹åŒ–æ¼”ç¤º
        window.addEventListener('load', () => {
            logMessage('Event Engine æ¼”ç¤ºç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info')
            
            // è®¾ç½®å…¨å±€äº‹ä»¶ç›‘å¬å™¨è¿›è¡Œæ¼”ç¤º
            eventEngine.on('*', (payload, eventType) => {
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…¨å±€äº‹ä»¶å¤„ç†é€»è¾‘
                if (eventType.startsWith('system:') || eventType.startsWith('demo:')) {
                    // é«˜äº®é‡è¦ç³»ç»Ÿäº‹ä»¶
                    const logContainer = document.getElementById('logContainer')
                    if (logContainer.lastElementChild) {
                        logContainer.lastElementChild.classList.add('pulsing')
                        setTimeout(() => {
                            if (logContainer.lastElementChild) {
                                logContainer.lastElementChild.classList.remove('pulsing')
                            }
                        }, 1000)
                    }
                }
            })
            
            // å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            setInterval(() => {
                eventEngine.updateStats()
            }, 1000)
        })
    </script>
</body>
</html>