<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©è”ç½‘å¯è§†åŒ–å¹³å° - Event Engine æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #007bff;
        }

        .test-section h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }

        .test-section h3::before {
            content: "ğŸ”§";
            margin-right: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .log-container {
            grid-column: span 2;
            background: #1e1e1e;
            color: #f8f8f2;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #333;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 10px;
            border-radius: 4px;
            animation: fadeIn 0.3s ease-in;
        }

        .log-info {
            background: rgba(0, 123, 255, 0.1);
            border-left: 3px solid #007bff;
        }

        .log-success {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
        }

        .log-warning {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            color: #fff3cd;
        }

        .log-error {
            background: rgba(220, 53, 69, 0.1);
            border-left: 3px solid #dc3545;
            color: #f8d7da;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-top: 3px solid #007bff;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            display: block;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .controls {
            grid-column: span 2;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .controls h3 {
            margin-bottom: 15px;
        }

        .clear-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸš€ Event Engine æµ‹è¯•ä¸­å¿ƒ</h1>
            <p>ç‰©è”ç½‘å¯è§†åŒ–å¹³å°äº‹ä»¶å¼•æ“å®Œæ•´åŠŸèƒ½æµ‹è¯•</p>
        </header>

        <div class="main-content">
            <!-- åŸºç¡€äº‹ä»¶æµ‹è¯• -->
            <div class="test-section">
                <h3>åŸºç¡€äº‹ä»¶æµ‹è¯•</h3>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="testBasicEvents()">åŸºç¡€äº‹ä»¶å‘é€</button>
                    <button class="btn btn-success" onclick="testEventListener()">äº‹ä»¶ç›‘å¬å™¨æµ‹è¯•</button>
                    <button class="btn btn-warning" onclick="testEventCleanup()">æ¸…ç†æœºåˆ¶æµ‹è¯•</button>
                </div>
            </div>

            <!-- é…ç½®äº‹ä»¶å…¼å®¹æ€§æµ‹è¯• -->
            <div class="test-section">
                <h3>é…ç½®äº‹ä»¶å…¼å®¹æ€§æµ‹è¯•</h3>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="testConfigCompatibility()">é…ç½®äº‹ä»¶å…¼å®¹</button>
                    <button class="btn btn-success" onclick="testConfigEventBus()">ConfigEventBusé›†æˆ</button>
                    <button class="btn btn-warning" onclick="testDataTrigger()">æ•°æ®è§¦å‘å™¨æµ‹è¯•</button>
                </div>
            </div>

            <!-- é€‚é…å™¨æµ‹è¯• -->
            <div class="test-section">
                <h3>ç³»ç»Ÿé€‚é…å™¨æµ‹è¯•</h3>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="testCard21Adapter()">Card2.1 é€‚é…å™¨</button>
                    <button class="btn btn-success" onclick="testVisualEditorAdapter()">Visual Editor é€‚é…å™¨</button>
                    <button class="btn btn-warning" onclick="testCoreAdapter()">Core é€‚é…å™¨</button>
                </div>
            </div>

            <!-- æ€§èƒ½å’Œé”™è¯¯å¤„ç†æµ‹è¯• -->
            <div class="test-section">
                <h3>æ€§èƒ½å’Œé”™è¯¯å¤„ç†æµ‹è¯•</h3>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="testPerformance()">æ€§èƒ½æµ‹è¯•</button>
                    <button class="btn btn-danger" onclick="testErrorHandling()">é”™è¯¯å¤„ç†æµ‹è¯•</button>
                    <button class="btn btn-warning" onclick="testMemoryLeaks()">å†…å­˜æ³„æ¼æµ‹è¯•</button>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="controls">
                <h3>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h3>
                <button class="clear-btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="clear-btn" onclick="showStatistics()" style="margin-left: 15px;">æ˜¾ç¤ºç»Ÿè®¡</button>
            </div>

            <!-- æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">
                    <strong>[INFO]</strong> ğŸ¯ Event Engine æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œç­‰å¾…æµ‹è¯•å¼€å§‹...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== æ¨¡æ‹Ÿ Event Engine å’Œç›¸å…³æ¨¡å— =====
        
        // æ¨¡æ‹Ÿ ConfigEventBus
        const mockConfigEventBus = {
            handlers: new Map(),
            statistics: {
                eventsEmitted: 0,
                handlersExecuted: 0,
                errors: 0
            },
            onConfigChange(eventType, handler) {
                if (!this.handlers.has(eventType)) {
                    this.handlers.set(eventType, new Set());
                }
                this.handlers.get(eventType).add(handler);
                log(`[ConfigEventBus] æ³¨å†Œé…ç½®äº‹ä»¶ç›‘å¬å™¨: ${eventType}`, 'info');
                
                return () => {
                    this.handlers.get(eventType).delete(handler);
                    log(`[ConfigEventBus] å–æ¶ˆé…ç½®äº‹ä»¶ç›‘å¬å™¨: ${eventType}`, 'info');
                };
            },
            async emitConfigChange(event) {
                this.statistics.eventsEmitted++;
                const handlers = this.handlers.get(event.section) || new Set();
                
                log(`[ConfigEventBus] å‘å‡ºé…ç½®äº‹ä»¶: ${event.section}`, 'success');
                log(`ğŸ“‹ äº‹ä»¶è¯¦æƒ…: ${JSON.stringify(event, null, 2)}`, 'info');
                
                for (const handler of handlers) {
                    try {
                        await handler(event);
                        this.statistics.handlersExecuted++;
                    } catch (error) {
                        this.statistics.errors++;
                        log(`[ConfigEventBus] å¤„ç†å™¨æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                    }
                }
            },
            getStatistics() {
                return { ...this.statistics };
            }
        };

        // æ¨¡æ‹Ÿ Event Engine
        class MockEventEngine {
            constructor() {
                this.extendedHandlers = new Map();
                this.stats = {
                    totalEvents: 0,
                    extendedEvents: 0,
                    configEvents: 0
                };
                this.cleanupFunctions = [];
            }

            // å‘åå…¼å®¹æ¥å£
            onConfigChange = mockConfigEventBus.onConfigChange.bind(mockConfigEventBus);
            emitConfigChange = mockConfigEventBus.emitConfigChange.bind(mockConfigEventBus);

            on(eventType, handler) {
                // é…ç½®äº‹ä»¶ç±»å‹å¤„ç†
                const configEventTypes = [
                    'config-changed', 'data-source-changed', 'component-props-changed',
                    'base-config-changed', 'interaction-changed', 'before-config-change',
                    'after-config-change'
                ];
                
                if (configEventTypes.includes(eventType)) {
                    log(`[EventEngine] é…ç½®äº‹ä»¶ç±»å‹ ${eventType} è½¬å‘åˆ° ConfigEventBus`, 'warning');
                    return this.onConfigChange(eventType, (configEvent) => {
                        const extendedEvent = {
                            type: eventType,
                            payload: configEvent,
                            timestamp: configEvent.timestamp,
                            source: configEvent.source,
                            componentId: configEvent.componentId
                        };
                        this.safeExecuteHandler(handler, extendedEvent);
                    });
                }

                // æ‰©å±•äº‹ä»¶ç±»å‹å¤„ç†
                if (!this.extendedHandlers.has(eventType)) {
                    this.extendedHandlers.set(eventType, new Set());
                }

                this.extendedHandlers.get(eventType).add(handler);
                log(`[EventEngine] æ³¨å†Œæ‰©å±•äº‹ä»¶ç›‘å¬å™¨: ${eventType}`, 'info');

                const cleanup = () => {
                    const handlers = this.extendedHandlers.get(eventType);
                    if (handlers) {
                        handlers.delete(handler);
                        if (handlers.size === 0) {
                            this.extendedHandlers.delete(eventType);
                        }
                    }
                    log(`[EventEngine] æ¸…ç†æ‰©å±•äº‹ä»¶ç›‘å¬å™¨: ${eventType}`, 'info');
                };

                this.cleanupFunctions.push(cleanup);
                return cleanup;
            }

            async emit(eventType, payload, source = 'unknown') {
                this.stats.totalEvents++;
                
                // é…ç½®äº‹ä»¶å¤„ç†
                const configEventTypes = [
                    'config-changed', 'data-source-changed', 'component-props-changed',
                    'base-config-changed', 'interaction-changed'
                ];
                
                if (configEventTypes.includes(eventType)) {
                    if (this.isValidConfigChangeEvent(payload)) {
                        this.stats.configEvents++;
                        await mockConfigEventBus.emitConfigChange(payload);
                        return;
                    } else {
                        log(`[EventEngine] é…ç½®äº‹ä»¶æ ¼å¼ä¸æ­£ç¡®: ${eventType}`, 'error');
                        return;
                    }
                }

                // æ‰©å±•äº‹ä»¶å¤„ç†
                this.stats.extendedEvents++;
                const event = {
                    type: eventType,
                    payload,
                    timestamp: Date.now(),
                    source,
                    componentId: payload?.componentId
                };

                const handlers = this.extendedHandlers.get(eventType);
                if (!handlers || handlers.size === 0) {
                    log(`[EventEngine] äº‹ä»¶ç±»å‹ ${eventType} æ²¡æœ‰ç›‘å¬å™¨`, 'warning');
                    return;
                }

                log(`[EventEngine] å‘å‡ºæ‰©å±•äº‹ä»¶: ${eventType}`, 'success');
                log(`ğŸ“‹ äº‹ä»¶è¯¦æƒ…: ${JSON.stringify(event, null, 2)}`, 'info');

                const promises = Array.from(handlers).map(handler => 
                    this.safeExecuteHandler(handler, event)
                );

                await Promise.allSettled(promises);
            }

            async safeExecuteHandler(handler, event) {
                try {
                    const result = handler(event);
                    if (result instanceof Promise) {
                        await result;
                    }
                    log(`âœ… äº‹ä»¶å¤„ç†å™¨æ‰§è¡ŒæˆåŠŸ: ${event.type}`, 'success');
                } catch (error) {
                    log(`âŒ äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                }
            }

            isValidConfigChangeEvent(payload) {
                return payload && 
                       typeof payload.componentId === 'string' &&
                       typeof payload.componentType === 'string' &&
                       typeof payload.section === 'string' &&
                       typeof payload.timestamp === 'number' &&
                       typeof payload.source === 'string';
            }

            getStatistics() {
                return {
                    ...this.stats,
                    configEventBus: mockConfigEventBus.getStatistics(),
                    activeExtendedEventTypes: this.extendedHandlers.size,
                    totalExtendedHandlers: Array.from(this.extendedHandlers.values())
                        .reduce((sum, handlers) => sum + handlers.size, 0)
                };
            }

            clear() {
                this.extendedHandlers.clear();
                this.stats = {
                    totalEvents: 0,
                    extendedEvents: 0,
                    configEvents: 0
                };
                log(`[EventEngine] æ‰©å±•äº‹ä»¶å¤„ç†å™¨å·²æ¸…ç†`, 'info');
            }
        }

        // åˆ›å»ºå…¨å±€å®ä¾‹
        const eventEngine = new MockEventEngine();
        window.eventEngine = eventEngine;

        // ===== æ—¥å¿—ç³»ç»Ÿ =====
        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const icon = {
                'info': 'ğŸ“˜',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ'
            }[type] || 'ğŸ“';
            
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${icon} ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©ºï¼Œå‡†å¤‡æ–°çš„æµ‹è¯•...', 'info');
        }

        // ===== æµ‹è¯•å‡½æ•° =====
        
        function testBasicEvents() {
            log('ğŸ§ª å¼€å§‹åŸºç¡€äº‹ä»¶æµ‹è¯•', 'info');
            
            // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
            const cleanup = eventEngine.on('component-lifecycle', (event) => {
                log(`æ”¶åˆ°ç»„ä»¶ç”Ÿå‘½å‘¨æœŸäº‹ä»¶: ${event.payload.action}`, 'success');
            });

            // å‘é€æµ‹è¯•äº‹ä»¶
            eventEngine.emit('component-lifecycle', {
                componentId: 'test-component',
                action: 'created',
                timestamp: Date.now()
            }, 'test-basic');

            setTimeout(() => {
                eventEngine.emit('component-lifecycle', {
                    componentId: 'test-component',
                    action: 'destroyed',
                    timestamp: Date.now()
                }, 'test-basic');
            }, 1000);

            log('âœ… åŸºç¡€äº‹ä»¶æµ‹è¯•å®Œæˆ', 'success');
        }

        function testEventListener() {
            log('ğŸ§ª å¼€å§‹äº‹ä»¶ç›‘å¬å™¨æµ‹è¯•', 'info');
            
            let eventCount = 0;
            const cleanup = eventEngine.on('data-update', (event) => {
                eventCount++;
                log(`æ•°æ®æ›´æ–°äº‹ä»¶ #${eventCount}: ${event.payload.data}`, 'success');
            });

            // å‘é€å¤šä¸ªäº‹ä»¶æµ‹è¯•
            for (let i = 1; i <= 3; i++) {
                setTimeout(() => {
                    eventEngine.emit('data-update', {
                        data: `æµ‹è¯•æ•°æ® ${i}`,
                        componentId: `component-${i}`
                    }, 'listener-test');
                }, i * 500);
            }

            log('âœ… äº‹ä»¶ç›‘å¬å™¨æµ‹è¯•å®Œæˆ', 'success');
        }

        function testEventCleanup() {
            log('ğŸ§ª å¼€å§‹æ¸…ç†æœºåˆ¶æµ‹è¯•', 'info');
            
            const cleanup = eventEngine.on('ui-interaction', (event) => {
                log(`UIäº¤äº’äº‹ä»¶: ${event.payload.action}`, 'success');
            });

            // å‘é€äº‹ä»¶
            eventEngine.emit('ui-interaction', {
                action: 'click',
                target: 'button'
            }, 'cleanup-test');

            // æ¸…ç†ç›‘å¬å™¨
            setTimeout(() => {
                cleanup();
                log('äº‹ä»¶ç›‘å¬å™¨å·²æ¸…ç†', 'warning');
                
                // å°è¯•å†æ¬¡å‘é€äº‹ä»¶ï¼ˆåº”è¯¥æ²¡æœ‰å“åº”ï¼‰
                eventEngine.emit('ui-interaction', {
                    action: 'click-after-cleanup',
                    target: 'button'
                }, 'cleanup-test');
                
                log('âœ… æ¸…ç†æœºåˆ¶æµ‹è¯•å®Œæˆ', 'success');
            }, 1500);
        }

        function testConfigCompatibility() {
            log('ğŸ§ª å¼€å§‹é…ç½®äº‹ä»¶å…¼å®¹æ€§æµ‹è¯•', 'info');
            
            // æ³¨å†Œé…ç½®äº‹ä»¶ç›‘å¬å™¨
            const cleanup = eventEngine.on('config-changed', (event) => {
                log(`é…ç½®å˜æ›´äº‹ä»¶: ${event.payload.section}`, 'success');
            });

            // åˆ›å»ºæœ‰æ•ˆçš„é…ç½®å˜æ›´äº‹ä»¶
            const configEvent = {
                componentId: 'test-component',
                componentType: 'chart',
                section: 'dataSource',
                timestamp: Date.now(),
                source: 'user',
                oldConfig: { type: 'api' },
                newConfig: { type: 'websocket' }
            };

            // å‘é€é…ç½®äº‹ä»¶
            eventEngine.emit('config-changed', configEvent, 'compat-test');
            
            log('âœ… é…ç½®äº‹ä»¶å…¼å®¹æ€§æµ‹è¯•å®Œæˆ', 'success');
        }

        function testConfigEventBus() {
            log('ğŸ§ª å¼€å§‹ ConfigEventBus é›†æˆæµ‹è¯•', 'info');
            
            // ç›´æ¥ä½¿ç”¨ ConfigEventBus æ–¹æ³•
            const cleanup = eventEngine.onConfigChange('data-source-changed', (event) => {
                log(`ConfigEventBus æ•°æ®æºå˜æ›´: ${event.componentId}`, 'success');
            });

            // åˆ›å»ºé…ç½®äº‹ä»¶
            const configEvent = {
                componentId: 'chart-widget',
                componentType: 'visualization',
                section: 'data-source-changed',
                timestamp: Date.now(),
                source: 'system',
                oldConfig: { url: 'old-api' },
                newConfig: { url: 'new-api' }
            };

            // é€šè¿‡ EventEngine å‘é€
            eventEngine.emitConfigChange(configEvent);
            
            log('âœ… ConfigEventBus é›†æˆæµ‹è¯•å®Œæˆ', 'success');
        }

        function testDataTrigger() {
            log('ğŸ§ª å¼€å§‹æ•°æ®è§¦å‘å™¨æµ‹è¯•', 'info');
            
            // æ¨¡æ‹Ÿæ•°æ®æ‰§è¡Œè§¦å‘å™¨
            if (eventEngine.registerDataExecutionTrigger) {
                const cleanup = eventEngine.registerDataExecutionTrigger((event) => {
                    log(`æ•°æ®æ‰§è¡Œè§¦å‘: ${event.componentId}`, 'success');
                });

                log('æ•°æ®æ‰§è¡Œè§¦å‘å™¨å·²æ³¨å†Œ', 'info');
            } else {
                log('æ•°æ®æ‰§è¡Œè§¦å‘å™¨ä¸å¯ç”¨ï¼ˆæ¨¡æ‹Ÿç¯å¢ƒï¼‰', 'warning');
            }
            
            log('âœ… æ•°æ®è§¦å‘å™¨æµ‹è¯•å®Œæˆ', 'success');
        }

        function testCard21Adapter() {
            log('ğŸ§ª å¼€å§‹ Card2.1 é€‚é…å™¨æµ‹è¯•', 'info');
            
            // æ¨¡æ‹Ÿ Card2.1 é€‚é…å™¨
            const componentId = 'card21-test';
            const cleanup = eventEngine.on('component-lifecycle', (event) => {
                if (event.componentId === componentId) {
                    log(`Card2.1 ç»„ä»¶äº‹ä»¶: ${event.payload.status}`, 'success');
                }
            });

            // å‘é€ Card2.1 ç»„ä»¶äº‹ä»¶
            eventEngine.emit('component-lifecycle', {
                componentId: componentId,
                status: 'initialized',
                config: { type: 'gauge-dashboard' }
            }, 'card21-adapter');

            log('âœ… Card2.1 é€‚é…å™¨æµ‹è¯•å®Œæˆ', 'success');
        }

        function testVisualEditorAdapter() {
            log('ğŸ§ª å¼€å§‹ Visual Editor é€‚é…å™¨æµ‹è¯•', 'info');
            
            // æ¨¡æ‹Ÿç¼–è¾‘å™¨äº‹ä»¶
            const cleanup = eventEngine.on('ui-interaction', (event) => {
                log(`ç¼–è¾‘å™¨äº¤äº’: ${event.payload.action}`, 'success');
            });

            // å‘é€ç¼–è¾‘å™¨äº‹ä»¶
            eventEngine.emit('ui-interaction', {
                action: 'component-selected',
                target: 'chart-widget',
                editorMode: 'design'
            }, 'visual-editor');

            log('âœ… Visual Editor é€‚é…å™¨æµ‹è¯•å®Œæˆ', 'success');
        }

        function testCoreAdapter() {
            log('ğŸ§ª å¼€å§‹ Core é€‚é…å™¨æµ‹è¯•', 'info');
            
            // æ¨¡æ‹Ÿç³»ç»Ÿäº‹ä»¶
            const cleanup = eventEngine.on('system-ready', (event) => {
                log(`ç³»ç»Ÿå°±ç»ªäº‹ä»¶: ${event.payload.module}`, 'success');
            });

            // å‘é€ç³»ç»Ÿäº‹ä»¶
            eventEngine.emit('system-ready', {
                module: 'data-architecture',
                version: '2.1.0',
                initTime: Date.now() - 1000
            }, 'core-adapter');

            log('âœ… Core é€‚é…å™¨æµ‹è¯•å®Œæˆ', 'success');
        }

        function testPerformance() {
            log('ğŸ§ª å¼€å§‹æ€§èƒ½æµ‹è¯•', 'info');
            
            const startTime = Date.now();
            const eventCount = 100;
            let receivedCount = 0;

            const cleanup = eventEngine.on('performance-test', (event) => {
                receivedCount++;
                if (receivedCount === eventCount) {
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    const eventsPerSecond = Math.round((eventCount / duration) * 1000);
                    log(`ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ: ${eventCount} ä¸ªäº‹ä»¶ï¼Œè€—æ—¶ ${duration}msï¼Œé€Ÿåº¦ ${eventsPerSecond} äº‹ä»¶/ç§’`, 'success');
                }
            });

            // æ‰¹é‡å‘é€äº‹ä»¶
            for (let i = 0; i < eventCount; i++) {
                eventEngine.emit('performance-test', {
                    index: i,
                    timestamp: Date.now()
                }, 'performance');
            }

            log('âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ', 'success');
        }

        function testErrorHandling() {
            log('ğŸ§ª å¼€å§‹é”™è¯¯å¤„ç†æµ‹è¯•', 'info');
            
            // æ³¨å†Œä¼šæŠ›å‡ºå¼‚å¸¸çš„å¤„ç†å™¨
            const cleanup = eventEngine.on('error-test', (event) => {
                if (event.payload.shouldError) {
                    throw new Error('æµ‹è¯•å¼‚å¸¸å¤„ç†');
                }
                log(`æ­£å¸¸å¤„ç†å™¨æ‰§è¡Œ: ${event.payload.message}`, 'success');
            });

            // å‘é€ä¼šå¯¼è‡´å¼‚å¸¸çš„äº‹ä»¶
            eventEngine.emit('error-test', {
                shouldError: true,
                message: 'è¿™åº”è¯¥å¼•å‘å¼‚å¸¸'
            }, 'error-test');

            // å‘é€æ­£å¸¸äº‹ä»¶
            setTimeout(() => {
                eventEngine.emit('error-test', {
                    shouldError: false,
                    message: 'è¿™åº”è¯¥æ­£å¸¸å¤„ç†'
                }, 'error-test');
            }, 500);

            log('âœ… é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
        }

        function testMemoryLeaks() {
            log('ğŸ§ª å¼€å§‹å†…å­˜æ³„æ¼æµ‹è¯•', 'info');
            
            const cleanupFunctions = [];
            
            // åˆ›å»ºå¤§é‡äº‹ä»¶ç›‘å¬å™¨
            for (let i = 0; i < 50; i++) {
                const cleanup = eventEngine.on('memory-test', (event) => {
                    // æ¨¡æ‹Ÿå¤„ç†å™¨
                });
                cleanupFunctions.push(cleanup);
            }

            log(`åˆ›å»ºäº† ${cleanupFunctions.length} ä¸ªäº‹ä»¶ç›‘å¬å™¨`, 'info');

            // å‘é€ä¸€äº›äº‹ä»¶
            for (let i = 0; i < 10; i++) {
                eventEngine.emit('memory-test', { index: i }, 'memory-test');
            }

            // æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
            setTimeout(() => {
                cleanupFunctions.forEach(cleanup => cleanup());
                log(`æ¸…ç†äº† ${cleanupFunctions.length} ä¸ªäº‹ä»¶ç›‘å¬å™¨`, 'warning');
                
                // å†æ¬¡å‘é€äº‹ä»¶ï¼ˆåº”è¯¥æ²¡æœ‰ç›‘å¬å™¨ï¼‰
                eventEngine.emit('memory-test', { index: 'after-cleanup' }, 'memory-test');
                
                log('âœ… å†…å­˜æ³„æ¼æµ‹è¯•å®Œæˆ', 'success');
            }, 1000);
        }

        function showStatistics() {
            log('ğŸ“Š æ˜¾ç¤ºäº‹ä»¶å¼•æ“ç»Ÿè®¡ä¿¡æ¯', 'info');
            
            const stats = eventEngine.getStatistics();
            
            log(`ğŸ“ˆ æ€»äº‹ä»¶æ•°: ${stats.totalEvents}`, 'info');
            log(`ğŸ“ˆ æ‰©å±•äº‹ä»¶æ•°: ${stats.extendedEvents}`, 'info');
            log(`ğŸ“ˆ é…ç½®äº‹ä»¶æ•°: ${stats.configEvents}`, 'info');
            log(`ğŸ“ˆ æ´»è·ƒäº‹ä»¶ç±»å‹: ${stats.activeExtendedEventTypes}`, 'info');
            log(`ğŸ“ˆ æ€»å¤„ç†å™¨æ•°: ${stats.totalExtendedHandlers}`, 'info');
            
            log('ğŸ“Š ConfigEventBus ç»Ÿè®¡:', 'info');
            log(`   - å·²å‘å‡ºäº‹ä»¶: ${stats.configEventBus.eventsEmitted}`, 'info');
            log(`   - å¤„ç†å™¨æ‰§è¡Œæ¬¡æ•°: ${stats.configEventBus.handlersExecuted}`, 'info');
            log(`   - é”™è¯¯æ¬¡æ•°: ${stats.configEventBus.errors}`, 'info');
            
            log('âœ… ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºå®Œæˆ', 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ Event Engine æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            log('ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å„ç§æµ‹è¯•', 'info');
            log('ğŸ” æ‰€æœ‰æµ‹è¯•ç»“æœå°†å®æ—¶æ˜¾ç¤ºåœ¨æ­¤æ—¥å¿—åŒºåŸŸ', 'info');
            
            // æ˜¾ç¤ºåˆå§‹ç»Ÿè®¡ä¿¡æ¯
            setTimeout(() => {
                showStatistics();
            }, 500);
        };
    </script>
</body>
</html>