<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registry Engine æµ‹è¯•æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 15px 0 0 0;
            opacity: 0.9;
            font-size: 1.2em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 700px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 25px;
            border-right: 1px solid #e0e0e0;
        }

        .content {
            padding: 25px;
        }

        .demo-section {
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .demo-header {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .demo-body {
            padding: 20px;
        }

        .demo-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            font-size: 14px;
            min-width: 120px;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
        }

        .demo-button:active {
            transform: translateY(0);
        }

        .demo-button.success {
            background: linear-gradient(45deg, #27ae60, #229954);
        }

        .demo-button.warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .demo-button.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .demo-button.info {
            background: linear-gradient(45deg, #8e44ad, #7d3c98);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            margin-top: 20px;
            border: 2px solid #333;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #333;
            animation: fadeIn 0.3s ease-in;
        }

        .log-time {
            color: #888;
            margin-right: 12px;
            font-size: 11px;
        }

        .log-level-info { color: #00ff00; }
        .log-level-warn { color: #ffff00; }
        .log-level-error { color: #ff4444; }
        .log-level-success { color: #00ffaa; }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .input-group textarea {
            height: 100px;
            resize: vertical;
            font-family: 'Consolas', monospace;
        }

        .result-display {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .result-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .result-content {
            font-family: 'Consolas', monospace;
            font-size: 12px;
            color: #555;
            white-space: pre-wrap;
        }

        .clear-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            float: right;
            margin-bottom: 10px;
        }

        .performance-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .performance-excellent { background: #27ae60; }
        .performance-good { background: #f39c12; }
        .performance-poor { background: #e74c3c; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .pulsing {
            animation: pulse 1.5s infinite;
        }

        .accordion {
            margin-top: 20px;
        }

        .accordion-item {
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .accordion-header {
            background: #f8f9fa;
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .accordion-header:hover {
            background: #e9ecef;
        }

        .accordion-content {
            display: none;
            padding: 15px;
            background: white;
        }

        .accordion-content.active {
            display: block;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Registry Engine æµ‹è¯•æ¼”ç¤º</h1>
            <p>ThingsPanel ç‰©è”ç½‘å¯è§†åŒ–å¹³å° - ç»Ÿä¸€æ³¨å†Œç®¡ç†ç³»ç»Ÿæ¼”ç¤º</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h3>ğŸ“Š å®æ—¶ç»Ÿè®¡</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalItems">0</div>
                        <div class="stat-label">æ€»æ³¨å†Œé¡¹</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="enabledItems">0</div>
                        <div class="stat-label">å¯ç”¨é¡¹ç›®</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="itemTypes">0</div>
                        <div class="stat-label">é¡¹ç›®ç±»å‹</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="performance">-</div>
                        <div class="stat-label">æ€§èƒ½æŒ‡æ ‡</div>
                    </div>
                </div>

                <h3>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h3>
                <button class="demo-button success" onclick="initializeDemo()">åˆå§‹åŒ–æ¼”ç¤º</button>
                <button class="demo-button info" onclick="runPerformanceTest()">æ€§èƒ½æµ‹è¯•</button>
                <button class="demo-button warning" onclick="runErrorTest()">é”™è¯¯æµ‹è¯•</button>
                <button class="demo-button danger" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
                <button class="clear-button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>

                <h3>ğŸ“‹ ç±»å‹åˆ†å¸ƒ</h3>
                <div id="typeDistribution"></div>

                <h3>ğŸ·ï¸ åˆ†ç±»ç»Ÿè®¡</h3>
                <div id="categoryStats"></div>
            </div>

            <div class="content">
                <div class="demo-section">
                    <div class="demo-header">
                        <span>ğŸ¯ åŸºç¡€æ³¨å†Œæ“ä½œ</span>
                    </div>
                    <div class="demo-body">
                        <p>æ¼”ç¤ºRegistry Engineçš„åŸºæœ¬æ³¨å†Œå’ŒæŸ¥è¯¢åŠŸèƒ½</p>
                        <button class="demo-button" onclick="registerBasicComponent()">æ³¨å†ŒåŸºç¡€ç»„ä»¶</button>
                        <button class="demo-button" onclick="registerWithDependencies()">æ³¨å†Œä¾èµ–ç»„ä»¶</button>
                        <button class="demo-button" onclick="queryComponents()">æŸ¥è¯¢ç»„ä»¶</button>
                        <button class="demo-button" onclick="testValidation()">éªŒè¯æµ‹è¯•</button>
                    </div>
                </div>

                <div class="demo-section">
                    <div class="demo-header">
                        <span>ğŸ“¦ æ‰¹é‡æ“ä½œæ¼”ç¤º</span>
                    </div>
                    <div class="demo-body">
                        <p>æ¼”ç¤ºå¤§é‡ç»„ä»¶çš„æ‰¹é‡æ³¨å†Œå’Œç®¡ç†</p>
                        <div class="input-group">
                            <label for="batchCount">æ‰¹é‡æ³¨å†Œæ•°é‡:</label>
                            <input type="number" id="batchCount" value="50" min="1" max="500">
                        </div>
                        <button class="demo-button" onclick="batchRegisterComponents()">æ‰¹é‡æ³¨å†Œ</button>
                        <button class="demo-button" onclick="batchQueryComponents()">æ‰¹é‡æŸ¥è¯¢</button>
                        <button class="demo-button" onclick="complexQuery()">å¤æ‚æŸ¥è¯¢</button>
                    </div>
                </div>

                <div class="demo-section">
                    <div class="demo-header">
                        <span>ğŸ”— ä¾èµ–å…³ç³»ç®¡ç†</span>
                    </div>
                    <div class="demo-body">
                        <p>æ¼”ç¤ºç»„ä»¶ä¾èµ–å…³ç³»çš„å»ºç«‹å’ŒéªŒè¯</p>
                        <button class="demo-button" onclick="createDependencyChain()">åˆ›å»ºä¾èµ–é“¾</button>
                        <button class="demo-button" onclick="validateDependencies()">éªŒè¯ä¾èµ–</button>
                        <button class="demo-button" onclick="analyzeDependencies()">ä¾èµ–åˆ†æ</button>
                        <button class="demo-button" onclick="testCircularDependency()">å¾ªç¯ä¾èµ–æµ‹è¯•</button>
                    </div>
                </div>

                <div class="demo-section">
                    <div class="demo-header">
                        <span>ğŸ› ï¸ è‡ªå®šä¹‰ç»„ä»¶æµ‹è¯•</span>
                    </div>
                    <div class="demo-body">
                        <div class="input-group">
                            <label for="customId">ç»„ä»¶ID:</label>
                            <input type="text" id="customId" placeholder="ä¾‹: my-weather-widget" value="my-weather-widget">
                        </div>
                        <div class="input-group">
                            <label for="customName">ç»„ä»¶åç§°:</label>
                            <input type="text" id="customName" placeholder="ä¾‹: å¤©æ°”ç»„ä»¶" value="å¤©æ°”ç»„ä»¶">
                        </div>
                        <div class="input-group">
                            <label for="customType">ç»„ä»¶ç±»å‹:</label>
                            <select id="customType">
                                <option value="card21-component">Card2.1ç»„ä»¶</option>
                                <option value="legacy-card-component">ä¼ ç»ŸCardç»„ä»¶</option>
                                <option value="visual-editor-component">å¯è§†åŒ–ç¼–è¾‘å™¨ç»„ä»¶</option>
                                <option value="renderer">æ¸²æŸ“å™¨</option>
                                <option value="data-source">æ•°æ®æº</option>
                                <option value="template">æ¨¡æ¿</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="customContent">ç»„ä»¶å†…å®¹ (JSON):</label>
                            <textarea id="customContent" placeholder='{"type": "weather-widget", "config": {}}'>{
  "type": "weather-widget",
  "dataSources": [
    {
      "key": "weather",
      "type": "api",
      "url": "/api/weather"
    }
  ],
  "staticParams": {
    "refreshInterval": 300000,
    "showForecast": true
  }
}</textarea>
                        </div>
                        <button class="demo-button" onclick="registerCustomComponent()">æ³¨å†Œè‡ªå®šä¹‰ç»„ä»¶</button>
                        <button class="demo-button" onclick="queryCustomComponent()">æŸ¥è¯¢è‡ªå®šä¹‰ç»„ä»¶</button>
                    </div>
                </div>

                <div class="demo-section">
                    <div class="demo-header">
                        <span>ğŸ“ˆ ç»“æœå±•ç¤º</span>
                    </div>
                    <div class="demo-body">
                        <div class="result-display" id="resultDisplay"></div>
                    </div>
                </div>

                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-time">[ç³»ç»Ÿ]</span>
                        <span class="log-level-info">Registry Engine æ¼”ç¤ºç³»ç»Ÿå·²å¯åŠ¨</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸRegistry EngineåŠŸèƒ½
        class DemoRegistryEngine {
            constructor() {
                this.items = new Map()
                this.typeIndex = new Map()
                this.categoryIndex = new Map()
                this.tagIndex = new Map()
                this.dependencyGraph = new Map()
                this.reverseDependencyGraph = new Map()
                this.performanceData = []
                this.eventListeners = new Map()
            }

            async register(item) {
                const startTime = performance.now()

                try {
                    // éªŒè¯å¿…éœ€å­—æ®µ
                    if (!item.metadata.id || !item.metadata.name || !item.metadata.type) {
                        throw new Error('ç¼ºå°‘å¿…éœ€çš„å…ƒæ•°æ®å­—æ®µ')
                    }

                    // æ£€æŸ¥IDå”¯ä¸€æ€§
                    if (this.items.has(item.metadata.id)) {
                        throw new Error(`é¡¹ç›® ${item.metadata.id} å·²å­˜åœ¨`)
                    }

                    // æ‰§è¡ŒéªŒè¯
                    if (item.validate && !await item.validate()) {
                        throw new Error('é¡¹ç›®éªŒè¯å¤±è´¥')
                    }

                    // å­˜å‚¨é¡¹ç›®
                    this.items.set(item.metadata.id, item)

                    // æ›´æ–°ç´¢å¼•
                    this.updateIndexes(item.metadata, 'add')

                    // æ‰§è¡Œåˆå§‹åŒ–
                    if (item.initialize) {
                        await item.initialize()
                    }

                    const duration = performance.now() - startTime
                    this.performanceData.push(duration)
                    if (this.performanceData.length > 100) {
                        this.performanceData.shift()
                    }

                    this.emit('register', item.metadata)

                    logMessage(`âœ… æˆåŠŸæ³¨å†Œ: ${item.metadata.type}/${item.metadata.id}`, 'success')
                    return true

                } catch (error) {
                    logMessage(`âŒ æ³¨å†Œå¤±è´¥: ${error.message}`, 'error')
                    this.emit('error', { action: 'register', error, metadata: item.metadata })
                    return false
                }
            }

            async unregister(id) {
                try {
                    const item = this.items.get(id)
                    if (!item) {
                        logMessage(`âš ï¸ é¡¹ç›® ${id} ä¸å­˜åœ¨`, 'warn')
                        return false
                    }

                    // æ‰§è¡Œæ¸…ç†
                    if (item.cleanup) {
                        await item.cleanup()
                    }

                    // æ›´æ–°ç´¢å¼•
                    this.updateIndexes(item.metadata, 'remove')

                    // åˆ é™¤é¡¹ç›®
                    this.items.delete(id)

                    this.emit('unregister', id)
                    logMessage(`ğŸ—‘ï¸ æˆåŠŸæ³¨é”€: ${id}`, 'info')
                    return true

                } catch (error) {
                    logMessage(`âŒ æ³¨é”€å¤±è´¥: ${error.message}`, 'error')
                    return false
                }
            }

            get(id) {
                return this.items.get(id) || null
            }

            has(id) {
                return this.items.has(id)
            }

            query(conditions = {}) {
                let results = Array.from(this.items.values())

                if (conditions.type) {
                    const types = Array.isArray(conditions.type) ? conditions.type : [conditions.type]
                    results = results.filter(item => types.includes(item.metadata.type))
                }

                if (conditions.enabled !== undefined) {
                    results = results.filter(item => item.metadata.enabled === conditions.enabled)
                }

                if (conditions.category) {
                    results = results.filter(item => item.metadata.category === conditions.category)
                }

                if (conditions.tags) {
                    results = results.filter(item => {
                        if (!item.metadata.tags) return false
                        return conditions.tags.every(tag => item.metadata.tags.includes(tag))
                    })
                }

                if (conditions.filter) {
                    results = results.filter(conditions.filter)
                }

                return results
            }

            getByType(type) {
                const ids = this.typeIndex.get(type)
                if (!ids) return []
                return Array.from(ids).map(id => this.items.get(id)).filter(Boolean)
            }

            getByCategory(category) {
                const ids = this.categoryIndex.get(category)
                if (!ids) return []
                return Array.from(ids).map(id => this.items.get(id)).filter(Boolean)
            }

            getByTag(tag) {
                const ids = this.tagIndex.get(tag)
                if (!ids) return []
                return Array.from(ids).map(id => this.items.get(id)).filter(Boolean)
            }

            getDependencies(id, recursive = false) {
                const direct = this.dependencyGraph.get(id)
                if (!direct) return []

                if (!recursive) {
                    return Array.from(direct)
                }

                const allDeps = new Set()
                const visited = new Set()

                const collectDeps = (itemId) => {
                    if (visited.has(itemId)) return
                    visited.add(itemId)

                    const deps = this.dependencyGraph.get(itemId)
                    if (deps) {
                        for (const dep of deps) {
                            allDeps.add(dep)
                            collectDeps(dep)
                        }
                    }
                }

                collectDeps(id)
                return Array.from(allDeps)
            }

            getDependents(id, recursive = false) {
                const direct = this.reverseDependencyGraph.get(id)
                if (!direct) return []

                if (!recursive) {
                    return Array.from(direct)
                }

                const allDependents = new Set()
                const visited = new Set()

                const collectDependents = (itemId) => {
                    if (visited.has(itemId)) return
                    visited.add(itemId)

                    const dependents = this.reverseDependencyGraph.get(itemId)
                    if (dependents) {
                        for (const dependent of dependents) {
                            allDependents.add(dependent)
                            collectDependents(dependent)
                        }
                    }
                }

                collectDependents(id)
                return Array.from(allDependents)
            }

            getStats() {
                const items = Array.from(this.items.values())
                const byType = {}
                const byCategory = {}
                let enabled = 0
                let withDependencies = 0
                let lastUpdated = 0

                for (const item of items) {
                    const { metadata } = item

                    byType[metadata.type] = (byType[metadata.type] || 0) + 1

                    if (metadata.category) {
                        byCategory[metadata.category] = (byCategory[metadata.category] || 0) + 1
                    }

                    if (metadata.enabled) enabled++
                    if (metadata.dependencies && metadata.dependencies.length > 0) withDependencies++
                    if (metadata.updatedAt > lastUpdated) lastUpdated = metadata.updatedAt
                }

                return {
                    total: items.length,
                    byType,
                    byCategory,
                    enabled,
                    disabled: items.length - enabled,
                    withDependencies,
                    lastUpdated
                }
            }

            getAll() {
                return Array.from(this.items.values())
            }

            async clear() {
                const items = Array.from(this.items.values())
                for (const item of items) {
                    await this.unregister(item.metadata.id)
                }

                this.items.clear()
                this.typeIndex.clear()
                this.categoryIndex.clear()
                this.tagIndex.clear()
                this.dependencyGraph.clear()
                this.reverseDependencyGraph.clear()

                this.emit('clear')
                logMessage('ğŸ§¹ å·²æ¸…ç©ºæ‰€æœ‰æ³¨å†Œé¡¹', 'info')
            }

            getAveragePerformance() {
                if (this.performanceData.length === 0) return 0
                return this.performanceData.reduce((a, b) => a + b, 0) / this.performanceData.length
            }

            updateIndexes(metadata, action) {
                const { id, type, category, tags, dependencies } = metadata

                // ç±»å‹ç´¢å¼•
                if (action === 'add') {
                    if (!this.typeIndex.has(type)) {
                        this.typeIndex.set(type, new Set())
                    }
                    this.typeIndex.get(type).add(id)
                } else {
                    const typeSet = this.typeIndex.get(type)
                    if (typeSet) {
                        typeSet.delete(id)
                        if (typeSet.size === 0) {
                            this.typeIndex.delete(type)
                        }
                    }
                }

                // åˆ†ç±»ç´¢å¼•
                if (category) {
                    if (action === 'add') {
                        if (!this.categoryIndex.has(category)) {
                            this.categoryIndex.set(category, new Set())
                        }
                        this.categoryIndex.get(category).add(id)
                    } else {
                        const categorySet = this.categoryIndex.get(category)
                        if (categorySet) {
                            categorySet.delete(id)
                            if (categorySet.size === 0) {
                                this.categoryIndex.delete(category)
                            }
                        }
                    }
                }

                // æ ‡ç­¾ç´¢å¼•
                if (tags) {
                    for (const tag of tags) {
                        if (action === 'add') {
                            if (!this.tagIndex.has(tag)) {
                                this.tagIndex.set(tag, new Set())
                            }
                            this.tagIndex.get(tag).add(id)
                        } else {
                            const tagSet = this.tagIndex.get(tag)
                            if (tagSet) {
                                tagSet.delete(id)
                                if (tagSet.size === 0) {
                                    this.tagIndex.delete(tag)
                                }
                            }
                        }
                    }
                }

                // ä¾èµ–å…³ç³»
                if (dependencies && dependencies.length > 0) {
                    if (action === 'add') {
                        this.dependencyGraph.set(id, new Set(dependencies))
                        for (const depId of dependencies) {
                            if (!this.reverseDependencyGraph.has(depId)) {
                                this.reverseDependencyGraph.set(depId, new Set())
                            }
                            this.reverseDependencyGraph.get(depId).add(id)
                        }
                    } else {
                        this.dependencyGraph.delete(id)
                        for (const depId of dependencies) {
                            const reverseSet = this.reverseDependencyGraph.get(depId)
                            if (reverseSet) {
                                reverseSet.delete(id)
                                if (reverseSet.size === 0) {
                                    this.reverseDependencyGraph.delete(depId)
                                }
                            }
                        }
                    }
                }
            }

            on(event, handler) {
                if (!this.eventListeners.has(event)) {
                    this.eventListeners.set(event, new Set())
                }
                this.eventListeners.get(event).add(handler)

                return () => {
                    const handlers = this.eventListeners.get(event)
                    if (handlers) {
                        handlers.delete(handler)
                        if (handlers.size === 0) {
                            this.eventListeners.delete(event)
                        }
                    }
                }
            }

            emit(event, data) {
                const handlers = this.eventListeners.get(event)
                if (handlers) {
                    for (const handler of handlers) {
                        try {
                            handler(data)
                        } catch (error) {
                            console.error('Event handler error:', error)
                        }
                    }
                }
            }
        }

        // åˆ›å»ºæ¼”ç¤ºå®ä¾‹
        const registryEngine = new DemoRegistryEngine()

        // æ—¥å¿—ç³»ç»Ÿ
        function logMessage(message, level = 'info', data = null) {
            const logContainer = document.getElementById('logContainer')
            const logEntry = document.createElement('div')
            logEntry.className = 'log-entry'

            const now = new Date()
            const timeStr = now.toLocaleTimeString()

            let logHtml = `<span class="log-time">[${timeStr}]</span>`
            logHtml += `<span class="log-level-${level}">${message}</span>`

            if (data && typeof data === 'object') {
                logHtml += `<br><span style="color: #888; font-size: 11px; margin-left: 60px;">æ•°æ®: ${JSON.stringify(data, null, 2)}</span>`
            }

            logEntry.innerHTML = logHtml
            logContainer.appendChild(logEntry)
            logContainer.scrollTop = logContainer.scrollHeight

            // é™åˆ¶æ—¥å¿—æ¡æ•°
            while (logContainer.children.length > 150) {
                logContainer.removeChild(logContainer.firstChild)
            }

            // æ·»åŠ é«˜äº®æ•ˆæœ
            logEntry.classList.add('pulsing')
            setTimeout(() => {
                logEntry.classList.remove('pulsing')
            }, 1500)
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = ''
            logMessage('æ—¥å¿—å·²æ¸…ç©º', 'info')
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const stats = registryEngine.getStats()
            const avgPerformance = registryEngine.getAveragePerformance()

            document.getElementById('totalItems').textContent = stats.total
            document.getElementById('enabledItems').textContent = stats.enabled
            document.getElementById('itemTypes').textContent = Object.keys(stats.byType).length

            const perfElement = document.getElementById('performance')
            if (avgPerformance > 0) {
                perfElement.textContent = avgPerformance.toFixed(2) + 'ms'

                // æ€§èƒ½æŒ‡ç¤ºå™¨
                perfElement.className = 'stat-value'
                if (avgPerformance < 1) {
                    perfElement.innerHTML += '<span class="performance-indicator performance-excellent"></span>'
                } else if (avgPerformance < 5) {
                    perfElement.innerHTML += '<span class="performance-indicator performance-good"></span>'
                } else {
                    perfElement.innerHTML += '<span class="performance-indicator performance-poor"></span>'
                }
            }

            // æ›´æ–°ç±»å‹åˆ†å¸ƒ
            const typeDistribution = document.getElementById('typeDistribution')
            typeDistribution.innerHTML = ''
            for (const [type, count] of Object.entries(stats.byType)) {
                const item = document.createElement('div')
                item.style.cssText = 'padding: 5px; margin: 2px 0; background: #e9ecef; border-radius: 3px; font-size: 12px;'
                item.textContent = `${type}: ${count}`
                typeDistribution.appendChild(item)
            }

            // æ›´æ–°åˆ†ç±»ç»Ÿè®¡
            const categoryStats = document.getElementById('categoryStats')
            categoryStats.innerHTML = ''
            for (const [category, count] of Object.entries(stats.byCategory)) {
                const item = document.createElement('div')
                item.style.cssText = 'padding: 5px; margin: 2px 0; background: #d1ecf1; border-radius: 3px; font-size: 12px;'
                item.textContent = `${category}: ${count}`
                categoryStats.appendChild(item)
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(title, content) {
            const resultDisplay = document.getElementById('resultDisplay')

            const resultItem = document.createElement('div')
            resultItem.className = 'result-item'

            const titleElement = document.createElement('div')
            titleElement.className = 'result-title'
            titleElement.textContent = title

            const contentElement = document.createElement('div')
            contentElement.className = 'result-content'
            contentElement.textContent = typeof content === 'string' ? content : JSON.stringify(content, null, 2)

            resultItem.appendChild(titleElement)
            resultItem.appendChild(contentElement)
            resultDisplay.appendChild(resultItem)

            // é™åˆ¶æ˜¾ç¤ºæ¡æ•°
            while (resultDisplay.children.length > 10) {
                resultDisplay.removeChild(resultDisplay.firstChild)
            }
        }

        // æ¼”ç¤ºå‡½æ•°
        async function initializeDemo() {
            logMessage('ğŸš€ åˆå§‹åŒ–æ¼”ç¤ºæ•°æ®...', 'info')

            // æ³¨å†Œä¸€äº›åŸºç¡€ç»„ä»¶
            const basicComponents = [
                {
                    metadata: {
                        id: 'temperature-sensor',
                        name: 'æ¸©åº¦ä¼ æ„Ÿå™¨',
                        type: 'card21-component',
                        version: '1.0.0',
                        description: 'ç”¨äºæ˜¾ç¤ºæ¸©åº¦æ•°æ®çš„ä¼ æ„Ÿå™¨ç»„ä»¶',
                        category: 'sensors',
                        tags: ['sensor', 'temperature', 'iot'],
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        enabled: true,
                        priority: 10
                    },
                    content: {
                        type: 'temperature-sensor',
                        dataSources: [{ key: 'temp', type: 'device' }]
                    }
                },
                {
                    metadata: {
                        id: 'humidity-sensor',
                        name: 'æ¹¿åº¦ä¼ æ„Ÿå™¨',
                        type: 'card21-component',
                        version: '1.0.0',
                        category: 'sensors',
                        tags: ['sensor', 'humidity', 'iot'],
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        enabled: true,
                        priority: 10
                    },
                    content: {
                        type: 'humidity-sensor',
                        dataSources: [{ key: 'humidity', type: 'device' }]
                    }
                },
                {
                    metadata: {
                        id: 'chart-renderer',
                        name: 'å›¾è¡¨æ¸²æŸ“å™¨',
                        type: 'renderer',
                        version: '2.0.0',
                        category: 'visualization',
                        tags: ['chart', 'renderer', 'visualization'],
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        enabled: true,
                        priority: 20
                    },
                    content: {
                        type: 'chart-renderer',
                        supportedCharts: ['line', 'bar', 'pie']
                    }
                }
            ]

            for (const component of basicComponents) {
                await registryEngine.register(component)
            }

            updateStats()
            logMessage('âœ… æ¼”ç¤ºæ•°æ®åˆå§‹åŒ–å®Œæˆ', 'success')
        }

        async function registerBasicComponent() {
            const component = {
                metadata: {
                    id: 'demo-component-' + Date.now(),
                    name: 'æ¼”ç¤ºç»„ä»¶',
                    type: 'card21-component',
                    version: '1.0.0',
                    description: 'è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºç”¨çš„åŸºç¡€ç»„ä»¶',
                    category: 'demo',
                    tags: ['demo', 'test'],
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    enabled: true,
                    priority: 5
                },
                content: {
                    type: 'demo-component',
                    config: { demo: true }
                },
                validate: () => {
                    logMessage('ğŸ” æ‰§è¡Œç»„ä»¶éªŒè¯...', 'info')
                    return true
                },
                initialize: async () => {
                    logMessage('ğŸš€ æ‰§è¡Œç»„ä»¶åˆå§‹åŒ–...', 'info')
                }
            }

            const success = await registryEngine.register(component)
            updateStats()

            if (success) {
                displayResult('åŸºç¡€ç»„ä»¶æ³¨å†Œ', component.metadata)
            }
        }

        async function registerWithDependencies() {
            // å…ˆæ³¨å†Œä¾èµ–ç»„ä»¶
            const dependency = {
                metadata: {
                    id: 'data-service',
                    name: 'æ•°æ®æœåŠ¡',
                    type: 'data-source',
                    version: '1.0.0',
                    category: 'service',
                    tags: ['service', 'data'],
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    enabled: true,
                    priority: 100
                },
                content: { type: 'data-service' }
            }

            await registryEngine.register(dependency)

            // æ³¨å†Œæœ‰ä¾èµ–çš„ç»„ä»¶
            const dependentComponent = {
                metadata: {
                    id: 'chart-with-data',
                    name: 'æ•°æ®å›¾è¡¨',
                    type: 'card21-component',
                    version: '1.0.0',
                    category: 'visualization',
                    tags: ['chart', 'data'],
                    dependencies: ['data-service'],
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    enabled: true,
                    priority: 50
                },
                content: {
                    type: 'chart-with-data',
                    dataSources: [{ key: 'chartData', service: 'data-service' }]
                }
            }

            const success = await registryEngine.register(dependentComponent)
            updateStats()

            if (success) {
                displayResult('ä¾èµ–ç»„ä»¶æ³¨å†Œ', {
                    component: dependentComponent.metadata,
                    dependencies: registryEngine.getDependencies('chart-with-data')
                })
            }
        }

        function queryComponents() {
            const sensorComponents = registryEngine.query({
                type: 'card21-component',
                tags: ['sensor']
            })

            const allComponents = registryEngine.getAll()

            displayResult('ç»„ä»¶æŸ¥è¯¢ç»“æœ', {
                ä¼ æ„Ÿå™¨ç»„ä»¶æ•°é‡: sensorComponents.length,
                æ€»ç»„ä»¶æ•°: allComponents.length,
                ä¼ æ„Ÿå™¨ç»„ä»¶: sensorComponents.map(c => c.metadata.name)
            })

            logMessage(`ğŸ“Š æŸ¥è¯¢å®Œæˆ: æ‰¾åˆ° ${sensorComponents.length} ä¸ªä¼ æ„Ÿå™¨ç»„ä»¶`, 'info')
        }

        async function testValidation() {
            // æµ‹è¯•éªŒè¯å¤±è´¥çš„ç»„ä»¶
            const invalidComponent = {
                metadata: {
                    id: 'invalid-component',
                    name: '',  // ç©ºåç§°
                    type: 'card21-component',
                    version: '',
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    enabled: true,
                    priority: 0
                },
                content: {},
                validate: () => {
                    logMessage('âŒ ç»„ä»¶éªŒè¯å¤±è´¥', 'error')
                    return false
                }
            }

            const result = await registryEngine.register(invalidComponent)
            updateStats()

            displayResult('éªŒè¯æµ‹è¯•ç»“æœ', {
                æ³¨å†Œç»“æœ: result ? 'æˆåŠŸ' : 'å¤±è´¥ï¼ˆé¢„æœŸï¼‰',
                éªŒè¯åŠŸèƒ½: 'æ­£å¸¸å·¥ä½œ'
            })
        }

        async function batchRegisterComponents() {
            const count = parseInt(document.getElementById('batchCount').value) || 50
            logMessage(`ğŸ“¦ å¼€å§‹æ‰¹é‡æ³¨å†Œ ${count} ä¸ªç»„ä»¶...`, 'info')

            const startTime = performance.now()
            const promises = []

            for (let i = 0; i < count; i++) {
                const component = {
                    metadata: {
                        id: `batch-component-${i}`,
                        name: `æ‰¹é‡ç»„ä»¶ ${i}`,
                        type: 'card21-component',
                        version: '1.0.0',
                        category: i % 3 === 0 ? 'sensors' : i % 3 === 1 ? 'controls' : 'displays',
                        tags: ['batch', 'test', `group-${Math.floor(i / 10)}`],
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        enabled: Math.random() > 0.1,
                        priority: Math.floor(Math.random() * 100)
                    },
                    content: {
                        type: `batch-component-${i}`,
                        index: i,
                        data: Math.random() * 100
                    }
                }

                promises.push(registryEngine.register(component))
            }

            const results = await Promise.all(promises)
            const duration = performance.now() - startTime
            const successCount = results.filter(r => r).length

            updateStats()

            displayResult('æ‰¹é‡æ³¨å†Œç»“æœ', {
                æ€»æ•°: count,
                æˆåŠŸ: successCount,
                å¤±è´¥: count - successCount,
                è€—æ—¶: `${duration.toFixed(2)}ms`,
                å¹³å‡è€—æ—¶: `${(duration / count).toFixed(2)}ms/ä¸ª`
            })

            logMessage(`âœ… æ‰¹é‡æ³¨å†Œå®Œæˆ: ${successCount}/${count} æˆåŠŸ`, 'success')
        }

        function batchQueryComponents() {
            const startTime = performance.now()

            const sensorComponents = registryEngine.query({
                category: 'sensors',
                enabled: true
            })

            const batchComponents = registryEngine.query({
                tags: ['batch']
            })

            const duration = performance.now() - startTime

            displayResult('æ‰¹é‡æŸ¥è¯¢ç»“æœ', {
                ä¼ æ„Ÿå™¨ç»„ä»¶: sensorComponents.length,
                æ‰¹é‡ç»„ä»¶: batchComponents.length,
                æŸ¥è¯¢è€—æ—¶: `${duration.toFixed(2)}ms`
            })

            logMessage(`ğŸ” æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼Œè€—æ—¶ ${duration.toFixed(2)}ms`, 'info')
        }

        function complexQuery() {
            const startTime = performance.now()

            const complexResults = registryEngine.query({
                type: 'card21-component',
                enabled: true,
                filter: (item) => {
                    return item.metadata.priority > 20 &&
                           item.metadata.tags &&
                           item.metadata.tags.length >= 2 &&
                           item.metadata.name.includes('ç»„ä»¶')
                }
            })

            const duration = performance.now() - startTime

            displayResult('å¤æ‚æŸ¥è¯¢ç»“æœ', {
                åŒ¹é…æ¡ä»¶: 'ç±»å‹=card21-component, å¯ç”¨=true, ä¼˜å…ˆçº§>20, æ ‡ç­¾>=2ä¸ª, åç§°åŒ…å«"ç»„ä»¶"',
                ç»“æœæ•°é‡: complexResults.length,
                æŸ¥è¯¢è€—æ—¶: `${duration.toFixed(2)}ms`,
                åŒ¹é…ç»„ä»¶: complexResults.map(c => ({
                    åç§°: c.metadata.name,
                    ä¼˜å…ˆçº§: c.metadata.priority,
                    æ ‡ç­¾æ•°: c.metadata.tags ? c.metadata.tags.length : 0
                }))
            })

            logMessage(`ğŸ¯ å¤æ‚æŸ¥è¯¢å®Œæˆ: æ‰¾åˆ° ${complexResults.length} ä¸ªåŒ¹é…ç»„ä»¶`, 'info')
        }

        async function createDependencyChain() {
            logMessage('ğŸ”— åˆ›å»ºä¾èµ–é“¾...', 'info')

            // åˆ›å»ºä¾èµ–é“¾: A -> B -> C
            const componentA = {
                metadata: {
                    id: 'component-a',
                    name: 'ç»„ä»¶Aï¼ˆåŸºç¡€æœåŠ¡ï¼‰',
                    type: 'data-source',
                    version: '1.0.0',
                    category: 'foundation',
                    tags: ['foundation', 'service'],
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    enabled: true,
                    priority: 100
                },
                content: { level: 'foundation' }
            }

            const componentB = {
                metadata: {
                    id: 'component-b',
                    name: 'ç»„ä»¶Bï¼ˆä¸­é—´å±‚ï¼‰',
                    type: 'renderer',
                    version: '1.0.0',
                    category: 'middleware',
                    tags: ['middleware', 'processor'],
                    dependencies: ['component-a'],
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    enabled: true,
                    priority: 50
                },
                content: { level: 'middleware' }
            }

            const componentC = {
                metadata: {
                    id: 'component-c',
                    name: 'ç»„ä»¶Cï¼ˆåº”ç”¨å±‚ï¼‰',
                    type: 'card21-component',
                    version: '1.0.0',
                    category: 'application',
                    tags: ['application', 'ui'],
                    dependencies: ['component-b'],
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    enabled: true,
                    priority: 10
                },
                content: { level: 'application' }
            }

            await registryEngine.register(componentA)
            await registryEngine.register(componentB)
            await registryEngine.register(componentC)

            updateStats()

            const cDependencies = registryEngine.getDependencies('component-c', true)
            const aDependents = registryEngine.getDependents('component-a', true)

            displayResult('ä¾èµ–é“¾åˆ›å»ºç»“æœ', {
                ä¾èµ–é“¾: 'A <- B <- C',
                ç»„ä»¶Cçš„æ‰€æœ‰ä¾èµ–: cDependencies,
                ç»„ä»¶Açš„æ‰€æœ‰ä¾èµ–è€…: aDependents
            })

            logMessage('âœ… ä¾èµ–é“¾åˆ›å»ºå®Œæˆ', 'success')
        }

        function validateDependencies() {
            const allItems = registryEngine.getAll()
            const missingDependencies = []

            for (const item of allItems) {
                if (item.metadata.dependencies) {
                    const missing = item.metadata.dependencies.filter(depId => !registryEngine.has(depId))
                    if (missing.length > 0) {
                        missingDependencies.push({
                            component: item.metadata.id,
                            missing: missing
                        })
                    }
                }
            }

            const isValid = missingDependencies.length === 0

            displayResult('ä¾èµ–éªŒè¯ç»“æœ', {
                éªŒè¯çŠ¶æ€: isValid ? 'âœ… æ‰€æœ‰ä¾èµ–å®Œæ•´' : 'âŒ å­˜åœ¨ç¼ºå¤±ä¾èµ–',
                ç¼ºå¤±ä¾èµ–: missingDependencies
            })

            if (isValid) {
                logMessage('âœ… ä¾èµ–éªŒè¯é€šè¿‡', 'success')
            } else {
                logMessage(`âš ï¸ å‘ç° ${missingDependencies.length} ä¸ªä¾èµ–é—®é¢˜`, 'warn')
            }
        }

        function analyzeDependencies() {
            const allItems = registryEngine.getAll()
            const dependencyAnalysis = {}

            for (const item of allItems) {
                const dependencies = registryEngine.getDependencies(item.metadata.id, false)
                const dependents = registryEngine.getDependents(item.metadata.id, false)

                dependencyAnalysis[item.metadata.id] = {
                    name: item.metadata.name,
                    directDependencies: dependencies.length,
                    directDependents: dependents.length,
                    dependencies: dependencies,
                    dependents: dependents
                }
            }

            displayResult('ä¾èµ–å…³ç³»åˆ†æ', dependencyAnalysis)
            logMessage('ğŸ“Š ä¾èµ–å…³ç³»åˆ†æå®Œæˆ', 'info')
        }

        async function testCircularDependency() {
            logMessage('ğŸ”„ æµ‹è¯•å¾ªç¯ä¾èµ–æ£€æµ‹...', 'warn')

            try {
                // å°è¯•åˆ›å»ºå¾ªç¯ä¾èµ– X -> Y -> X
                const componentX = {
                    metadata: {
                        id: 'component-x',
                        name: 'ç»„ä»¶X',
                        type: 'card21-component',
                        version: '1.0.0',
                        dependencies: ['component-y'],  // ä¾èµ–Y
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        enabled: true,
                        priority: 10
                    },
                    content: { circular: true }
                }

                const componentY = {
                    metadata: {
                        id: 'component-y',
                        name: 'ç»„ä»¶Y',
                        type: 'card21-component',
                        version: '1.0.0',
                        dependencies: ['component-x'],  // ä¾èµ–Xï¼Œå½¢æˆå¾ªç¯
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        enabled: true,
                        priority: 10
                    },
                    content: { circular: true }
                }

                // å…ˆæ³¨å†ŒXï¼ˆYä¸å­˜åœ¨ï¼Œåº”è¯¥æœ‰è­¦å‘Šä½†èƒ½æˆåŠŸï¼‰
                await registryEngine.register(componentX)

                // å†æ³¨å†ŒYï¼ˆä¼šå½¢æˆå¾ªç¯ä¾èµ–ï¼‰
                await registryEngine.register(componentY)

                updateStats()

                displayResult('å¾ªç¯ä¾èµ–æµ‹è¯•', {
                    ç»“æœ: 'å¾ªç¯ä¾èµ–å·²åˆ›å»ºï¼ˆæ¼”ç¤ºç”¨é€”ï¼‰',
                    ç»„ä»¶Xä¾èµ–: registryEngine.getDependencies('component-x'),
                    ç»„ä»¶Yä¾èµ–: registryEngine.getDependencies('component-y'),
                    æ³¨æ„: 'å®é™…ç³»ç»Ÿä¸­åº”è¯¥æ£€æµ‹å¹¶é˜»æ­¢å¾ªç¯ä¾èµ–'
                })

                logMessage('âš ï¸ å¾ªç¯ä¾èµ–æµ‹è¯•å®Œæˆï¼ˆä»…æ¼”ç¤ºï¼‰', 'warn')

            } catch (error) {
                logMessage(`âŒ å¾ªç¯ä¾èµ–æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
            }
        }

        async function registerCustomComponent() {
            const id = document.getElementById('customId').value.trim()
            const name = document.getElementById('customName').value.trim()
            const type = document.getElementById('customType').value
            const contentStr = document.getElementById('customContent').value.trim()

            if (!id || !name || !contentStr) {
                logMessage('âŒ è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ', 'error')
                return
            }

            try {
                const content = JSON.parse(contentStr)

                const component = {
                    metadata: {
                        id: id,
                        name: name,
                        type: type,
                        version: '1.0.0',
                        description: `è‡ªå®šä¹‰${name}ç»„ä»¶`,
                        category: 'custom',
                        tags: ['custom', 'user-defined'],
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        enabled: true,
                        priority: 20
                    },
                    content: content,
                    validate: () => {
                        logMessage('ğŸ” éªŒè¯è‡ªå®šä¹‰ç»„ä»¶...', 'info')
                        return true
                    },
                    initialize: async () => {
                        logMessage('ğŸš€ åˆå§‹åŒ–è‡ªå®šä¹‰ç»„ä»¶...', 'info')
                    }
                }

                const success = await registryEngine.register(component)
                updateStats()

                if (success) {
                    displayResult('è‡ªå®šä¹‰ç»„ä»¶æ³¨å†Œ', component.metadata)
                    logMessage(`âœ… è‡ªå®šä¹‰ç»„ä»¶ ${name} æ³¨å†ŒæˆåŠŸ`, 'success')
                }

            } catch (error) {
                logMessage(`âŒ JSONè§£æé”™è¯¯: ${error.message}`, 'error')
            }
        }

        function queryCustomComponent() {
            const id = document.getElementById('customId').value.trim()

            if (!id) {
                logMessage('âŒ è¯·è¾“å…¥ç»„ä»¶ID', 'error')
                return
            }

            const component = registryEngine.get(id)

            if (component) {
                displayResult('è‡ªå®šä¹‰ç»„ä»¶æŸ¥è¯¢', {
                    æ‰¾åˆ°ç»„ä»¶: true,
                    ç»„ä»¶ä¿¡æ¯: component.metadata,
                    ç»„ä»¶å†…å®¹: component.content
                })
                logMessage(`âœ… æ‰¾åˆ°ç»„ä»¶: ${component.metadata.name}`, 'success')
            } else {
                displayResult('è‡ªå®šä¹‰ç»„ä»¶æŸ¥è¯¢', {
                    æ‰¾åˆ°ç»„ä»¶: false,
                    æŸ¥è¯¢ID: id
                })
                logMessage(`âš ï¸ æœªæ‰¾åˆ°ç»„ä»¶: ${id}`, 'warn')
            }
        }

        async function runPerformanceTest() {
            logMessage('âš¡ å¼€å§‹æ€§èƒ½æµ‹è¯•...', 'info')

            const testSizes = [10, 50, 100, 200]
            const results = []

            for (const size of testSizes) {
                // æ³¨å†Œæ€§èƒ½æµ‹è¯•
                const startTime = performance.now()
                const promises = []

                for (let i = 0; i < size; i++) {
                    const component = {
                        metadata: {
                            id: `perf-test-${size}-${i}`,
                            name: `æ€§èƒ½æµ‹è¯•ç»„ä»¶ ${i}`,
                            type: 'card21-component',
                            version: '1.0.0',
                            category: 'performance',
                            tags: ['performance', 'test'],
                            createdAt: Date.now(),
                            updatedAt: Date.now(),
                            enabled: true,
                            priority: Math.random() * 100
                        },
                        content: { perfTest: true, index: i }
                    }
                    promises.push(registryEngine.register(component))
                }

                await Promise.all(promises)
                const registerTime = performance.now() - startTime

                // æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
                const queryStart = performance.now()
                const queryResults = registryEngine.query({
                    category: 'performance',
                    tags: ['test']
                })
                const queryTime = performance.now() - queryStart

                results.push({
                    size: size,
                    registerTime: registerTime.toFixed(2),
                    queryTime: queryTime.toFixed(2),
                    avgRegisterTime: (registerTime / size).toFixed(3),
                    queryResults: queryResults.length
                })

                logMessage(`ğŸ“Š æµ‹è¯• ${size} ä¸ªç»„ä»¶: æ³¨å†Œ ${registerTime.toFixed(2)}ms, æŸ¥è¯¢ ${queryTime.toFixed(2)}ms`, 'info')
            }

            updateStats()

            displayResult('æ€§èƒ½æµ‹è¯•ç»“æœ', {
                æµ‹è¯•è§„æ¨¡: testSizes,
                è¯¦ç»†ç»“æœ: results,
                æ€»ä½“æ€§èƒ½: registryEngine.getAveragePerformance().toFixed(2) + 'ms/æ“ä½œ'
            })

            logMessage('âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ', 'success')
        }

        async function runErrorTest() {
            logMessage('ğŸ› å¼€å§‹é”™è¯¯å¤„ç†æµ‹è¯•...', 'warn')

            const errorTests = [
                {
                    name: 'é‡å¤IDæ³¨å†Œ',
                    test: async () => {
                        const comp1 = {
                            metadata: {
                                id: 'duplicate-test',
                                name: 'é‡å¤æµ‹è¯•1',
                                type: 'card21-component',
                                version: '1.0.0',
                                createdAt: Date.now(),
                                updatedAt: Date.now(),
                                enabled: true,
                                priority: 10
                            },
                            content: {}
                        }

                        const comp2 = { ...comp1, metadata: { ...comp1.metadata, name: 'é‡å¤æµ‹è¯•2' } }

                        const result1 = await registryEngine.register(comp1)
                        const result2 = await registryEngine.register(comp2)

                        return { result1, result2 }
                    }
                },
                {
                    name: 'æ— æ•ˆå…ƒæ•°æ®',
                    test: async () => {
                        const invalidComp = {
                            metadata: {
                                id: '',  // ç©ºID
                                name: '',  // ç©ºåç§°
                                type: 'invalid-type',
                                version: '1.0.0',
                                createdAt: Date.now(),
                                updatedAt: Date.now(),
                                enabled: true,
                                priority: 10
                            },
                            content: {}
                        }

                        return await registryEngine.register(invalidComp)
                    }
                },
                {
                    name: 'éªŒè¯å¤±è´¥',
                    test: async () => {
                        const failingComp = {
                            metadata: {
                                id: 'validation-fail-test',
                                name: 'éªŒè¯å¤±è´¥æµ‹è¯•',
                                type: 'card21-component',
                                version: '1.0.0',
                                createdAt: Date.now(),
                                updatedAt: Date.now(),
                                enabled: true,
                                priority: 10
                            },
                            content: {},
                            validate: () => {
                                throw new Error('éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸')
                            }
                        }

                        return await registryEngine.register(failingComp)
                    }
                }
            ]

            const errorResults = {}

            for (const errorTest of errorTests) {
                try {
                    const result = await errorTest.test()
                    errorResults[errorTest.name] = {
                        ç»“æœ: result,
                        çŠ¶æ€: 'æµ‹è¯•å®Œæˆ'
                    }
                } catch (error) {
                    errorResults[errorTest.name] = {
                        é”™è¯¯: error.message,
                        çŠ¶æ€: 'æ•è·å¼‚å¸¸'
                    }
                }
            }

            updateStats()

            displayResult('é”™è¯¯å¤„ç†æµ‹è¯•ç»“æœ', errorResults)
            logMessage('âœ… é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ', 'success')
        }

        async function clearAllData() {
            logMessage('ğŸ§¹ æ¸…ç©ºæ‰€æœ‰æ•°æ®...', 'warn')
            await registryEngine.clear()
            updateStats()

            // æ¸…ç©ºç»“æœæ˜¾ç¤º
            document.getElementById('resultDisplay').innerHTML = ''

            displayResult('æ•°æ®æ¸…ç†', {
                çŠ¶æ€: 'æ‰€æœ‰æ³¨å†Œé¡¹å·²æ¸…ç©º',
                æ¸…ç†æ—¶é—´: new Date().toLocaleString()
            })

            logMessage('âœ… æ•°æ®æ¸…ç†å®Œæˆ', 'success')
        }

        // äº‹ä»¶ç›‘å¬å™¨
        registryEngine.on('register', (metadata) => {
            updateStats()
        })

        registryEngine.on('unregister', (id) => {
            updateStats()
        })

        registryEngine.on('error', (errorInfo) => {
            console.error('Registry Engine Error:', errorInfo)
        })

        // å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        setInterval(updateStats, 2000)

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            logMessage('ğŸ‰ Registry Engine æ¼”ç¤ºç³»ç»Ÿå·²å°±ç»ª', 'success')
            updateStats()
        })
    </script>
</body>
</html>