<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±æ€§æš´éœ²è°ƒè¯•æµ‹è¯•</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .json-display { background: #f4f4f4; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å±æ€§æš´éœ²è°ƒè¯•æµ‹è¯•</h1>
        <p>ç›´æ¥æ£€æŸ¥ propertyExposureRegistry çš„æ³¨å†ŒçŠ¶æ€å’Œå†…å®¹</p>

        <div class="debug-section">
            <h3>1ï¸âƒ£ æ£€æŸ¥æ³¨å†Œè¡¨çŠ¶æ€</h3>
            <button onclick="checkRegistryStatus()">æ£€æŸ¥æ³¨å†Œè¡¨</button>
            <div id="registry-status"></div>
        </div>

        <div class="debug-section">
            <h3>2ï¸âƒ£ æ£€æŸ¥simple-displayç»„ä»¶å±æ€§</h3>
            <button onclick="checkSimpleDisplayProperties()">æ£€æŸ¥simple-displayå±æ€§</button>
            <div id="simple-display-properties"></div>
        </div>

        <div class="debug-section">
            <h3>3ï¸âƒ£ æ£€æŸ¥åŸºç¡€é…ç½®å±æ€§</h3>
            <button onclick="checkBaseConfigProperties()">æ£€æŸ¥åŸºç¡€é…ç½®å±æ€§</button>
            <div id="base-config-properties"></div>
        </div>

        <div class="debug-section">
            <h3>4ï¸âƒ£ æ¨¡æ‹Ÿæ³¨å†Œè¿‡ç¨‹</h3>
            <button onclick="simulateRegistration()">æ¨¡æ‹Ÿé‡æ–°æ³¨å†Œ</button>
            <div id="registration-result"></div>
        </div>
    </div>

    <script type="module">
        // æ£€æŸ¥æ³¨å†Œè¡¨çŠ¶æ€
        window.checkRegistryStatus = async function() {
            try {
                const { propertyExposureRegistry } = await import('./src/card2.1/core/property-exposure.js');
                
                // é€šè¿‡åå°„è®¿é—®å†…éƒ¨çŠ¶æ€
                const registrations = (propertyExposureRegistry as any).registrations;
                const registrationMap = new Map(registrations);
                
                const status = {
                    totalRegistrations: registrationMap.size,
                    registeredTypes: Array.from(registrationMap.keys()),
                    detailed: {}
                };
                
                // è·å–æ¯ä¸ªç»„ä»¶çš„è¯¦ç»†ä¿¡æ¯
                for (const [type, config] of registrationMap.entries()) {
                    status.detailed[type] = {
                        componentName: config.componentName,
                        propertiesCount: config.listenableProperties?.length || 0,
                        properties: config.listenableProperties?.map(p => ({
                            name: p.name,
                            type: p.type,
                            group: p.group,
                            isCore: p.isCore
                        })) || []
                    };
                }
                
                document.getElementById('registry-status').innerHTML = `<div class="json-display">${JSON.stringify(status, null, 2)}</div>`;
                
            } catch (error) {
                document.getElementById('registry-status').innerHTML = `<div style="color: red;">é”™è¯¯: ${error.message}</div>`;
            }
        };

        // æ£€æŸ¥simple-displayç»„ä»¶çš„å±æ€§
        window.checkSimpleDisplayProperties = async function() {
            try {
                const { propertyExposureRegistry } = await import('./src/card2.1/core/property-exposure.js');
                
                const exposure = propertyExposureRegistry.getComponentExposure('simple-display');
                
                const result = {
                    exists: !!exposure,
                    componentName: exposure?.componentName,
                    propertiesCount: exposure?.listenableProperties?.length || 0,
                    properties: exposure?.listenableProperties?.map(p => ({
                        name: p.name,
                        label: p.label,
                        type: p.type,
                        group: p.group,
                        isCore: p.isCore,
                        description: p.description
                    })) || [],
                    hasDeviceId: exposure?.listenableProperties?.some(p => p.name === 'deviceId') || false,
                    hasMetricsList: exposure?.listenableProperties?.some(p => p.name === 'metricsList') || false
                };
                
                document.getElementById('simple-display-properties').innerHTML = `<div class="json-display">${JSON.stringify(result, null, 2)}</div>`;
                
            } catch (error) {
                document.getElementById('simple-display-properties').innerHTML = `<div style="color: red;">é”™è¯¯: ${error.message}</div>`;
            }
        };

        // æ£€æŸ¥åŸºç¡€é…ç½®å±æ€§å®šä¹‰
        window.checkBaseConfigProperties = async function() {
            try {
                const { getBaseConfigurationProperties } = await import('./src/card2.1/core/property-exposure.js');
                
                const baseProperties = getBaseConfigurationProperties();
                
                const result = {
                    count: baseProperties.length,
                    deviceFields: baseProperties.filter(p => ['deviceId', 'metricsList'].includes(p.name)),
                    allProperties: baseProperties.map(p => ({
                        name: p.name,
                        label: p.label,
                        type: p.type,
                        group: p.group,
                        isCore: p.isCore
                    }))
                };
                
                document.getElementById('base-config-properties').innerHTML = `<div class="json-display">${JSON.stringify(result, null, 2)}</div>`;
                
            } catch (error) {
                document.getElementById('base-config-properties').innerHTML = `<div style="color: red;">é”™è¯¯: ${error.message}</div>`;
            }
        };

        // æ¨¡æ‹Ÿé‡æ–°æ³¨å†Œè¿‡ç¨‹
        window.simulateRegistration = async function() {
            try {
                const { ComponentRegistry } = await import('./src/card2.1/core/component-registry.js');
                const { propertyExposureRegistry } = await import('./src/card2.1/core/property-exposure.js');
                
                // æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²æ³¨å†Œ
                const hasSimpleDisplay = ComponentRegistry.has('simple-display');
                const definition = ComponentRegistry.get('simple-display');
                
                // å°è¯•é‡æ–°æ³¨å†Œ
                if (definition) {
                    ComponentRegistry.register(definition);
                }
                
                // æ£€æŸ¥æ³¨å†Œåçš„çŠ¶æ€
                const exposure = propertyExposureRegistry.getComponentExposure('simple-display');
                
                const result = {
                    componentRegistered: hasSimpleDisplay,
                    definitionExists: !!definition,
                    exposureAfterReRegister: {
                        exists: !!exposure,
                        propertiesCount: exposure?.listenableProperties?.length || 0,
                        hasDeviceId: exposure?.listenableProperties?.some(p => p.name === 'deviceId') || false,
                        hasMetricsList: exposure?.listenableProperties?.some(p => p.name === 'metricsList') || false
                    }
                };
                
                document.getElementById('registration-result').innerHTML = `<div class="json-display">${JSON.stringify(result, null, 2)}</div>`;
                
            } catch (error) {
                document.getElementById('registration-result').innerHTML = `<div style="color: red;">é”™è¯¯: ${error.message}</div>`;
            }
        };

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œæ£€æŸ¥
        window.addEventListener('load', function() {
            console.log('ğŸ” [PropertyExposureDebug] é¡µé¢å·²åŠ è½½ï¼Œå¼€å§‹è°ƒè¯•...');
            
            // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿æ¨¡å—åŠ è½½å®Œæˆ
            setTimeout(function() {
                checkRegistryStatus();
                checkSimpleDisplayProperties();
                checkBaseConfigProperties();
            }, 1000);
        });
    </script>
</body>
</html>