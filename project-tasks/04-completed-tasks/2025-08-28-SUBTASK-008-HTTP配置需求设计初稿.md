# SUBTASK-008 HTTPé…ç½®éœ€æ±‚æ²Ÿé€šå’Œè®¾è®¡ - åŸºäºç°æœ‰æ¶æ„çš„æ­£ç¡®è®¾è®¡

**åˆ›å»ºæ—¶é—´**: 2025-08-28  
**ä»»åŠ¡ID**: SUBTASK-008  
**æ‰€å±å¤§ä»»åŠ¡**: HTTPåŠ¨æ€å‚æ•°ä¸é«˜çº§é…ç½®ç³»ç»Ÿ (TASK-2025-08-28-HTTP-DYNAMIC-SYSTEM-V1)  
**æ‰§è¡Œæ—¶é—´**: é‡æ–°è®¾è®¡ä¸­  
**æ–‡æ¡£çŠ¶æ€**: åŸºäºæ·±åº¦æ¶æ„ç†è§£çš„é‡æ–°è®¾è®¡ç‰ˆæœ¬

---

## ğŸ“Š ç°æœ‰æ¶æ„æ·±åº¦åˆ†æ

### ğŸ—ï¸ æ ¸å¿ƒæ¶æ„ç†è§£

é€šè¿‡æ·±å…¥ä»£ç åˆ†æï¼Œå‘ç°é¡¹ç›®é‡‡ç”¨**é…ç½®é©±åŠ¨çš„å“åº”å¼æ•°æ®æ‰§è¡Œæ¶æ„**ï¼š

```
é…ç½®å˜æ›´ â†’ ConfigEventBus â†’ UnifiedDataExecutor â†’ DataWarehouse â†’ ç»„ä»¶æ›´æ–°
     â†‘                                â†“
 ç”¨æˆ·æ“ä½œ                        å®é™…HTTPè¯·æ±‚
```

### âœ… å·²æœ‰åŸºç¡€è®¾æ–½åˆ†æ

**1. é…ç½®äº‹ä»¶é©±åŠ¨ç³»ç»Ÿ** `(ConfigEventBus.ts)`
```typescript
// é…ç½®å˜æ›´ä¼šè§¦å‘äº‹ä»¶
configEventBus.emitConfigChange({
  componentId: widgetId,
  section: 'dataSource', 
  newConfig: httpConfig,  // HTTPé…ç½®åœ¨è¿™é‡Œ
  timestamp: Date.now(),
  source: 'user'
})
```

**2. ç»Ÿä¸€æ•°æ®æ‰§è¡Œå™¨** `(UnifiedDataExecutor.ts)`
```typescript
// å·²æœ‰å®Œæ•´çš„HttpExecutorå®ç°
class HttpExecutor implements DataSourceExecutor {
  async execute(config: UnifiedDataConfig): Promise<UnifiedDataResult> {
    const { url, method, headers, params, body } = config.config
    const response = await request({ url, method, headers, params, data: body })
    return { success: true, data: response.data, timestamp: Date.now(), sourceId: config.id }
  }
}
```

**3. æ•°æ®ä»“åº“ç¼“å­˜ç³»ç»Ÿ** `(DataWarehouse.ts)`
```typescript
// é…ç½®å˜æ›´æ—¶è‡ªåŠ¨æ¸…ç†ç¼“å­˜ï¼Œè§¦å‘é‡æ–°æ‰§è¡Œ
simpleDataBridge.clearComponentCache(widgetId)
```

**4. å“åº”å¼æ•°æ®ç»‘å®š** `(Card2.1 data-bindingç³»ç»Ÿ)`
```typescript
// æ”¯æŒå¤šç§è§¦å‘å™¨ï¼šå®šæ—¶å™¨ã€WebSocketã€äº‹ä»¶ã€æ‰‹åŠ¨
const binding = new ReactiveDataBindingImpl(id, componentId, pipeline, triggers, onDataChange)
```

### âŒ å…³é”®ç¼ºå¤±

1. **HTTPé…ç½®æ ¼å¼ä¸åŒ¹é…** - éœ€è¦é€‚é…UnifiedDataConfigæ¥å£
2. **åŠ¨æ€å‚æ•°æœºåˆ¶ç¼ºå¤±** - æ²¡æœ‰è¿è¡Œæ—¶å‚æ•°æ³¨å…¥æœºåˆ¶  
3. **é…ç½®ç•Œé¢æœªé›†æˆ** - HttpConfigForm.vueæœªå¯ç”¨(available: false)
4. **å‚æ•°å˜é‡ç³»ç»Ÿç¼ºå¤±** - ç¼ºå°‘å˜é‡å®šä¹‰å’Œè§£ææœºåˆ¶

---

## ğŸ¯ åŸºäºç°æœ‰æ¶æ„çš„HTTPé…ç½®è®¾è®¡

### ğŸ’¡ æ ¸å¿ƒè®¾è®¡æ€æƒ³

**åŠ¨æ€å‚æ•°çš„æœ¬è´¨**: ä¸æ˜¯åœ¨é…ç½®é˜¶æ®µè·å–å€¼ï¼Œè€Œæ˜¯åœ¨**é…ç½®ä¸­å®šä¹‰å˜é‡å ä½ç¬¦ï¼Œåœ¨æ‰§è¡Œæ—¶åŠ¨æ€è§£æ**

```typescript
// é…ç½®é˜¶æ®µï¼šå®šä¹‰å˜é‡å ä½ç¬¦
httpConfig = {
  url: "http://api.example.com/device/data",
  method: "POST",
  requestParams: [
    { key: "deviceId", value: "{{selectedDeviceId}}", isVariable: true },  // å˜é‡
    { key: "dataType", value: "temperature", isVariable: false }            // é™æ€å€¼
  ]
}

// æ‰§è¡Œé˜¶æ®µï¼šUnifiedDataExecutorè°ƒç”¨æ—¶åŠ¨æ€è§£æ
// selectedDeviceIdå˜é‡ â†’ ä»ç»„ä»¶çŠ¶æ€è·å–å®é™…å€¼ â†’ "device_123"
// æœ€ç»ˆè¯·æ±‚: { deviceId: "device_123", dataType: "temperature" }
```

### ğŸ—ï¸ é€‚é…ç°æœ‰æ¶æ„çš„è®¾è®¡

**1. HTTPé…ç½®æ•°æ®ç»“æ„** (é€‚é…UnifiedDataConfig)
```typescript
interface HttpDataSourceConfig extends UnifiedDataConfig {
  id: string
  type: 'http'
  name?: string
  enabled?: boolean
  config: {
    // åŸºç¡€HTTPé…ç½®
    url: string
    method: 'GET' | 'POST' | 'PUT' | 'DELETE'
    timeout?: number
    
    // Headersé…ç½® (é€‚é…ç°æœ‰æ ¼å¼)
    headers?: Record<string, string>  // ç°æœ‰æ‰§è¡Œå™¨æœŸæœ›çš„æ ¼å¼
    
    // å‚æ•°é…ç½® (é€‚é…ç°æœ‰æ ¼å¼) 
    params?: Record<string, any>      // GETè¯·æ±‚å‚æ•°
    body?: any                        // POST/PUT/DELETEè¯·æ±‚ä½“
    
    // ğŸ†• å˜é‡å®šä¹‰å’Œè§£æé…ç½®
    variables?: VariableDefinition[]   // å˜é‡å®šä¹‰åˆ—è¡¨
    variableResolver?: string         // å˜é‡è§£æå™¨è„šæœ¬
  }
}

// å˜é‡å®šä¹‰æ¥å£
interface VariableDefinition {
  name: string                      // å˜é‡åï¼Œå¦‚ "selectedDeviceId"  
  source: VariableSource           // å˜é‡æ¥æº
  defaultValue?: any               // é»˜è®¤å€¼
  description?: string             // æè¿°
}

// å˜é‡æ¥æºå®šä¹‰  
interface VariableSource {
  type: 'component' | 'global' | 'computed' | 'script'
  path?: string                    // æ•°æ®è·¯å¾„ï¼Œå¦‚ "props.deviceId"
  script?: string                  // è„šæœ¬è®¡ç®—
}
```

**2. é…ç½®ç•Œé¢è®¾è®¡** (3ä¸ªé¡µç­¾)
- **é¡µç­¾1: åŸºç¡€é…ç½®** - URLã€è¯·æ±‚æ–¹å¼ã€è¶…æ—¶è®¾ç½®
- **é¡µç­¾2: è¯·æ±‚å‚æ•°** - Headerså’ŒBodyå‚æ•°ç»Ÿä¸€é…ç½®
- **é¡µç­¾3: å˜é‡ç®¡ç†** - å®šä¹‰å’Œç®¡ç†åŠ¨æ€å˜é‡

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. æ‰©å±•UnifiedDataExecutoræ”¯æŒå˜é‡è§£æ

åœ¨ç°æœ‰HttpExecutoråŸºç¡€ä¸Šå¢åŠ å˜é‡è§£æåŠŸèƒ½ï¼š

```typescript
class EnhancedHttpExecutor implements DataSourceExecutor {
  type = 'http'
  
  async execute(config: UnifiedDataConfig): Promise<UnifiedDataResult> {
    try {
      // ğŸ†• æ­¥éª¤1: è§£æé…ç½®ä¸­çš„å˜é‡
      const resolvedConfig = await this.resolveVariables(config)
      
      // æ­¥éª¤2: ä½¿ç”¨ç°æœ‰é€»è¾‘æ‰§è¡ŒHTTPè¯·æ±‚
      const { url, method = 'GET', headers, params, body } = resolvedConfig.config
      const response = await request({
        url, method: method.toLowerCase() as any, headers, params, data: body
      })
      
      return {
        success: true,
        data: response.data,
        timestamp: Date.now(),
        sourceId: config.id
      }
    } catch (error: any) {
      return {
        success: false,
        error: error.message || 'è¯·æ±‚å¤±è´¥',
        timestamp: Date.now(),
        sourceId: config.id
      }
    }
  }
  
  /**
   * ğŸ†• è§£æé…ç½®ä¸­çš„å˜é‡å ä½ç¬¦
   */
  private async resolveVariables(config: UnifiedDataConfig): Promise<UnifiedDataConfig> {
    const httpConfig = config.config
    const variables = httpConfig.variables || []
    
    // æ„å»ºå˜é‡å€¼æ˜ å°„è¡¨
    const variableValues: Record<string, any> = {}
    for (const variable of variables) {
      variableValues[variable.name] = await this.resolveVariable(variable)
    }
    
    // è§£æURLä¸­çš„å˜é‡
    let resolvedUrl = httpConfig.url
    for (const [varName, varValue] of Object.entries(variableValues)) {
      resolvedUrl = resolvedUrl.replace(`{{${varName}}}`, String(varValue))
    }
    
    // è§£æheadersä¸­çš„å˜é‡
    const resolvedHeaders: Record<string, string> = {}
    if (httpConfig.headers) {
      for (const [key, value] of Object.entries(httpConfig.headers)) {
        let resolvedValue = value
        for (const [varName, varValue] of Object.entries(variableValues)) {
          resolvedValue = resolvedValue.replace(`{{${varName}}}`, String(varValue))
        }
        resolvedHeaders[key] = resolvedValue
      }
    }
    
    // è§£æparamså’Œbodyä¸­çš„å˜é‡
    const resolvedParams = this.resolveObjectVariables(httpConfig.params, variableValues)
    const resolvedBody = this.resolveObjectVariables(httpConfig.body, variableValues)
    
    return {
      ...config,
      config: {
        ...httpConfig,
        url: resolvedUrl,
        headers: resolvedHeaders,
        params: resolvedParams,
        body: resolvedBody
      }
    }
  }
  
  /**
   * è§£æå•ä¸ªå˜é‡çš„å€¼
   */
  private async resolveVariable(variable: VariableDefinition): Promise<any> {
    try {
      switch (variable.source.type) {
        case 'component':
          // ä»ç»„ä»¶çŠ¶æ€è·å–å€¼
          return this.getComponentVariable(variable.source.path || '')
        
        case 'global': 
          // ä»å…¨å±€çŠ¶æ€è·å–å€¼
          return this.getGlobalVariable(variable.source.path || '')
        
        case 'computed':
          // è®¡ç®—å€¼
          return this.getComputedVariable(variable.source.path || '')
        
        case 'script':
          // è„šæœ¬æ‰§è¡Œ
          return await this.executeScript(variable.source.script || '')
        
        default:
          return variable.defaultValue
      }
    } catch (error) {
      console.warn(`å˜é‡è§£æå¤±è´¥: ${variable.name}`, error)
      return variable.defaultValue
    }
  }
  
  private resolveObjectVariables(obj: any, variables: Record<string, any>): any {
    if (!obj) return obj
    
    let resolved = JSON.stringify(obj)
    for (const [varName, varValue] of Object.entries(variables)) {
      resolved = resolved.replace(new RegExp(`"{{${varName}}}"`, 'g'), JSON.stringify(varValue))
    }
    
    try {
      return JSON.parse(resolved)
    } catch {
      return obj
    }
  }
}
```

### 2. å˜é‡è·å–å®ç°

```typescript
/**
 * å˜é‡å€¼è·å–å™¨ - ä»ç°æœ‰ç³»ç»Ÿè·å–å˜é‡å€¼
 */
class VariableResolver {
  
  /**
   * ä»ç»„ä»¶çŠ¶æ€è·å–å˜é‡
   */
  getComponentVariable(path: string, componentId?: string): any {
    // æ–¹æ¡ˆ1: ä»DataWarehouseè·å–ç»„ä»¶æ•°æ®
    const componentData = dataWarehouse.getComponentData(componentId || 'current')
    return this.getValueByPath(componentData, path)
  }
  
  /**
   * ä»å…¨å±€çŠ¶æ€è·å–å˜é‡ 
   */
  getGlobalVariable(path: string): any {
    // ä»å„ç§Storeè·å–å…¨å±€çŠ¶æ€
    if (path.startsWith('auth.')) {
      const authStore = useAuthStore()
      return this.getValueByPath(authStore, path.substring(5))
    }
    
    if (path.startsWith('theme.')) {
      const themeStore = useThemeStore()
      return this.getValueByPath(themeStore, path.substring(6))
    }
    
    // å…¶ä»–å…¨å±€çŠ¶æ€...
    return null
  }
  
  /**
   * è·å–è®¡ç®—å€¼
   */
  getComputedVariable(path: string): any {
    const computedMap = {
      'currentTimestamp': () => Date.now(),
      'currentDate': () => new Date().toISOString(),
      'randomId': () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    }
    
    return computedMap[path]?.() || null
  }
  
  /**
   * æ‰§è¡Œè„šæœ¬è·å–å€¼
   */
  async executeScript(script: string): Promise<any> {
    try {
      // ä½¿ç”¨ç°æœ‰çš„è„šæœ¬å¼•æ“
      const result = await defaultScriptEngine.execute(script, {
        // æä¾›è„šæœ¬ä¸Šä¸‹æ–‡
        currentTime: Date.now(),
        randomNumber: (min: number, max: number) => Math.random() * (max - min) + min
      })
      
      return result.success ? result.data : null
    } catch (error) {
      console.error('è„šæœ¬æ‰§è¡Œå¤±è´¥:', error)
      return null
    }
  }
  
  /**
   * æŒ‰è·¯å¾„è·å–å¯¹è±¡å€¼
   */
  private getValueByPath(obj: any, path: string): any {
    return path.split('.').reduce((current, key) => current?.[key], obj)
  }
}
```

### 3. é…ç½®ç•Œé¢å®ç°

**HttpConfigForm.vue é‡æ„æ–¹æ¡ˆ**ï¼š

```vue
<template>
  <n-tabs v-model:value="activeTab" type="card">
    <!-- é¡µç­¾1: åŸºç¡€é…ç½® -->
    <n-tab-pane name="basic" :tab="$t('http.config.basic')">
      <n-form :model="httpConfig" label-placement="top">
        <n-form-item :label="$t('http.config.url')" required>
          <n-input v-model:value="httpConfig.url" placeholder="http://api.example.com" />
        </n-form-item>
        
        <n-form-item :label="$t('http.config.method')" required>
          <n-select v-model:value="httpConfig.method" :options="methodOptions" />
        </n-form-item>
        
        <n-form-item :label="$t('http.config.timeout')">
          <n-input-number v-model:value="httpConfig.timeout" :min="1000" :max="60000" />
        </n-form-item>
      </n-form>
    </n-tab-pane>
    
    <!-- é¡µç­¾2: è¯·æ±‚å‚æ•° -->
    <n-tab-pane name="params" :tab="$t('http.config.params')">
      <n-space vertical>
        <!-- Headersé…ç½® -->
        <n-card :title="$t('http.config.headers')" size="small">
          <template #header-extra>
            <n-button size="small" @click="addHeader">
              <template #icon><i-material-symbols:add /></template>
              {{ $t('common.add') }}
            </n-button>
          </template>
          
          <n-space vertical>
            <div v-for="(header, index) in headers" :key="index" class="param-row">
              <n-input v-model:value="header.key" placeholder="Headeråç§°" />
              <n-input v-model:value="header.value" placeholder="å€¼æˆ–{{å˜é‡å}}" />
              <n-button size="small" type="error" @click="removeHeader(index)">
                <template #icon><i-material-symbols:delete /></template>
              </n-button>
            </div>
          </n-space>
        </n-card>
        
        <!-- Bodyå‚æ•°é…ç½® -->
        <n-card :title="$t('http.config.body')" size="small">
          <!-- ç±»ä¼¼Headersçš„å®ç° -->
        </n-card>
      </n-space>
    </n-tab-pane>
    
    <!-- é¡µç­¾3: å˜é‡ç®¡ç† -->  
    <n-tab-pane name="variables" :tab="$t('http.config.variables')">
      <VariableManager v-model:variables="httpConfig.variables" />
    </n-tab-pane>
  </n-tabs>
</template>

<script setup lang="ts">
// ç»„ä»¶å®ç°...
const activeTab = ref('basic')
const httpConfig = ref<HttpDataSourceConfig>({
  id: '',
  type: 'http',
  config: {
    url: '',
    method: 'GET',
    headers: {},
    params: {},
    variables: []
  }
})

// é…ç½®å˜æ›´æ—¶è§¦å‘äº‹ä»¶
watch(() => httpConfig.value, (newConfig) => {
  emit('update:modelValue', newConfig)
}, { deep: true })
</script>
```
```

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### å®é™…é…ç½®ç¤ºä¾‹

**åœºæ™¯**: è·å–å½“å‰ç”¨æˆ·é€‰ä¸­è®¾å¤‡çš„å®æ—¶æ¸©åº¦æ•°æ®

```typescript
// 1. å˜é‡å®šä¹‰
const variables: VariableDefinition[] = [
  {
    name: 'selectedDeviceId',
    source: { type: 'component', path: 'props.deviceId' },
    defaultValue: 'default-device',
    description: 'ç”¨æˆ·é€‰ä¸­çš„è®¾å¤‡ID'
  },
  {
    name: 'currentTimestamp', 
    source: { type: 'computed', path: 'currentTimestamp' },
    description: 'å½“å‰æ—¶é—´æˆ³'
  },
  {
    name: 'authToken',
    source: { type: 'global', path: 'auth.token' },
    description: 'ç”¨æˆ·è®¤è¯ä»¤ç‰Œ'
  }
]

// 2. HTTPé…ç½®
const httpConfig: HttpDataSourceConfig = {
  id: 'device-temperature-api',
  type: 'http',
  config: {
    url: 'http://api.iot-platform.com/device/{{selectedDeviceId}}/data',
    method: 'POST',
    headers: {
      'Authorization': 'Bearer {{authToken}}',
      'Content-Type': 'application/json'
    },
    body: {
      dataType: 'temperature',
      timestamp: '{{currentTimestamp}}',
      deviceId: '{{selectedDeviceId}}'
    },
    variables
  }
}

// 3. é…ç½®å˜æ›´è§¦å‘æ‰§è¡Œ
configurationManager.updateConfiguration(componentId, 'dataSource', {
  type: 'http',
  config: httpConfig
})

// 4. ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œæµç¨‹ï¼š
// ConfigEventBuså‘å‡ºäº‹ä»¶ â†’ EnhancedHttpExecutorè§£æå˜é‡ â†’ å‘é€HTTPè¯·æ±‚ â†’ è¿”å›æ•°æ®
```

### æ‰§è¡Œæ—¶çš„å˜é‡è§£æè¿‡ç¨‹

```typescript
// æ‰§è¡Œå‰çš„é…ç½®
url: 'http://api.iot-platform.com/device/{{selectedDeviceId}}/data'
body: { deviceId: '{{selectedDeviceId}}', timestamp: '{{currentTimestamp}}' }

// â†“ EnhancedHttpExecutorè§£æå˜é‡

// æ‰§è¡Œæ—¶çš„å®é™…é…ç½®  
url: 'http://api.iot-platform.com/device/device_123/data'
body: { deviceId: 'device_123', timestamp: 1693456789000 }

// â†“ å‘é€HTTPè¯·æ±‚

// å®é™…å‘é€çš„è¯·æ±‚
POST http://api.iot-platform.com/device/device_123/data
Headers: {
  'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  'Content-Type': 'application/json'
}
Body: {
  "deviceId": "device_123",
  "timestamp": 1693456789000,
  "dataType": "temperature"
}
```

---

## âœ… å®æ–½è®¡åˆ’

### SUBTASK-009: HTTPé…ç½®ç•Œé¢å®ç°

**ç›®æ ‡**: å®ç°HTTPé…ç½®çš„3é¡µç­¾ç•Œé¢

**æŠ€æœ¯è¦ç‚¹**:
1. é‡æ„ç°æœ‰HttpConfigForm.vueä¸º3é¡µç­¾è®¾è®¡
2. å®ç°å˜é‡å®šä¹‰å’Œç®¡ç†ç•Œé¢
3. é›†æˆåˆ°RawDataConfigModalä¸­(è®¾ç½®available: true)

**éªŒæ”¶æ ‡å‡†**:
- [ ] åŸºç¡€é…ç½®é¡µç­¾ï¼šURLã€æ–¹æ³•ã€è¶…æ—¶é…ç½®
- [ ] è¯·æ±‚å‚æ•°é¡µç­¾ï¼šHeaderså’ŒBodyå‚æ•°é…ç½®ï¼Œæ”¯æŒ{{å˜é‡}}è¯­æ³•  
- [ ] å˜é‡ç®¡ç†é¡µç­¾ï¼šå˜é‡å®šä¹‰ã€æ¥æºé…ç½®ã€é»˜è®¤å€¼è®¾ç½®
- [ ] é…ç½®å˜æ›´æ­£ç¡®è§¦å‘ConfigEventBusäº‹ä»¶

### SUBTASK-010: HTTPæ‰§è¡Œå™¨å¢å¼º

**ç›®æ ‡**: å¢å¼ºUnifiedDataExecutoræ”¯æŒå˜é‡è§£æ

**æŠ€æœ¯è¦ç‚¹**:
1. æ‰©å±•HttpExecutorç±»å¢åŠ å˜é‡è§£æåŠŸèƒ½
2. å®ç°VariableResolverç±»ï¼Œä»ç°æœ‰Storeç³»ç»Ÿè·å–å˜é‡å€¼
3. æ”¯æŒcomponent/global/computed/scriptå››ç§å˜é‡ç±»å‹

**éªŒæ”¶æ ‡å‡†**:
- [ ] EnhancedHttpExecutoræ­£ç¡®è§£æ{{å˜é‡}}å ä½ç¬¦
- [ ] å˜é‡è§£æå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
- [ ] ä¸ç°æœ‰ConfigEventBusäº‹ä»¶æœºåˆ¶å®Œå…¨å…¼å®¹
- [ ] å˜é‡è§£ææ€§èƒ½æ»¡è¶³è¦æ±‚(< 100ms)

### SUBTASK-011: ç³»ç»Ÿé›†æˆæµ‹è¯•

**ç›®æ ‡**: å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•

**æŠ€æœ¯è¦ç‚¹**:
1. é…ç½®å˜æ›´ â†’ äº‹ä»¶å‘å‡º â†’ å˜é‡è§£æ â†’ HTTPè¯·æ±‚ â†’ æ•°æ®æ›´æ–°çš„å®Œæ•´é“¾è·¯æµ‹è¯•
2. å¤šç§å˜é‡ç±»å‹çš„ç»¼åˆæµ‹è¯•
3. é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
- [ ] é…ç½®ç•Œé¢ä¿®æ”¹èƒ½æ­£ç¡®è§¦å‘HTTPè¯·æ±‚
- [ ] å˜é‡å€¼å˜åŒ–èƒ½è§¦å‘HTTPè¯·æ±‚é‡æ–°æ‰§è¡Œ
- [ ] é”™è¯¯æƒ…å†µ(ç½‘ç»œå¤±è´¥ã€å˜é‡è§£æå¤±è´¥ç­‰)æœ‰åˆé€‚å¤„ç†
- [ ] æ€§èƒ½æ»¡è¶³è¦æ±‚ï¼Œæ— å†…å­˜æ³„æ¼

### 2. HTTPæ‰§è¡Œå™¨å¢å¼ºæ–¹æ¡ˆ

```typescript
/**
 * å¢å¼ºç‰ˆHTTPæ‰§è¡Œå™¨
 * æ‰©å±•UnifiedDataExecutorçš„HttpExecutor
 */
class EnhancedHttpExecutor implements DataSourceExecutor {
  private parameterResolver = new DynamicParameterResolver()
  private scriptExecutor = new ScriptExecutor()
  private requestCache = new Map<string, CachedResponse>()
  
  async execute(config: UnifiedDataConfig): Promise<UnifiedDataResult> {
    try {
      // 1. æ‰§è¡Œè¯·æ±‚å‰è„šæœ¬å¤„ç†
      const processedConfig = await this.executePreRequestScript(config)
      
      // 2. è§£æåŠ¨æ€å‚æ•°
      const resolvedConfig = await this.resolveDynamicParameters(processedConfig)
      
      // 3. æ£€æŸ¥ç¼“å­˜
      const cacheKey = this.generateCacheKey(resolvedConfig)
      if (this.shouldUseCache(resolvedConfig) && this.requestCache.has(cacheKey)) {
        return this.getCachedResponse(cacheKey)
      }
      
      // 4. å‘é€HTTPè¯·æ±‚ (ä½¿ç”¨é¡¹ç›®çš„requestæœåŠ¡)
      const response = await this.sendHttpRequest(resolvedConfig)
      
      // 5. ç¼“å­˜å“åº”
      if (resolvedConfig.cache) {
        this.cacheResponse(cacheKey, response, resolvedConfig.cacheTime)
      }
      
      // 6. æ‰§è¡Œè¯·æ±‚åè„šæœ¬å¤„ç†
      const finalData = await this.executePostResponseScript(response, config)
      
      return {
        success: true,
        data: finalData,
        timestamp: Date.now(),
        sourceId: config.id,
        metadata: {
          responseTime: response.responseTime,
          fromCache: false,
          resolvedParams: this.getResolvedParamsSummary()
        }
      }
    } catch (error) {
      return this.handleExecutionError(error, config.id)
    }
  }
  
  /**
   * ä½¿ç”¨é¡¹ç›®requestæœåŠ¡å‘é€HTTPè¯·æ±‚
   */
  private async sendHttpRequest(config: UnifiedDataConfig) {
    const { url, method, headers, requestParams } = config.config
    const { request } = await import('@/service/request')
    
    // è½¬æ¢æ•°ç»„æ ¼å¼çš„headerså’ŒrequestParamsä¸ºå¯¹è±¡æ ¼å¼
    const headerObj = this.arrayToObject(headers)
    const requestData = this.arrayToObject(requestParams)
    
    // æ ¹æ®è¯·æ±‚æ–¹æ³•æ™ºèƒ½å¤„ç†å‚æ•°ä½ç½®
    if (method.toUpperCase() === 'GET') {
      // GETè¯·æ±‚ï¼šå‚æ•°æ”¾URL
      return await request({
        url,
        method: method.toLowerCase() as any,
        headers: headerObj,
        params: requestData  // GETè¯·æ±‚å‚æ•°æ”¾params
      })
    } else {
      // POST/PUT/DELETEï¼šå‚æ•°æ”¾Body
      return await request({
        url,
        method: method.toLowerCase() as any,
        headers: headerObj,
        data: requestData  // å…¶ä»–è¯·æ±‚å‚æ•°æ”¾data(body)
      })
    }
  }
  
  /**
   * å°†æ•°ç»„æ ¼å¼çš„é…ç½®è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
   * å¤„ç†åŠ¨æ€å‚æ•°å’Œé™æ€å€¼
   */
  private arrayToObject(items: Array<{key: string, value: string, isDynamic: boolean, enabled: boolean}>, context: ParameterContext) {
    const result = {}
    items?.filter(item => item.enabled).forEach(item => {
      if (item.isDynamic) {
        // åŠ¨æ€å‚æ•°ï¼šä»contextä¸­è§£æè·å–å®é™…å€¼
        result[item.key] = this.parameterResolver.resolve(item.value, context)
      } else {
        // é™æ€å€¼ï¼šç›´æ¥ä½¿ç”¨
        result[item.key] = item.value
      }
    })
    return result
  }
}
```

### 3. RawDataConfigModalé›†æˆæ‰©å±•

éœ€è¦æ‰©å±•çš„å…³é”®ç‚¹ï¼š

```typescript
// 1. å¯ç”¨HTTPé€‰é¡¹
const inputMethods = [
  { label: 'JSONæ•°æ®', value: 'json', available: true },
  { label: 'HTTPæ¥å£', value: 'http', available: true }, // æ”¹ä¸ºtrue
  { label: 'JavaScriptè„šæœ¬', value: 'script', available: true }
]

// 2. æ‰©å±•è¡¨å•çŠ¶æ€
const formState = reactive({
  // ...ç°æœ‰å­—æ®µ
  
  // HTTPæ‰©å±•å­—æ®µ
  httpConfig: {
    url: '',
    method: 'GET',
    headers: [],
    requestParams: [],
    preRequestScript: '',
    postResponseScript: '',
    templateId: null,
    timeout: 5000,
    cache: false,
    cacheTime: 300
  } as HttpDataSourceConfig
})

// 3. æ‰©å±•getCurrentDataItemæ–¹æ³•
const getCurrentDataItem = (): DataItem => {
  switch (formState.selectedMethod) {
    case 'http':
      return {
        type: 'http',
        config: formState.httpConfig
      }
    // ...å…¶ä»–cases
  }
}
```

### 4. é¢„åˆ¶é…ç½®æ¨¡æ¿ç³»ç»Ÿ

```typescript
/**
 * HTTPé…ç½®æ¨¡æ¿ç®¡ç†å™¨
 */
class HttpConfigTemplateManager {
  private templates: HttpConfigTemplate[] = [
    {
      id: 'restful-api-get',
      name: 'RESTful API (GET)',
      description: 'æ ‡å‡†RESTful API GETè¯·æ±‚æ¨¡æ¿',
      category: 'RESTful',
      config: {
        method: 'GET',
        headers: [
          { key: 'Content-Type', value: 'application/json', isDynamic: false, enabled: true, description: 'å†…å®¹ç±»å‹' },
          { key: 'Authorization', value: 'globalState.authToken', isDynamic: true, enabled: true, description: 'è®¤è¯ä»¤ç‰Œ' }
        ],
        requestParams: [
          { key: 'page', value: '1', isDynamic: false, enabled: true, dataType: 'number', description: 'é¡µç ' },
          { key: 'limit', value: '10', isDynamic: false, enabled: true, dataType: 'number', description: 'æ¯é¡µæ•°é‡' }
        ]
      },
      tags: ['RESTful', 'GET', 'åˆ†é¡µ']
    },
    {
      id: 'iot-sensor-data',
      name: 'ç‰©è”ç½‘ä¼ æ„Ÿå™¨æ•°æ®',
      description: 'è·å–è®¾å¤‡ä¼ æ„Ÿå™¨å®æ—¶æ•°æ®',
      category: 'ç‰©è”ç½‘',
      config: {
        method: 'GET',
        headers: [
          { key: 'Device-ID', value: 'componentData.deviceId', isDynamic: true, enabled: true, description: 'è®¾å¤‡ID' },
          { key: 'API-Key', value: 'environmentVars.apiKey', isDynamic: true, enabled: true, description: 'APIå¯†é’¥' }
        ],
        requestParams: [
          { key: 'timeRange', value: 'componentData.selectedTimeRange', isDynamic: true, enabled: true, dataType: 'string', description: 'æ—¶é—´èŒƒå›´' },
          { key: 'dataType', value: 'temperature,humidity', isDynamic: false, enabled: true, dataType: 'string', description: 'æ•°æ®ç±»å‹' }
        ],
        postResponseScript: `
// å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®æ ¼å¼
if (data && data.sensors) {
  return data.sensors.map(sensor => ({
    id: sensor.device_id,
    temperature: sensor.temp_value,
    humidity: sensor.hum_value,
    timestamp: new Date(sensor.timestamp).getTime()
  }))
}
return data
        `
      },
      tags: ['ç‰©è”ç½‘', 'ä¼ æ„Ÿå™¨', 'å®æ—¶æ•°æ®']
    },
    {
      id: 'webhook-post',
      name: 'Webhook POSTè¯·æ±‚',
      description: 'å‘ç¬¬ä¸‰æ–¹æœåŠ¡å‘é€Webhookæ•°æ®',
      category: 'é›†æˆ',
      config: {
        method: 'POST',
        headers: [
          { key: 'Content-Type', value: 'application/json', isDynamic: false, enabled: true, description: 'å†…å®¹ç±»å‹' },
          { key: 'X-Webhook-Signature', value: 'computedValues.webhookSignature', isDynamic: true, enabled: true, description: 'Webhookç­¾å' }
        ],
        requestParams: [
          { key: 'event', value: 'componentData.eventType', isDynamic: true, enabled: true, dataType: 'string', description: 'äº‹ä»¶ç±»å‹' },
          { key: 'data', value: 'componentData.eventData', isDynamic: true, enabled: true, dataType: 'object', description: 'äº‹ä»¶æ•°æ®' },
          { key: 'timestamp', value: 'systemVars.currentTimestamp', isDynamic: true, enabled: true, dataType: 'number', description: 'æ—¶é—´æˆ³' }
        ],
        preRequestScript: `
// ç”ŸæˆWebhookç­¾å
const crypto = require('crypto')
const payload = JSON.stringify(context.requestBody)
const signature = crypto.createHmac('sha256', context.secret).update(payload).digest('hex')
context.webhookSignature = 'sha256=' + signature
        `
      },
      tags: ['Webhook', 'POST', 'é›†æˆ', 'ç­¾å']
    }
  ]
  
  /**
   * è·å–æ‰€æœ‰æ¨¡æ¿
   */
  getTemplates(): HttpConfigTemplate[] {
    return this.templates
  }
  
  /**
   * æŒ‰åˆ†ç±»è·å–æ¨¡æ¿
   */
  getTemplatesByCategory(category: string): HttpConfigTemplate[] {
    return this.templates.filter(t => t.category === category)
  }
  
  /**
   * åº”ç”¨æ¨¡æ¿åˆ°é…ç½®
   */
  applyTemplate(templateId: string, currentConfig?: Partial<HttpDataSourceConfig>): HttpDataSourceConfig {
    const template = this.templates.find(t => t.id === templateId)
    if (!template) {
      throw new Error(`æ¨¡æ¿ä¸å­˜åœ¨: ${templateId}`)
    }
    
    return {
      ...currentConfig,
      ...template.config,
      templateId
    } as HttpDataSourceConfig
  }
}
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ™ºèƒ½ç¼“å­˜æœºåˆ¶

```typescript
interface CachedResponse {
  data: any
  timestamp: number
  expireTime: number
  requestHash: string
}

class HttpRequestCache {
  private cache = new Map<string, CachedResponse>()
  private maxCacheSize = 100
  
  /**
   * ç”Ÿæˆç¼“å­˜é”®
   */
  generateCacheKey(config: HttpDataSourceConfig): string {
    const key = JSON.stringify({
      url: config.url,
      method: config.method,
      headers: config.headers.filter(h => h.enabled),
      params: config.params.filter(p => p.enabled),
      body: config.body
    })
    return this.hashString(key)
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦åº”è¯¥ä½¿ç”¨ç¼“å­˜
   */
  shouldUseCache(config: HttpDataSourceConfig): boolean {
    return config.cache && config.method === 'GET'
  }
}
```

### 2. é˜²æŠ–èŠ‚æµæœºåˆ¶

```typescript
class HttpRequestDebouncer {
  private pendingRequests = new Map<string, Promise<any>>()
  private requestTimers = new Map<string, NodeJS.Timeout>()
  
  /**
   * é˜²æŠ–æ‰§è¡ŒHTTPè¯·æ±‚
   */
  debounceRequest(key: string, executor: () => Promise<any>, delay = 300): Promise<any> {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.requestTimers.has(key)) {
      clearTimeout(this.requestTimers.get(key)!)
    }
    
    // è¿”å›é˜²æŠ–çš„Promise
    return new Promise((resolve, reject) => {
      const timer = setTimeout(async () => {
        try {
          const result = await executor()
          resolve(result)
        } catch (error) {
          reject(error)
        } finally {
          this.requestTimers.delete(key)
        }
      }, delay)
      
      this.requestTimers.set(key, timer)
    })
  }
}
```

---

## ğŸ“‹ ä¼˜åŒ–åçš„åŠ¨æ€å‚æ•°è®¾è®¡ä¼˜åŠ¿

**âœ… è®¾è®¡ä¼˜åŠ¿**:
1. **ç•Œé¢æ¸…æ™°**: å‹¾é€‰æ¡†æ˜ç¡®æ ‡è¯†åŠ¨æ€/é™æ€å‚æ•°ï¼Œæ— éœ€è§£æå¤æ‚è¯­æ³•
2. **ç®¡ç†ç®€å•**: `isDynamic` æ ‡è¯†å­—æ®µï¼Œé¿å…æ­£åˆ™è¡¨è¾¾å¼è§£æ `${param}` è¯­æ³•  
3. **ç”¨æˆ·å‹å¥½**: åŠ¨æ€å‚æ•°æ—¶æ˜¾ç¤ºå‚æ•°æºé€‰æ‹©å™¨ï¼Œæä¾›å¯é€‰å‚æ•°åˆ—è¡¨
4. **æ€§èƒ½ä¼˜åŒ–**: ä¸ä¼ å‚æ•°æ—¶ä¸å‘é€ï¼Œé¿å…æ— æ•ˆè¯·æ±‚å‚æ•°
5. **æ‰©å±•æ€§å¥½**: æ˜“äºæ·»åŠ æ–°çš„å‚æ•°æºç±»å‹å’ŒéªŒè¯é€»è¾‘

**ğŸ”§ æ ¸å¿ƒå®ç°é€»è¾‘**:
```typescript
// å¤„ç†å‚æ•°æ—¶çš„é€»è¾‘
function processParameter(param: HttpParameter, context: ParameterContext) {
  if (!param.enabled) {
    return null // æœªå¯ç”¨ï¼Œä¸å‘é€
  }
  
  if (param.isDynamic) {
    const value = parameterResolver.resolve(param.value, context)
    return value !== undefined ? { [param.key]: value } : null // å€¼ä¸ºç©ºæ—¶ä¸å‘é€
  } else {
    return { [param.key]: param.value } // é™æ€å€¼ç›´æ¥ä½¿ç”¨
  }
}
```

---

## ğŸ“‹ éœ€æ±‚ç¡®è®¤å’Œæ¾„æ¸…

### âœ… å·²ç¡®è®¤çš„éœ€æ±‚

1. **URLåŠ¨æ€å‚æ•°æ”¯æŒ**: âŒ **ä¸éœ€è¦** - URLä¸æ”¯æŒåŠ¨æ€å‚æ•°ï¼Œé¿å…æ•°æ®è·å–ä¸å¯æ§
5. **æ€§èƒ½å½±å“è¯„ä¼°**: âœ… **éœ€è¦é˜²æŠ–æœºåˆ¶** - å‚æ•°å€¼é¢‘ç¹å˜åŒ–æ—¶ä½¿ç”¨é˜²æŠ–é¿å…è¿‡åº¦è¯·æ±‚
6. **RawDataConfigModalé›†æˆ**: âŒ **æš‚ä¸è€ƒè™‘** - å‘åå…¼å®¹é—®é¢˜åç»­å¤„ç†
7. **é¢„åˆ¶æ¨¡æ¿ç³»ç»Ÿ**: âœ… **éœ€è¦** - é€šè¿‡æ–‡ä»¶å¼•å…¥é…ç½®å¯¹è±¡æ•°ç»„ï¼Œæ”¯æŒJSONå¯¼å…¥åŠŸèƒ½ï¼Œæä¾›æ•°æ®ç±»å‹å’Œç¤ºä¾‹
8. **æµ‹è¯•å’Œè°ƒè¯•åŠŸèƒ½**: âŒ **æš‚æ—¶æ²¡æœ‰** - å…ˆå®ç°åŸºç¡€åŠŸèƒ½
9. **å®‰å…¨æ€§è€ƒè™‘**: âœ… **ä½¿ç”¨ç°æœ‰script-engine** - è·¯å¾„: `src/core/script-engine`
10. **å›½é™…åŒ–æ”¯æŒ**: â³ **åç»­ç»Ÿä¸€å¤„ç†** - ä¸åœ¨å½“å‰ä»»åŠ¡èŒƒå›´

### âœ… æœ€ç»ˆç¡®è®¤çš„éœ€æ±‚

2. **è¯·æ±‚å‚æ•°åŠ¨æ€é…ç½®**: âœ… **é‡ç‚¹æ”¯æŒ** - ç»Ÿä¸€çš„è¯·æ±‚å‚æ•°é…ç½®ï¼Œç³»ç»Ÿæ™ºèƒ½å¤„ç†æ”¾URLè¿˜æ˜¯Body
3. **å‚æ•°æºæ•°æ®è·å–æ—¶æœº**: âœ… **å‹¾é€‰"åŠ¨æ€å‚æ•°"æ—¶è·å–** - æ”¯æŒé»˜è®¤å€¼ï¼Œè¡¨å•å¿…å¡«éªŒè¯  
4. **é”™è¯¯å¤„ç†ç­–ç•¥**: âœ… **è·å–å¤±è´¥ä½¿ç”¨é»˜è®¤å€¼** - é…åˆè¡¨å•éªŒè¯ç¡®ä¿å®Œæ•´æ€§

### ğŸ¯ åŠ¨æ€å‚æ•°ä¼˜å…ˆçº§è¯´æ˜
- **è¯·æ±‚å‚æ•° (requestParams)**: ğŸ”¥ **ä¸»è¦åœºæ™¯** - é‡ç‚¹æ”¯æŒï¼Œä¸šåŠ¡æ•°æ®ä¼ è¾“çš„æ ¸å¿ƒï¼Œç³»ç»Ÿè‡ªåŠ¨å†³å®šæ”¾URL(GET)è¿˜æ˜¯Body(POST/PUT/DELETE)
- **Headers (è¯·æ±‚å¤´)**: ğŸ“‹ **æ¬¡è¦åœºæ™¯** - é¡ºä¾¿æ”¯æŒï¼Œä¸»è¦ç”¨äºè®¤è¯å’Œå…ƒæ•°æ®
- **URLè·¯å¾„å‚æ•°**: âŒ **ä¸æ”¯æŒ** - é¿å…åŠ¨æ€URLå¯¼è‡´çš„å¤æ‚æ€§

### ğŸ“ è¡¨å•éªŒè¯è§„åˆ™
- **å¿…å¡«å­—æ®µ**: URLã€è¯·æ±‚æ–¹å¼ã€æ‰€æœ‰å·²æ·»åŠ çš„å‚æ•°é¡¹(é™¤è„šæœ¬å¤–)
- **éªŒè¯æ—¶æœº**: è¡¨å•æ ¡éªŒé€šè¿‡åè‡ªåŠ¨å‘é€è¯·æ±‚
- **å‚æ•°å®Œæ•´æ€§**: æ·»åŠ å‚æ•°é¡¹åå¿…é¡»å¡«å†™å®Œæ•´(keyã€valueã€åŠ¨æ€é…ç½®ç­‰)

---

## ğŸ”§ åŠ¨æ€å‚æ•°ç®¡ç†ç³»ç»Ÿè®¾è®¡

### ğŸ¯ æ ¸å¿ƒæ¦‚å¿µè¯´æ˜

**åŠ¨æ€å‚æ•°å°±æ˜¯ï¼šé…ç½®HTTPè¯·æ±‚æ—¶ï¼ŒæŸäº›å‚æ•°å€¼ä¸æ˜¯å›ºå®šå†™æ­»çš„ï¼Œè€Œæ˜¯ä»å…¶ä»–åœ°æ–¹è·å–çš„**

ä¸¾ä¸ªä¾‹å­ï¼š
- âŒ **é™æ€å‚æ•°**: `deviceId: "device123"` (å†™æ­»äº†)  
- âœ… **åŠ¨æ€å‚æ•°**: `deviceId: ä»å½“å‰é€‰ä¸­çš„è®¾å¤‡è·å–` (çµæ´»å˜åŒ–)

**ç•Œé¢äº¤äº’**ï¼šæ¯ä¸ªå‚æ•°è¡Œæœ‰ä¸€ä¸ª"åŠ¨æ€å‚æ•°"å‹¾é€‰æ¡†
```
å‚æ•°å: [deviceId     ] å‚æ•°å€¼: [device123  ] [â˜ åŠ¨æ€å‚æ•°] [æè¿°...]
å‚æ•°å: [timestamp   ] å‚æ•°å€¼: [é€‰æ‹©å‚æ•°æº â–¼] [â˜‘ åŠ¨æ€å‚æ•°] [æè¿°...]
```

### ğŸ¯ åŠ¨æ€å‚æ•°æ•°æ®æºæ¶æ„

åŸºäºé¡¹ç›®ç°æœ‰çš„Storeæ¶æ„ï¼ŒåŠ¨æ€å‚æ•°æ¥æºåˆ†ä¸ºå››å¤§ç±»ï¼š

```typescript
/**
 * åŠ¨æ€å‚æ•°æ•°æ®æº - ç®€åŒ–è¯´æ˜
 */
interface DynamicParameterSources {
  // ğŸ“Š ç»„ä»¶æ•°æ® (å½“å‰é¡µé¢/ç»„ä»¶çš„æ•°æ®)
  componentData: {
    selectedDeviceId: string      // å½“å‰é€‰ä¸­çš„è®¾å¤‡ID
    selectedTimeRange: string     // å½“å‰é€‰ä¸­çš„æ—¶é—´èŒƒå›´  
    chartType: string            // å›¾è¡¨ç±»å‹
    filterConditions: any        // ç­›é€‰æ¡ä»¶
  }
  
  // ğŸŒ å…¨å±€çŠ¶æ€ (æ•´ä¸ªç³»ç»Ÿçš„å…±äº«æ•°æ®)  
  globalState: {
    currentUserId: string        // å½“å‰ç™»å½•ç”¨æˆ·ID
    authToken: string           // è®¤è¯ä»¤ç‰Œ
    selectedDevice: any         // å…¨å±€é€‰ä¸­è®¾å¤‡
    isDarkMode: boolean         // ä¸»é¢˜æ¨¡å¼
  }
  
  // âš™ï¸ ç¯å¢ƒå˜é‡ (ç³»ç»Ÿé…ç½®)
  environmentVars: {
    apiBaseUrl: string          // APIæœåŠ¡å™¨åœ°å€
    apiKey: string              // APIå¯†é’¥
    tenantId: string            // ç§Ÿæˆ·ID
    version: string             // ç³»ç»Ÿç‰ˆæœ¬
  }
  
  // ğŸ”„ è®¡ç®—å€¼ (åŠ¨æ€ç”Ÿæˆçš„å€¼)  
  computedValues: {
    currentTimestamp: number     // å½“å‰æ—¶é—´æˆ³
    formatTime: () => string     // æ ¼å¼åŒ–æ—¶é—´
    generateId: () => string     // ç”Ÿæˆå”¯ä¸€ID
    deviceStatus: (id: string) => 'online' | 'offline'  // è®¾å¤‡çŠ¶æ€åˆ¤æ–­
  }
}
```

### ğŸ¨ åŠ¨æ€å‚æ•°é€‰æ‹©å™¨UIè®¾è®¡

å½“ç”¨æˆ·å‹¾é€‰"åŠ¨æ€å‚æ•°"åï¼Œvalueè¾“å…¥æ¡†å˜ä¸ºå‚æ•°æºé€‰æ‹©å™¨ï¼š

```vue
<template>
  <!-- åŠ¨æ€å‚æ•°é€‰æ‹©å™¨ -->
  <n-cascader
    v-if="param.isDynamic"
    v-model:value="param.value"
    :options="parameterSourceOptions"
    placeholder="é€‰æ‹©å‚æ•°æº"
    check-strategy="child"
    :show-path="false"
    clearable
  />
  
  <!-- é™æ€å€¼è¾“å…¥æ¡† -->
  <n-input
    v-else
    v-model:value="param.value"
    placeholder="è¯·è¾“å…¥é™æ€å€¼"
  />
</template>
```

**å‚æ•°æºé€‰æ‹©å™¨é€‰é¡¹ç»“æ„**ï¼š
```typescript
const parameterSourceOptions = [
  {
    label: 'ç»„ä»¶æ•°æ®',
    key: 'componentData',
    children: [
      { label: 'å½“å‰ç»„ä»¶ID', key: 'componentData.currentComponentId', value: 'componentData.currentComponentId' },
      { label: 'é€‰ä¸­è®¾å¤‡ID', key: 'componentData.selectedDeviceId', value: 'componentData.selectedDeviceId' },
      { label: 'æ—¶é—´èŒƒå›´', key: 'componentData.selectedTimeRange', value: 'componentData.selectedTimeRange' }
    ]
  },
  {
    label: 'å…¨å±€çŠ¶æ€',
    key: 'globalState',
    children: [
      { label: 'å½“å‰ç”¨æˆ·', key: 'globalState.currentUser.id', value: 'globalState.currentUser.id' },
      { label: 'è®¤è¯ä»¤ç‰Œ', key: 'globalState.authToken', value: 'globalState.authToken' },
      { label: 'é€‰ä¸­è®¾å¤‡', key: 'globalState.selectedDevice.id', value: 'globalState.selectedDevice.id' }
    ]
  },
  {
    label: 'ç¯å¢ƒå˜é‡',
    key: 'environmentVars', 
    children: [
      { label: 'APIåœ°å€', key: 'environmentVars.apiBaseUrl', value: 'environmentVars.apiBaseUrl' },
      { label: 'APIå¯†é’¥', key: 'environmentVars.apiKey', value: 'environmentVars.apiKey' },
      { label: 'ç§Ÿæˆ·ID', key: 'environmentVars.tenantId', value: 'environmentVars.tenantId' }
    ]
  },
  {
    label: 'è®¡ç®—å€¼',
    key: 'computedValues',
    children: [
      { label: 'å½“å‰æ—¶é—´æˆ³', key: 'computedValues.currentTimestamp', value: 'computedValues.currentTimestamp' },
      { label: 'æ ¼å¼åŒ–æ—¶é—´', key: 'computedValues.formatTime', value: 'computedValues.formatTime()' },
      { label: 'ç”ŸæˆID', key: 'computedValues.generateId', value: 'computedValues.generateId()' }
    ]
  }
]
```

### ğŸ”§ åŠ¨æ€å‚æ•°è¿è¡Œæ—¶ç®¡ç†æœºåˆ¶

**æ ¸å¿ƒé—®é¢˜**: åŠ¨æ€å‚æ•°é…ç½®å¥½ä¹‹åï¼Œ**è¿è¡Œæ—¶æ€ä¹ˆè·å–ã€æ›´æ–°ã€ä½¿ç”¨è¿™äº›å‚æ•°å€¼ï¼Ÿ**

```typescript
/**
 * åŠ¨æ€å‚æ•°è¿è¡Œæ—¶ç®¡ç†å™¨
 * èŒè´£ï¼šåœ¨HTTPè¯·æ±‚æ‰§è¡Œæ—¶ï¼Œå®æ—¶è·å–åŠ¨æ€å‚æ•°çš„å®é™…å€¼
 */
class DynamicParameterManager {
  
  // ç¬¬1æ­¥ï¼šè·å–å‚æ•°æºæ•°æ®
  private getDataSources() {
    return {
      // ç»„ä»¶æ•°æ®ï¼šä»å½“å‰Visual Editorç»„ä»¶è·å–
      componentData: {
        selectedDeviceId: this.getCurrentComponent().deviceId,
        selectedTimeRange: this.getCurrentComponent().timeRange,
        chartType: this.getCurrentComponent().chartType
      },
      
      // å…¨å±€çŠ¶æ€ï¼šä»Pinia Storeè·å–
      globalState: {
        currentUserId: useAuthStore().userInfo?.id,
        authToken: useAuthStore().token,
        selectedDevice: useDeviceStore().currentDevice
      },
      
      // ç³»ç»Ÿå˜é‡ï¼šä»ç¯å¢ƒå’Œæœ¬åœ°å­˜å‚¨è·å–
      systemVars: {
        apiBaseUrl: import.meta.env.VITE_API_BASE_URL,
        currentTimestamp: Date.now(),
        tenantId: localStorage.getItem('tenantId')
      }
    }
  }
  
  // ç¬¬2æ­¥ï¼šè§£æå‚æ•°è·¯å¾„ï¼Œè·å–å®é™…å€¼
  resolveParameter(paramPath: string) {
    const dataSources = this.getDataSources()
    
    // ä¾‹å¦‚: "componentData.selectedDeviceId" 
    // æ‹†åˆ†ä¸º: ["componentData", "selectedDeviceId"]
    const [sourceType, ...keyPath] = paramPath.split('.')
    
    // ä»æ•°æ®æºä¸­æŒ‰è·¯å¾„è·å–å€¼
    let value = dataSources[sourceType]
    for (const key of keyPath) {
      value = value?.[key]
    }
    
    return value
  }
  
  // ç¬¬3æ­¥ï¼šå¤„ç†HTTPè¯·æ±‚å‚æ•°
  buildHttpParams(config: HttpDataSourceConfig) {
    const result = {
      headers: {},
      requestData: {}  // ç»Ÿä¸€çš„è¯·æ±‚æ•°æ®ï¼Œç³»ç»Ÿè‡ªåŠ¨å†³å®šæ”¾URLè¿˜æ˜¯Body
    }
    
    // å¤„ç†Headerså‚æ•°
    config.headers.forEach(header => {
      if (!header.enabled) return
      
      if (header.isDynamic) {
        const value = this.resolveParameter(header.value)
        if (value !== undefined) {
          result.headers[header.key] = value
        }
        // å¦‚æœè·å–ä¸åˆ°å€¼ï¼Œè¿™ä¸ªheaderå°±ä¸å‘é€
      } else {
        result.headers[header.key] = header.value
      }
    })
    
    // å¤„ç†è¯·æ±‚å‚æ•°ï¼ˆé‡ç‚¹ï¼‰
    config.requestParams.forEach(param => {
      if (!param.enabled) return
      
      if (param.isDynamic) {
        const value = this.resolveParameter(param.value)
        if (value !== undefined) {
          result.requestData[param.key] = this.convertDataType(value, param.dataType)
        }
        // å¦‚æœè·å–ä¸åˆ°å€¼ï¼Œä½¿ç”¨é»˜è®¤å€¼æˆ–è€…ä¸å‘é€
      } else {
        result.requestData[param.key] = this.convertDataType(param.value, param.dataType)
      }
    })
    
    return result
  }
}
```

### ğŸ“‹ å®é™…ä½¿ç”¨æµç¨‹ç¤ºä¾‹

**åœºæ™¯**: ç”¨æˆ·åœ¨å¯è§†åŒ–ç¼–è¾‘å™¨ä¸­æ·»åŠ äº†ä¸€ä¸ªå›¾è¡¨ç»„ä»¶ï¼Œéœ€è¦è·å–å½“å‰é€‰ä¸­è®¾å¤‡çš„æ¸©åº¦æ•°æ®

```typescript
// 1. ç”¨æˆ·é…ç½®äº†HTTPæ•°æ®æº
const httpConfig = {
  url: "http://api.example.com/device/data",
  method: "POST",
  requestParams: [
    {
      key: "deviceId",
      value: "componentData.selectedDeviceId",  // åŠ¨æ€å‚æ•°
      isDynamic: true,
      dataType: "string"
    },
    {
      key: "dataType", 
      value: "temperature",                     // é™æ€å‚æ•°
      isDynamic: false,
      dataType: "string"
    },
    {
      key: "timestamp",
      value: "systemVars.currentTimestamp",     // åŠ¨æ€å‚æ•°
      isDynamic: true,
      dataType: "number"
    }
  ]
}

// 2. ç³»ç»Ÿæ‰§è¡ŒHTTPè¯·æ±‚æ—¶çš„å¤„ç†è¿‡ç¨‹
class HttpExecutor {
  async executeRequest(config: HttpDataSourceConfig) {
    const paramManager = new DynamicParameterManager()
    
    // è§£ææ‰€æœ‰åŠ¨æ€å‚æ•°
    const resolvedParams = paramManager.buildHttpParams(config)
    
    console.log("è§£æç»“æœ:", resolvedParams.requestData)
    // è¾“å‡º: {
    //   deviceId: "device_123",        // ä»å½“å‰ç»„ä»¶è·å–
    //   dataType: "temperature",       // é™æ€å€¼
    //   timestamp: 1693123456789       // ç³»ç»Ÿå½“å‰æ—¶é—´
    // }
    
    // æ ¹æ®è¯·æ±‚æ–¹å¼æ™ºèƒ½å¤„ç†å‚æ•°
    let requestOptions: RequestInit
    if (config.method === 'GET') {
      // GETè¯·æ±‚ï¼šå‚æ•°æ”¾URL
      const urlParams = new URLSearchParams(resolvedParams.requestData)
      requestOptions = {
        method: 'GET',
        headers: resolvedParams.headers
      }
      config.url += '?' + urlParams.toString()
    } else {
      // POST/PUT/DELETEï¼šå‚æ•°æ”¾Body
      requestOptions = {
        method: config.method,
        headers: {
          ...resolvedParams.headers,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(resolvedParams.requestData)
      }
    }
    
    // å‘é€HTTPè¯·æ±‚
    const response = await fetch(config.url, requestOptions)
    
    return response.json()
  }
}
```

### âš¡ å‚æ•°å˜åŒ–ç›‘å¬å’Œé˜²æŠ–æœºåˆ¶

```typescript
class HttpRequestManager {
  private debounceTimers = new Map<string, NodeJS.Timeout>()
  
  // ç›‘å¬å‚æ•°å˜åŒ–å¹¶é˜²æŠ–æ‰§è¡Œ
  setupParameterWatcher(config: HttpDataSourceConfig, onDataUpdate: (data: any) => void) {
    // 1. ç›‘å¬ç»„ä»¶æ•°æ®å˜åŒ–
    const component = this.getCurrentComponent()
    watch(() => component.config, () => {
      this.executeWithDebounce(config, onDataUpdate)
    }, { deep: true })
    
    // 2. ç›‘å¬å…¨å±€çŠ¶æ€å˜åŒ–  
    const authStore = useAuthStore()
    watch(() => authStore.token, () => {
      this.executeWithDebounce(config, onDataUpdate)
    })
  }
  
  // é˜²æŠ–æ‰§è¡ŒHTTPè¯·æ±‚
  private executeWithDebounce(config: HttpDataSourceConfig, callback: (data: any) => void) {
    const requestKey = this.generateRequestKey(config)
    
    // æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–å®šæ—¶å™¨
    if (this.debounceTimers.has(requestKey)) {
      clearTimeout(this.debounceTimers.get(requestKey)!)
    }
    
    const timer = setTimeout(async () => {
      try {
        const paramManager = new DynamicParameterManager()
        const resolvedParams = paramManager.buildHttpParams(config)
        
        // æ ¹æ®è¯·æ±‚æ–¹å¼æ™ºèƒ½å¤„ç†å‚æ•°
        let requestOptions: RequestInit
        if (config.method === 'GET') {
          // GETè¯·æ±‚ï¼šå‚æ•°æ”¾URL
          const urlParams = new URLSearchParams(resolvedParams.requestData)
          requestOptions = {
            method: 'GET',
            headers: resolvedParams.headers
          }
          config.url += '?' + urlParams.toString()
        } else {
          // POST/PUT/DELETEï¼šå‚æ•°æ”¾Body
          requestOptions = {
            method: config.method,
            headers: {
              ...resolvedParams.headers,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(resolvedParams.requestData)
          }
        }
        
        const response = await fetch(config.url, requestOptions)
        
        const data = await response.json()
        callback(data) // æ›´æ–°ç»„ä»¶æ•°æ®
      } catch (error) {
        console.error('HTTPè¯·æ±‚å¤±è´¥:', error)
      } finally {
        this.debounceTimers.delete(requestKey)
      }
    }, 500) // 500msé˜²æŠ–
    
    this.debounceTimers.set(requestKey, timer)
  }
}
```

### ğŸ¯ æ€»ç»“ï¼šåŠ¨æ€å‚æ•°ä½¿ç”¨æœºåˆ¶

**æ ¸å¿ƒæµç¨‹**:
1. **é…ç½®é˜¶æ®µ**: ç”¨æˆ·é€‰æ‹©å‚æ•°æ¥æºï¼ˆå¦‚"ç»„ä»¶æ•°æ®.è®¾å¤‡ID"ï¼‰
2. **è¿è¡Œé˜¶æ®µ**: ç³»ç»Ÿå®æ—¶ä»æ•°æ®æºè·å–å®é™…å€¼
3. **ç›‘å¬é˜¶æ®µ**: æ•°æ®æºå˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘é‡æ–°è¯·æ±‚
4. **ä¼˜åŒ–é˜¶æ®µ**: é˜²æŠ–é¿å…é¢‘ç¹è¯·æ±‚ï¼Œç¼“å­˜æå‡æ€§èƒ½

**å…³é”®æœºåˆ¶**:
- **å®æ—¶è§£æ**: æ¯æ¬¡è¯·æ±‚æ—¶éƒ½é‡æ–°è·å–åŠ¨æ€å‚æ•°å€¼
- **æ™ºèƒ½ç›‘å¬**: åªç›‘å¬å®é™…ä½¿ç”¨çš„æ•°æ®æºå˜åŒ–
- **é˜²æŠ–ä¼˜åŒ–**: å‚æ•°å¿«é€Ÿå˜åŒ–æ—¶ç­‰å¾…ç¨³å®šåå†å‘è¯·æ±‚
- **ç¼“å­˜ç­–ç•¥**: ç›¸åŒå‚æ•°çš„è¯·æ±‚ç»“æœå¯ä»¥ç¼“å­˜å¤ç”¨

**åœ¨Visual Editorçš„HTTPæ•°æ®æºä¸­ä½¿ç”¨**:
```typescript
export class HttpDataSource {
  private requestManager = new HttpRequestManager()
  
  async initialize(config: HttpDataSourceConfig) {
    // 1. è®¾ç½®å‚æ•°å˜åŒ–ç›‘å¬
    this.requestManager.setupParameterWatcher(config, (data) => {
      this.updateComponentData(data) // å‚æ•°å˜åŒ–æ—¶é‡æ–°è·å–æ•°æ®
    })
    
    // 2. åˆå§‹æ•°æ®è·å–
    await this.refreshData()
  }
  
  async refreshData() {
    try {
      // ä½¿ç”¨é˜²æŠ–æœºåˆ¶æ‰§è¡ŒHTTPè¯·æ±‚
      const data = await this.requestManager.executeWithDebounce(this.config, (data) => {
        this.updateComponentData(data)
      })
    } catch (error) {
      console.error('HTTPè¯·æ±‚å¤±è´¥:', error)
    }
  }
}
```

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### SUBTASK-008å®Œæˆæ ‡å‡†  
- [x] âœ… ç°æœ‰HttpConfigForm.vueåŸºç¡€ç»„ä»¶å·²åˆ†æ
- [x] âœ… å®ŒæˆHTTPé…ç½®éœ€æ±‚è¯¦ç»†è°ƒç ”  
- [x] âœ… æ˜ç¡®HTTPé…ç½®åŠŸèƒ½è¾¹ç•Œå’Œè§„æ ¼
- [x] âœ… è®¾è®¡HTTPé…ç½®ä¸æ•°æ®æ‰§è¡Œå™¨çš„é›†æˆæ–¹æ¡ˆ
- [x] âœ… åˆ¶å®šHTTPé…ç½®å¼€å‘çš„åˆ†æ­¥è®¡åˆ’
- [x] âœ… ä¼˜åŒ–åŠ¨æ€å‚æ•°è®¾è®¡æ–¹æ¡ˆ(åŸºäºç”¨æˆ·åé¦ˆ)
- [x] âœ… è®¾è®¡å®Œæ•´çš„åŠ¨æ€å‚æ•°ç®¡ç†ç³»ç»Ÿ
- [x] âœ… ç¡®è®¤æ‰€æœ‰éœ€æ±‚ç»†èŠ‚å’ŒæŠ€æœ¯å®ç°æ–¹æ¡ˆ

### ğŸ“‹ æ ¸å¿ƒäº¤ä»˜æˆæœ
1. **å®Œæ•´çš„æ•°æ®ç»“æ„è®¾è®¡** - æ”¯æŒHeaderså’ŒBodyå‚æ•°çš„åŠ¨æ€é…ç½®
2. **é¡µç­¾å¼ç•Œé¢è®¾è®¡æ–¹æ¡ˆ** - 5ä¸ªé¡µç­¾çš„è¯¦ç»†äº¤äº’è®¾è®¡
3. **åŠ¨æ€å‚æ•°ç®¡ç†ç³»ç»Ÿ** - DynamicParameterManagerå®Œæ•´å®ç°æ–¹æ¡ˆ
4. **æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ** - é˜²æŠ–æœºåˆ¶å’Œç¼“å­˜ç­–ç•¥
5. **é¢„åˆ¶æ¨¡æ¿ç³»ç»Ÿè®¾è®¡** - JSONå¯¼å…¥å¯¼å‡ºåŠŸèƒ½è§„åˆ’
6. **æŠ€æœ¯é›†æˆæ–¹æ¡ˆ** - ä¸ç°æœ‰é¡¹ç›®æ¶æ„çš„æ— ç¼é›†æˆ

### ğŸ“‹ åç»­å­ä»»åŠ¡è®¡åˆ’ (åŸºäºæœ¬è®¾è®¡æ–‡æ¡£)
1. **SUBTASK-009**: HttpConfigFormé¡µç­¾å¼ç•Œé¢é‡æ„å®ç°
   - å®ç°5ä¸ªé¡µç­¾çš„å®Œæ•´UIç•Œé¢
   - é›†æˆåŠ¨æ€å‚æ•°é€‰æ‹©å™¨ (n-cascader)
   - å®ç°è¡¨å•éªŒè¯å’Œå¿…å¡«å­—æ®µæ£€æŸ¥

2. **SUBTASK-010**: åŠ¨æ€å‚æ•°ç®¡ç†ç³»ç»Ÿå¼€å‘
   - å®ç°DynamicParameterManagerç±»
   - å®ç°HttpRequestDebounceré˜²æŠ–æœºåˆ¶
   - é›†æˆç°æœ‰Storeæ¶æ„ (auth/device/theme/visual-editor)

3. **SUBTASK-011**: é¢„åˆ¶æ¨¡æ¿ç³»ç»Ÿå®ç°  
   - å®ç°HttpConfigTemplateManagerç±»
   - åˆ›å»ºé¢„åˆ¶æ¨¡æ¿æ–‡ä»¶å’ŒJSONå¯¼å…¥åŠŸèƒ½
   - æä¾›æ•°æ®ç±»å‹å’Œç¤ºä¾‹ç»™ç”¨æˆ·

4. **SUBTASK-012**: HTTPæ‰§è¡Œå™¨å¢å¼ºå’Œé›†æˆ
   - æ‰©å±•UnifiedDataExecutorçš„HttpExecutor
   - é›†æˆåŠ¨æ€å‚æ•°è§£æåˆ°è¯·æ±‚æ‰§è¡Œæµç¨‹
   - å®ç°è¯·æ±‚å‰åè„šæœ¬å¤„ç†é›†æˆ

5. **SUBTASK-013**: RawDataConfigModalé›†æˆå’Œæµ‹è¯•
   - å°†HTTPé…ç½®æ ‡è®°ä¸ºavailable: true
   - å®ç°å‘åå…¼å®¹çš„æ•°æ®ç»“æ„è¿ç§»
   - å®Œæ•´çš„ç³»ç»Ÿé›†æˆæµ‹è¯•å’Œæ€§èƒ½éªŒè¯

---

## ğŸ¯ æ–‡æ¡£æ€»ç»“

æœ¬æ–‡æ¡£å®Œæˆäº†HTTPåŠ¨æ€å‚æ•°é…ç½®ç³»ç»Ÿçš„å®Œæ•´éœ€æ±‚åˆ†æå’ŒæŠ€æœ¯è®¾è®¡ï¼Œæ ¸å¿ƒæˆæœåŒ…æ‹¬ï¼š

### âœ… éœ€æ±‚ç¡®è®¤
- **ç»Ÿä¸€è¯·æ±‚å‚æ•°é…ç½®** - å•ä¸€requestParamsæ•°ç»„ï¼Œç³»ç»Ÿæ™ºèƒ½å¤„ç†GETâ†’URLå‚æ•°ï¼ŒPOST/PUT/DELETEâ†’Bodyå‚æ•°
- **Headerså‚æ•°ç‹¬ç«‹æ”¯æŒ** - è¯·æ±‚å¤´ç‹¬ç«‹é…ç½®ï¼Œä¸»è¦ç”¨äºè®¤è¯å’Œå…ƒæ•°æ®
- **è¡¨å•ä¸¥æ ¼éªŒè¯** - é™¤è„šæœ¬å¤–æ‰€æœ‰å­—æ®µå¿…å¡«ï¼Œæ ¡éªŒé€šè¿‡åè‡ªåŠ¨å‘é€è¯·æ±‚
- **é˜²æŠ–æ€§èƒ½ä¼˜åŒ–** - é¿å…å‚æ•°é¢‘ç¹å˜åŒ–å¯¼è‡´çš„è¿‡åº¦è¯·æ±‚

### ğŸ—ï¸ æŠ€æœ¯æ¶æ„
- **å››å¤§æ•°æ®æº** - componentData/globalState/systemVars/computedValues
- **è¿è¡Œæ—¶ç®¡ç†å™¨** - DynamicParameterManagerå®æ—¶è·å–å’Œè§£æåŠ¨æ€å‚æ•°
- **UIç»„ä»¶è®¾è®¡** - å‹¾é€‰æ¡†æ§åˆ¶+çº§è”é€‰æ‹©å™¨ï¼Œç”¨æˆ·å‹å¥½çš„äº¤äº’ä½“éªŒ
- **ç›‘å¬å’Œé˜²æŠ–** - æ™ºèƒ½ç›‘å¬æ•°æ®æºå˜åŒ–ï¼Œé˜²æŠ–ä¼˜åŒ–é¿å…è¿‡åº¦è¯·æ±‚

### ğŸ“‹ å®æ–½ä¿éšœ
- **åŸºäºç°æœ‰æ¶æ„** - å¤ç”¨é¡¹ç›®Storeç³»ç»Ÿï¼Œæ— æ¶æ„å†²çª
- **å®Œæ•´ä½¿ç”¨æµç¨‹** - ä»é…ç½®åˆ°è¿è¡Œçš„è¯¦ç»†ç¤ºä¾‹å’Œé›†æˆæ–¹æ¡ˆ
- **åˆ†æ­¥å®æ–½è®¡åˆ’** - 5ä¸ªå­ä»»åŠ¡çš„è¯¦ç»†å¼€å‘è®¡åˆ’
- **æ€§èƒ½å’Œé”™è¯¯å¤„ç†** - é˜²æŠ–æœºåˆ¶ã€ç¼“å­˜ç­–ç•¥ã€é”™è¯¯å¤„ç†ç­‰

---

**æ–‡æ¡£çŠ¶æ€**: æœ€ç»ˆå®Œæ•´æ–¹æ¡ˆï¼Œå¯ç›´æ¥ç”¨äºå¼€å‘å®æ–½  
**åˆ›å»ºæ—¶é—´**: 2025-08-28  
**æœ€åæ›´æ–°**: 2025-08-28 (åŒ…å«å®Œæ•´åŠ¨æ€å‚æ•°ç®¡ç†ç³»ç»Ÿè®¾è®¡)  
**æ€»é¡µæ•°**: ~50é¡µ (åŒ…å«è¯¦ç»†ä»£ç ç¤ºä¾‹å’ŒæŠ€æœ¯æ–¹æ¡ˆ)