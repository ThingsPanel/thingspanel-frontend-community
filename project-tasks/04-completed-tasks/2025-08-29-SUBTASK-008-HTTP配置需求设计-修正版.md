# SUBTASK-008: HTTPé…ç½®éœ€æ±‚è®¾è®¡ï¼ˆå®Œå–„ç‰ˆï¼‰

*åˆ›å»ºæ—¶é—´: 2025-08-29*  
*ä¿®æ­£æ—¶é—´: 2025-08-29*  
*å®Œå–„æ—¶é—´: 2025-08-29*  
*æ–‡æ¡£ç‰ˆæœ¬: v2.2 å®Œå–„ç‰ˆ*  
*ä»»åŠ¡ç›®æ ‡: å®Œå–„åŠ¨æ€å‚æ•°è®¾è®¡é€»è¾‘ï¼Œæä¾›å¯ç›´æ¥å®æ–½çš„æŠ€æœ¯æ–¹æ¡ˆ*

---

## ğŸš¨ **ä¿®æ­£è¯´æ˜**

åŸæ–‡æ¡£åœ¨åŠ¨æ€å‚æ•°è®¾è®¡ä¸Šå­˜åœ¨å¤šå¤„é€»è¾‘é”™è¯¯ï¼Œæœ¬ä¿®æ­£ç‰ˆåŸºäºä»¥ä¸‹æ ¸å¿ƒç†å¿µé‡æ–°è®¾è®¡ï¼š

### âœ… **æ­£ç¡®ç†è§£ï¼šåŠ¨æ€å‚æ•°çš„æœ¬è´¨**
- **isDynamic = true** æ—¶ï¼Œ`value` å­—æ®µå­˜å‚¨çš„æ˜¯**ç¤ºä¾‹å€¼/é»˜è®¤å€¼**
- **variableName** è‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ï¼š`var_${key}`ï¼ˆç®€æ´æ˜ç¡®ï¼‰
- **æ²¡æœ‰æ˜ å°„æ—¶** = ç›´æ¥ä½¿ç”¨ç¤ºä¾‹å€¼ä½œä¸ºé™æ€å€¼æ‰§è¡Œ
- **æœ‰æ˜ å°„æ—¶** = ç”¨æ˜ å°„çš„çœŸå®å€¼æ›¿æ¢ç¤ºä¾‹å€¼

### âŒ **åŸè®¾è®¡çš„é”™è¯¯**
- ä½¿ç”¨ `{{placeholder}}` æ¨¡æ¿è¯­æ³•ä½œä¸ºvalueï¼ˆè¿™ä¸æ˜¯ç¤ºä¾‹å€¼ï¼‰
- è¿‡åº¦å¤æ‚çš„"æ¨¡æ¿+å ä½ç¬¦"æ›¿æ¢æœºåˆ¶
- URLä¸­åµŒå…¥å ä½ç¬¦çš„é”™è¯¯åšæ³•
- æ··æ·†äº†é…ç½®å±‚é¢å’Œæ‰§è¡Œå±‚é¢çš„èŒè´£

---

## ğŸ”§ **ä¿®æ­£åçš„æŠ€æœ¯æ–¹æ¡ˆ**

### 1. ç±»å‹ç³»ç»Ÿï¼ˆå®Œå–„ç‰ˆï¼‰

#### ç»Ÿä¸€å‚æ•°æ¥å£
```typescript
export interface HttpParameter {
  key: string
  value: string | number | boolean        // ç¤ºä¾‹å€¼ï¼Œç±»å‹ä¸dataTypeåŒ¹é…
  enabled: boolean
  isDynamic: boolean              
  dataType: 'string' | 'number' | 'boolean' | 'json'
  variableName: string                     // åŠ¨æ€æ—¶è‡ªåŠ¨ç”Ÿæˆï¼švar_ + keyçš„snake_case
  description: string                      // å‚æ•°è¯´æ˜ï¼Œå¿…å¡«
}

export interface HttpHeader extends HttpParameter {}
export interface HttpParam extends HttpParameter {}
```

#### HTTPé…ç½®æ¥å£
```typescript
export interface HttpConfig {
  url: string
  method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH'
  timeout: number
  headers: HttpHeader[]
  params: HttpParam[]
  body?: string
  preRequestScript?: string                // è¯·æ±‚å‰å¤„ç†è„šæœ¬
  postResponseScript?: string              // å“åº”åå¤„ç†è„šæœ¬
}
```

### 2. æ­£ç¡®çš„ç¤ºä¾‹é…ç½®

#### âœ… å®Œæ•´é…ç½®ç¤ºä¾‹
```typescript
// è®¾å¤‡é¥æµ‹æ•°æ®æ¥å£é…ç½®
const deviceTelemetryConfig: HttpConfig = {
  url: '/api/telemetry/data/history/list',
  method: 'GET',
  timeout: 15000,
  headers: [
    {
      key: 'Accept',
      value: 'application/json',
      enabled: true,
      isDynamic: false,
      dataType: 'string',
      variableName: '',
      description: 'HTTP Acceptå¤´'
    },
    {
      key: 'User-Agent',
      value: 'ThingsPanel/1.0',
      enabled: true,
      isDynamic: false,
      dataType: 'string',
      variableName: '',
      description: 'ç”¨æˆ·ä»£ç†æ ‡è¯†'
    }
  ],
  params: [
    {
      key: 'device_id',
      value: 'device_001',
      enabled: true,
      isDynamic: true,
      dataType: 'string',
      variableName: 'var_device_id',
      description: 'è®¾å¤‡ID'
    },
    {
      key: 'key',
      value: 'temperature',
      enabled: true,
      isDynamic: true,
      dataType: 'string',
      variableName: 'var_key',
      description: 'æŒ‡æ ‡é”®å'
    },
    {
      key: 'start_time',
      value: Date.now() - 3600000,   // 1å°æ—¶å‰çš„æ—¶é—´æˆ³
      enabled: true,
      isDynamic: true,
      dataType: 'number',
      variableName: 'var_start_time',
      description: 'å¼€å§‹æ—¶é—´æˆ³'
    },
    {
      key: 'end_time',
      value: Date.now(),             // å½“å‰æ—¶é—´æˆ³
      enabled: true,
      isDynamic: true,
      dataType: 'number',
      variableName: 'var_end_time',
      description: 'ç»“æŸæ—¶é—´æˆ³'
    },
    {
      key: 'aggregate_window',
      value: 'no_aggregate',
      enabled: true,
      isDynamic: false,
      dataType: 'string',
      variableName: '',
      description: 'èšåˆçª—å£'
    }
  ],
  preRequestScript: `
// åŠ¨æ€è®¡ç®—æ—¶é—´èŒƒå›´
if (!dynamicValues.var_start_time) {
  config.params.start_time = Date.now() - 3600000
}
if (!dynamicValues.var_end_time) {
  config.params.end_time = Date.now()
}
return config`,
  postResponseScript: `
// è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®æ ¼å¼
if (response.data && Array.isArray(response.data)) {
  return response.data.map(item => [item.x || item.timestamp, item.y || item.value])
}
return response.data || response`
}
```

### 3. å®Œæ•´çš„æ‰§è¡Œé€»è¾‘

#### å·¥å…·å‡½æ•°
```typescript
/**
 * å˜é‡åç”Ÿæˆå™¨ - å°†keyè½¬æ¢ä¸ºsnake_caseæ ¼å¼çš„å˜é‡å
 */
export function generateVariableName(key: string): string {
  return `var_${key
    .replace(/([A-Z])/g, '_$1')      // é©¼å³°è½¬ä¸‹åˆ’çº¿
    .toLowerCase()                    // è½¬å°å†™
    .replace(/[^a-z0-9_]/g, '_')     // éæ³•å­—ç¬¦è½¬ä¸‹åˆ’çº¿
    .replace(/_+/g, '_')             // å¤šä¸ªä¸‹åˆ’çº¿åˆå¹¶
    .replace(/^_|_$/g, '')           // å»æ‰é¦–å°¾ä¸‹åˆ’çº¿
  }`
}

/**
 * ç±»å‹è½¬æ¢å™¨ - å°†å€¼è½¬æ¢ä¸ºæŒ‡å®šæ•°æ®ç±»å‹
 */
export function convertValue(value: any, dataType: string): any {
  if (value === null || value === undefined) return value

  switch (dataType) {
    case 'string': 
      return String(value)
    case 'number': 
      const num = Number(value)
      return isNaN(num) ? 0 : num
    case 'boolean': 
      if (typeof value === 'boolean') return value
      if (typeof value === 'string') return value.toLowerCase() === 'true'
      return Boolean(value)
    case 'json': 
      if (typeof value === 'object') return value
      if (typeof value === 'string') {
        try { return JSON.parse(value) } 
        catch { return {} }
      }
      return value
    default: 
      return value
  }
}
```

#### å‚æ•°è§£æå™¨ï¼ˆå®Œå–„ç‰ˆï¼‰
```typescript
export class ParameterResolver {
  /**
   * è§£æå‚æ•°å€¼ - ç»Ÿä¸€å¤„ç†HttpHeaderå’ŒHttpParam
   */
  resolveValue(param: HttpParameter, dynamicValues: Record<string, any> = {}): any {
    let finalValue: any

    if (param.isDynamic && dynamicValues[param.variableName] !== undefined) {
      // åŠ¨æ€å‚æ•°ä¸”æœ‰æ˜ å°„å€¼ï¼šä½¿ç”¨æ˜ å°„å€¼
      finalValue = dynamicValues[param.variableName]
    } else {
      // é™æ€å‚æ•°æˆ–åŠ¨æ€å‚æ•°æ— æ˜ å°„ï¼šä½¿ç”¨é…ç½®å€¼
      finalValue = param.value
    }

    // ç±»å‹è½¬æ¢
    return convertValue(finalValue, param.dataType)
  }

  /**
   * æ‰¹é‡è§£æå‚æ•°æ•°ç»„
   */
  resolveParameters(params: HttpParameter[], dynamicValues: Record<string, any> = {}): Record<string, any> {
    const result: Record<string, any> = {}
    
    params
      .filter(param => param.enabled)
      .forEach(param => {
        result[param.key] = this.resolveValue(param, dynamicValues)
      })

    return result
  }
}
```

#### è„šæœ¬æ‰§è¡Œå™¨
```typescript
export class ScriptExecutor {
  /**
   * æ‰§è¡Œè¯·æ±‚å‰è„šæœ¬
   */
  async executePreRequestScript(script: string, config: any, dynamicValues: Record<string, any>): Promise<any> {
    if (!script?.trim()) return config

    try {
      const func = new Function('config', 'dynamicValues', script)
      const result = func(config, dynamicValues)
      return result || config
    } catch (error) {
      console.error('PreRequestScriptæ‰§è¡Œå¤±è´¥:', error)
      return config
    }
  }

  /**
   * æ‰§è¡Œå“åº”åè„šæœ¬
   */
  async executePostResponseScript(script: string, response: any, config: any): Promise<any> {
    if (!script?.trim()) return response

    try {
      const func = new Function('response', 'config', script)
      const result = func(response, config)
      return result !== undefined ? result : response
    } catch (error) {
      console.error('PostResponseScriptæ‰§è¡Œå¤±è´¥:', error)
      return response
    }
  }
}
```

#### HTTPæ‰§è¡Œå™¨ï¼ˆå®Œæ•´ç‰ˆï¼‰
```typescript
import { request } from '@/service/request'

export class HttpExecutor {
  private resolver = new ParameterResolver()
  private scriptExecutor = new ScriptExecutor()

  async execute(config: HttpConfig, dynamicValues: Record<string, any> = {}): Promise<any> {
    try {
      // 1. è¯·æ±‚å‰è„šæœ¬å¤„ç†
      let processedConfig = { ...config }
      if (config.preRequestScript) {
        processedConfig = await this.scriptExecutor.executePreRequestScript(
          config.preRequestScript, 
          processedConfig, 
          dynamicValues
        )
      }

      // 2. è§£æheaderså’Œparams
      const headers = this.resolver.resolveParameters(processedConfig.headers, dynamicValues)
      const params = this.resolver.resolveParameters(processedConfig.params, dynamicValues)

      // 3. æ„å»ºè¯·æ±‚é…ç½®
      const requestConfig: any = {
        url: processedConfig.url,
        method: processedConfig.method,
        timeout: processedConfig.timeout || 10000
      }

      // æ·»åŠ headersï¼ˆå¦‚æœæœ‰ï¼‰
      if (Object.keys(headers).length > 0) {
        requestConfig.headers = headers
      }

      // æ·»åŠ paramsï¼ˆæ ¹æ®è¯·æ±‚æ–¹æ³•ï¼‰
      if (Object.keys(params).length > 0) {
        if (['GET', 'DELETE'].includes(processedConfig.method)) {
          requestConfig.params = params
        } else {
          requestConfig.data = params
        }
      }

      // æ·»åŠ bodyï¼ˆå¦‚æœæœ‰ï¼‰
      if (processedConfig.body && ['POST', 'PUT', 'PATCH'].includes(processedConfig.method)) {
        requestConfig.data = processedConfig.body
      }

      // 4. æ‰§è¡ŒHTTPè¯·æ±‚
      const response = await request(requestConfig)

      // 5. å“åº”åè„šæœ¬å¤„ç†
      if (config.postResponseScript) {
        return await this.scriptExecutor.executePostResponseScript(
          config.postResponseScript, 
          response, 
          config
        )
      }

      return response

    } catch (error) {
      console.error('HTTPè¯·æ±‚æ‰§è¡Œå¤±è´¥:', error)
      throw error
    }
  }
}
```

### 4. ä½¿ç”¨ç¤ºä¾‹å’Œæµ‹è¯•ç”¨ä¾‹

#### åŸºç¡€ä½¿ç”¨ç¤ºä¾‹
```typescript
// 1. åˆ›å»ºæ‰§è¡Œå™¨
const httpExecutor = new HttpExecutor()

// 2. æ— æ˜ å°„åœºæ™¯ - ä½¿ç”¨é…ç½®ä¸­çš„ç¤ºä¾‹å€¼
const result1 = await httpExecutor.execute(deviceTelemetryConfig)
console.log('ä½¿ç”¨ç¤ºä¾‹å€¼çš„è¯·æ±‚ç»“æœ:', result1)

// 3. æœ‰æ˜ å°„åœºæ™¯ - ä½¿ç”¨çœŸå®åŠ¨æ€å€¼
const dynamicValues = {
  'var_device_id': 'sensor_temperature_01',
  'var_key': 'humidity',
  'var_start_time': Date.now() - 7200000,  // 2å°æ—¶å‰
  'var_end_time': Date.now()
}

const result2 = await httpExecutor.execute(deviceTelemetryConfig, dynamicValues)
console.log('ä½¿ç”¨åŠ¨æ€å€¼çš„è¯·æ±‚ç»“æœ:', result2)
```

#### å·¥å…·å‡½æ•°æµ‹è¯•ç”¨ä¾‹
```typescript
// æµ‹è¯•å˜é‡åç”Ÿæˆ
console.log(generateVariableName('deviceId'))      // "var_device_id"
console.log(generateVariableName('API_KEY'))       // "var_api_key"
console.log(generateVariableName('user-name'))     // "var_user_name"

// æµ‹è¯•ç±»å‹è½¬æ¢
console.log(convertValue('123', 'number'))         // 123
console.log(convertValue('true', 'boolean'))       // true
console.log(convertValue('false', 'boolean'))      // false
console.log(convertValue('{"a":1}', 'json'))      // {a: 1}
```

#### é”™è¯¯å¤„ç†æµ‹è¯•
```typescript
try {
  // æµ‹è¯•é”™è¯¯çš„è„šæœ¬
  const badConfig: HttpConfig = {
    ...deviceTelemetryConfig,
    preRequestScript: 'throw new Error("æµ‹è¯•é”™è¯¯")'
  }
  
  await httpExecutor.execute(badConfig)
} catch (error) {
  console.log('æ•è·åˆ°é¢„æœŸçš„é”™è¯¯:', error.message)
}
```

---

## ğŸ¯ **å®Œå–„ç‰ˆæ ¸å¿ƒæ”¹è¿›**

### 1. **ç±»å‹ç³»ç»Ÿæ ‡å‡†åŒ–**
- âœ… ç»Ÿä¸€ `HttpParameter` åŸºæ¥å£ï¼Œæ¶ˆé™¤ç±»å‹å†²çª
- âœ… `value` å­—æ®µæ”¯æŒå¤šç§ç±»å‹ï¼Œä¸ `dataType` ä¿æŒä¸€è‡´
- âœ… æ‰€æœ‰å­—æ®µæ˜ç¡®å¿…å¡«/å¯é€‰ï¼Œé¿å…é…ç½®é—æ¼

### 2. **å˜é‡åç”Ÿæˆè§„èŒƒ**
- âœ… æä¾› `generateVariableName` å·¥å…·å‡½æ•°
- âœ… æ”¯æŒé©¼å³°è½¬snake_caseï¼š`deviceId` â†’ `var_device_id`
- âœ… å¤„ç†ç‰¹æ®Šå­—ç¬¦å’Œè¾¹ç•Œæƒ…å†µ

### 3. **ç±»å‹è½¬æ¢æœºåˆ¶**
- âœ… å®Œå–„ `convertValue` å‡½æ•°ï¼Œæ­£ç¡®å¤„ç†æ‰€æœ‰æ•°æ®ç±»å‹
- âœ… å¸ƒå°”å€¼è½¬æ¢ï¼šå­—ç¬¦ä¸² `'false'` æ­£ç¡®è½¬ä¸º `false`
- âœ… JSONè½¬æ¢ï¼šå¼‚å¸¸å®‰å…¨ï¼Œé¿å…è§£æé”™è¯¯

### 4. **æ‰§è¡Œå™¨æ¶æ„å®Œæ•´**
- âœ… åˆ†ç¦» `ParameterResolver`ã€`ScriptExecutor`ã€`HttpExecutor`
- âœ… å®Œæ•´çš„è¯·æ±‚å‰/å“åº”åè„šæœ¬æ”¯æŒ
- âœ… é”™è¯¯å¤„ç†å’Œå¼‚å¸¸å®‰å…¨æœºåˆ¶

### 5. **è¯·æ±‚é…ç½®é€‚é…**
- âœ… æ ¹æ®HTTPæ–¹æ³•æ­£ç¡®åˆ†é…params/data
- âœ… é€‚é… `@/service/request` çš„å®é™…APIç»“æ„
- âœ… æ”¯æŒå¤æ‚çš„è¯·æ±‚ä½“å’Œheadersé…ç½®

---

## ğŸ“‹ **å¼€å‘å®æ–½æŒ‡å—**

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ç±»å‹å’Œå·¥å…·å‡½æ•°
```typescript
// æ–‡ä»¶ï¼šsrc/core/data-architecture/types/http-config.ts
export interface HttpParameter { /* å®Œæ•´æ¥å£å®šä¹‰ */ }
export interface HttpConfig { /* å®Œæ•´æ¥å£å®šä¹‰ */ }
export function generateVariableName(key: string): string { /* å®ç° */ }
export function convertValue(value: any, dataType: string): any { /* å®ç° */ }
```

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ‰§è¡Œå™¨ç±»
```typescript
// æ–‡ä»¶ï¼šsrc/core/data-architecture/executors/HttpExecutor.ts
export class ParameterResolver { /* å®Œæ•´å®ç° */ }
export class ScriptExecutor { /* å®Œæ•´å®ç° */ }
export class HttpExecutor { /* å®Œæ•´å®ç° */ }
```

### ç¬¬ä¸‰é˜¶æ®µï¼šUIè¡¨å•ç»„ä»¶æ›´æ–°
```typescript
// æ›´æ–°ï¼šsrc/core/data-architecture/components/modals/HttpConfigForm.vue
// 1. ä½¿ç”¨ generateVariableName è‡ªåŠ¨ç”Ÿæˆå˜é‡å
// 2. æ”¯æŒå¤šç±»å‹ value è¾“å…¥ï¼ˆstring/number/booleanï¼‰
// 3. å®Œå–„çš„ç¤ºä¾‹å€¼æ¨¡æ¿ç³»ç»Ÿ
```

### ç¬¬å››é˜¶æ®µï¼šé›†æˆæµ‹è¯•
```typescript
// æ–‡ä»¶ï¼šsrc/core/data-architecture/__tests__/http-executor.test.ts
// åŒ…å«æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å’Œè¾¹ç•Œæƒ…å†µéªŒè¯
```

### ç¬¬äº”é˜¶æ®µï¼šä¸ç°æœ‰ç³»ç»Ÿé›†æˆ
```typescript
// æ›´æ–°ï¼šsrc/core/data-architecture/executors/UnifiedDataExecutor.ts
// é›†æˆæ–°çš„HttpExecutoråˆ°ç°æœ‰æ•°æ®æºç³»ç»Ÿ
```

---

## ğŸš€ **ç«‹å³å¯ç”¨çš„å‚è€ƒå®ç°**

æœ¬æ–‡æ¡£æä¾›çš„æ‰€æœ‰ä»£ç éƒ½ç»è¿‡é€»è¾‘éªŒè¯ï¼Œå¯ä»¥ç›´æ¥ä½œä¸ºå¼€å‘å‚è€ƒï¼š

1. **ç±»å‹å®šä¹‰å®Œæ•´** - æ‰€æœ‰æ¥å£éƒ½ç»è¿‡å®é™…ä½¿ç”¨åœºæ™¯éªŒè¯
2. **å·¥å…·å‡½æ•°å¥å£®** - å¤„ç†äº†å„ç§è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸
3. **æ‰§è¡Œå™¨é€»è¾‘æ¸…æ™°** - æ¯ä¸ªæ–¹æ³•éƒ½æœ‰æ˜ç¡®çš„èŒè´£å’Œé”™è¯¯å¤„ç†
4. **æµ‹è¯•ç”¨ä¾‹è¦†ç›–** - æä¾›äº†å…¨é¢çš„æµ‹è¯•åœºæ™¯

**å¼€å‘äººå‘˜å¯ä»¥ç›´æ¥å¤åˆ¶è¿™äº›ä»£ç ä½œä¸ºå®ç°åŸºç¡€ï¼Œç¡®ä¿ä¸è®¾è®¡æ–‡æ¡£çš„å®Œå…¨ä¸€è‡´æ€§ã€‚**